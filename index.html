<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Online CBT V2</title>
	<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/xiroro-ab/smp58dataguru/refs/heads/main/ico.png">
    <script src="tailwind.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>

/* TAMBAHKAN INI DI PALING ATAS STYLE */
.hidden {
    display: none !important;
}
        :root {
            --bg-color: #100f1c;
            --primary-color: #c026d3; /* fuchsia-600 */
            --secondary-color: #be185d; /* pink-700 */
            --warning-color: #d97706; /* amber-600 */
            --glow-color-primary: rgba(192, 38, 211, 0.75);
            --glow-color-secondary: rgba(190, 24, 93, 0.75);
            --glow-color-warning: rgba(217, 119, 6, 0.75);
            --text-glow-color: rgba(255, 255, 255, 0.5);
        }

        body {
            font-family: 'Fira Code', monospace;
            background-color: var(--bg-color);
            color: #e5e7eb; /* gray-200 */
            text-shadow: 0 0 2px var(--text-glow-color);
            font-size: 14px; 
        }

        .neon-glow-button {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 0 5px var(--glow-color-primary), 0 0 10px var(--glow-color-primary), inset 0 0 5px var(--glow-color-primary);
            transition: all 0.3s ease-in-out;
            animation: pulse-glow 2s infinite alternate;
        }

        .neon-glow-button:hover, .neon-glow-button.active {
            color: white;
            border-color: white;
            box-shadow: 0 0 10px var(--glow-color-primary), 0 0 20px var(--glow-color-primary), 0 0 40px var(--glow-color-primary), inset 0 0 10px var(--glow-color-primary);
        }

        .neon-glow-secondary {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
            box-shadow: 0 0 5px var(--glow-color-secondary), 0 0 10px var(--glow-color-secondary), inset 0 0 5px var(--glow-color-secondary);
        }
        
        .neon-glow-secondary:hover {
            color: white;
            border-color: white;
            box-shadow: 0 0 10px var(--glow-color-secondary), 0 0 20px var(--glow-color-secondary), 0 0 40px var(--glow-color-secondary), inset 0 0 10px var(--glow-color-secondary);
        }

        .neon-glow-warning {
            border-color: var(--warning-color);
            color: var(--warning-color);
            box-shadow: 0 0 5px var(--glow-color-warning), 0 0 10px var(--glow-color-warning), inset 0 0 5px var(--glow-color-warning);
        }

        .neon-glow-warning:hover {
             color: white;
            border-color: white;
            box-shadow: 0 0 10px var(--glow-color-warning), 0 0 20px var(--glow-color-warning), 0 0 40px var(--glow-color-warning), inset 0 0 10px var(--glow-color-warning);
        }

        .neon-glow-card {
            background-color: rgba(23, 22, 38, 0.8);
            box-shadow: 0 0 10px var(--glow-color-primary);
            backdrop-filter: blur(5px);
        }
        
        .neon-glow-modal {
            background-color: rgba(16, 15, 28, 0.9);
            border: 1px solid var(--primary-color);
            box-shadow: 0 0 20px var(--glow-color-primary), 0 0 40px var(--glow-color-primary);
            backdrop-filter: blur(10px);
        }

        .neon-glow-input {
            background-color: rgba(30, 28, 50, 0.5);
            border: 1px solid var(--primary-color);
            color: #f3f4f6; /* gray-100 */
        }
        
        .neon-glow-input::-webkit-calendar-picker-indicator {
            filter: invert(1) sepia(100%) saturate(10000%) hue-rotate(270deg);
        }

        .neon-glow-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 8px var(--glow-color-secondary);
        }
        
        @keyframes pulse-glow {
            from {
                box-shadow: 0 0 5px var(--glow-color-primary), 0 0 10px var(--glow-color-primary), inset 0 0 5px var(--glow-color-primary);
            }
            to {
                box-shadow: 0 0 10px var(--glow-color-primary), 0 0 20px var(--glow-color-primary), inset 0 0 10px var(--glow-color-primary);
            }
        }
        
        @keyframes zigzag-float {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(3px, -3px) rotate(-0.5deg); }
            50% { transform: translate(0, 3px) rotate(0deg); }
            75% { transform: translate(-3px, -3px) rotate(0.5deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes modal-fade-in {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .modal-content {
            animation: modal-fade-in 0.3s ease-out forwards;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
        .tab-button.active {
            border-color: var(--primary-color);
            background: linear-gradient(to top, var(--glow-color-primary), transparent);
            color: white;
        }
        /* Rich Text Editor */
        .rte-toolbar button {
            background-color: rgba(255,255,255,0.1);
            border: 1px solid var(--primary-color);
        }
        .rte-toolbar button.active {
            background-color: var(--primary-color);
            color: white;
        }
        .rte-content {
            min-height: 120px;
        }

        /* Custom Styles for new features */
        .question-nav-button {
            width: 40px;
            height: 40px;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .question-media-embed {
            max-width: 100%;
            max-height: 300px;
            border-radius: 0.5rem;
            margin: 0.5rem auto;
        }
        .option-media-embed {
            max-height: 5rem; /* 80px */
            margin-left: 0.5rem;
            border-radius: 0.25rem;
            vertical-align: middle;
        }
        
        /* Matching Question Styles */
        .matching-item {
        cursor: pointer;
        /* Default: Border tipis abu-abu transparan agar tidak terlalu mencolok */
        border: 1px solid rgba(255, 255, 255, 0.2); 
        background-color: rgba(0, 0, 0, 0.3); /* Background agak gelap */
        transition: all 0.3s ease; /* Animasi halus */
        position: relative;
        overflow: hidden;
        }

        /* Efek saat mouse diarahkan (Hover) */
        .matching-item:hover {
        border-color: #facc15; /* Kuning Terang */
        box-shadow: 0 0 10px rgba(250, 204, 21, 0.3); /* Glow redup */
        transform: translateY(-2px); /* Sedikit naik */
        }

        /* Efek saat kotak DIPILIH (Klik) - KUNING GLOW */
        .matching-item.selected {
        border-color: #facc15 !important; /* Kuning Emas (Yellow-400) */
        background-color: rgba(250, 204, 21, 0.1); /* Background kuning tipis */
        box-shadow: 
        0 0 10px #eab308, /* Glow dalam */
        0 0 20px rgba(234, 179, 8, 0.5), /* Glow luar */
        inset 0 0 10px rgba(234, 179, 8, 0.2); /* Glow di dalam kotak */
        transform: scale(1.02); /* Sedikit membesar */
        }
        #matching-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
        }
        @keyframes drift {
            0% { transform: translate(0, 0) rotate(var(--angle)); }
            100% { transform: translate(var(--end-x), var(--end-y)) rotate(var(--angle)); }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="min-h-screen flex flex-col">

    <!-- App Container -->
    <main id="app" class="w-full max-w-7xl mx-auto flex-grow flex flex-col p-4">
        <!-- Landing Page -->
        <div id="page-landing" class="w-full flex-grow flex items-center justify-center">
             <div class="max-w-lg mx-auto p-8 rounded-xl text-center">
                 <img src="https://raw.githubusercontent.com/xiroro-ab/ujian-online/refs/heads/main/logo.png" alt="App Logo" class="w-48 h-48 mx-auto mb-8" style="animation: zigzag-float 7s ease-in-out infinite;">
                 <h1 class="text-2xl md:text-3xl font-bold mb-2 bg-gradient-to-r from-fuchsia-500 to-pink-600 text-transparent bg-clip-text">Aplikasi Ujian Online V2</h1>
                 <p class="text-2xl md:text-3xl font-bold mb-2 bg-gradient-to-r from-fuchsia-500 to-pink-600 text-transparent bg-clip-text">SMPN 58 </p>
                 <p class="text-gray-400 mb-10">Selamat Datang! Silakan pilih peran Anda.</p>
                 <div class="space-y-6 flex flex-col items-center">
                     <button onclick="navigateTo('page-guru-login')" class="w-full max-w-sm neon-glow-button font-bold py-3 px-8 rounded-lg text-base flex items-center justify-center">
                         <i class="fas fa-user-tie mr-3"></i>
                         <span>Masuk sebagai Guru</span>
                     </button>
                     <button onclick="navigateTo('page-siswa-login')" class="w-full max-w-sm neon-glow-button neon-glow-secondary font-bold py-3 px-8 rounded-lg text-base flex items-center justify-center">
                         <i class="fas fa-user-graduate mr-3"></i>
                         <span>Masuk sebagai Siswa</span>
                     </button>
                 </div>
                  <button id="about-btn" class="mt-10 text-gray-400 hover:text-white transition-colors duration-300">About this App</button>
            </div>
        </div>

        <!-- Guru Login Page -->
        <div id="page-guru-login" class="hidden w-full flex-grow flex items-center justify-center">
            <div class="max-w-lg mx-auto neon-glow-card p-8 rounded-xl w-full">
                 <img src="https://raw.githubusercontent.com/xiroro-ab/ujian-online/refs/heads/main/logo.png" alt="App Logo" class="w-32 h-32 mx-auto mb-6">
                <h2 class="text-2xl font-bold text-center mb-6 bg-gradient-to-r from-fuchsia-500 to-pink-600 text-transparent bg-clip-text">Login Guru</h2>
                <form id="guru-login-form" class="space-y-6">
                    <div>
                        <label for="username" class="block mb-2 text-sm font-medium text-gray-300">Username</label>
                        <input type="text" id="username" name="username" class="w-full p-3 rounded-lg neon-glow-input" required>
                    </div>
                    <div>
                        <label for="password" class="block mb-2 text-sm font-medium text-gray-300">Password</label>
                        <input type="password" id="password" name="password" class="w-full p-3 rounded-lg neon-glow-input" required>
                    </div>
                    <div class="flex items-center justify-between space-x-4 pt-4">
                        <button type="button" onclick="navigateTo('page-landing')" class="w-full neon-glow-button neon-glow-secondary font-bold py-3 px-6 rounded-lg">Kembali</button>
                        <button type="submit" class="w-full neon-glow-button font-bold py-3 px-6 rounded-lg">Login</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Siswa Login Page -->
        <div id="page-siswa-login" class="hidden w-full flex-grow flex items-center justify-center">
           <div class="max-w-lg mx-auto neon-glow-card p-8 rounded-xl w-full">
                <img src="https://raw.githubusercontent.com/xiroro-ab/ujian-online/refs/heads/main/logo.png" alt="App Logo" class="w-32 h-32 mx-auto mb-6">
                <h2 class="text-2xl font-bold text-center mb-6 bg-gradient-to-r from-fuchsia-500 to-pink-600 text-transparent bg-clip-text">Mulai Ujian</h2>
                <form id="siswa-login-form" class="space-y-6">
                    <div>
                        <label for="kelas-select" class="block mb-2 text-sm font-medium text-gray-300">Pilih Kelas</label>
                        <select id="kelas-select" class="w-full p-3 rounded-lg neon-glow-input" required>
                            <option value="">Memuat kelas...</option>
                        </select>
                    </div>
                     <div>
                        <label for="nama-select" class="block mb-2 text-sm font-medium text-gray-300">Pilih Nama</label>
                        <select id="nama-select" class="w-full p-3 rounded-lg neon-glow-input" disabled required>
                            <option value="">Pilih kelas terlebih dahulu</option>
                        </select>
                    </div>
                    <div>
                        <label for="token" class="block mb-2 text-sm font-medium text-gray-300">Token Ujian</label>
                        <input type="text" id="token" name="token" class="w-full p-3 rounded-lg neon-glow-input" required>
                    </div>
                    <div class="flex items-center justify-between space-x-4 pt-4">
                        <button type="button" onclick="navigateTo('page-landing')" class="w-full neon-glow-button neon-glow-secondary font-bold py-3 px-6 rounded-lg">Kembali</button>
                        <button type="submit" class="w-full neon-glow-button font-bold py-3 px-6 rounded-lg">Mulai Ujian</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Siswa Exam Instruction Page -->
        <div id="page-exam-instruction" class="hidden w-full flex-grow flex items-center justify-center">
             <div class="max-w-2xl mx-auto neon-glow-card p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-fuchsia-500 to-pink-600 text-transparent bg-clip-text">Petunjuk Pengerjaan Ujian</h2>
                <div id="exam-details" class="text-left space-y-3 my-6"></div>
                <div class="text-left my-6 p-4 bg-black/30 rounded-lg">
                    <h3 class="font-bold mb-2 text-fuchsia-400">Keterangan Navigasi Soal</h3>
                    <ul class="space-y-2 text-sm">
                        <li class="flex items-center"><div class="w-5 h-5 rounded-md bg-blue-600 mr-3"></div> Soal yang sedang aktif / dikerjakan.</li>
                        <li class="flex items-center"><div class="w-5 h-5 rounded-md bg-green-600/70 mr-3"></div> Soal yang telah dijawab.</li>
                        <li class="flex items-center"><div class="w-5 h-5 rounded-md bg-yellow-500/70 mr-3"></div> Soal yang Anda tandai 'Ragu-ragu'.</li>
                        <li class="flex items-center"><div class="w-5 h-5 rounded-md bg-gray-700 mr-3"></div> Soal yang belum dikerjakan.</li>
                    </ul>
                </div>
                <p class="text-sm text-gray-400 mb-6">Jika Anda tidak sengaja menutup halaman ini, Anda dapat melanjutkan ujian dengan login kembali menggunakan token yang sama.</p>
                <button id="start-exam-btn" class="w-full neon-glow-button font-bold py-3 px-6 rounded-lg text-base">Mulai Kerjakan</button>
            </div>
        </div>

        <!-- Siswa Exam Page -->
        <div id="page-exam" class="hidden w-full flex-grow flex flex-col md:flex-row gap-4">
            <!-- Left Panel: Navigation -->
            <div class="w-full md:w-1/4 neon-glow-card rounded-lg p-4 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base font-bold">Navigasi Soal</h3>
                    <div id="timer" class="font-mono text-lg bg-red-600/50 text-white px-3 py-1 rounded-md">00:00:00</div>
                </div>
                <div id="question-nav-grid" class="flex-grow overflow-y-auto grid grid-cols-5 sm:grid-cols-6 md:grid-cols-5 gap-2 content-start">
                    <!-- Navigation buttons will be injected here -->
                </div>
            </div>
            <!-- Right Panel: Question Content -->
            <div class="w-full md:w-3/4 neon-glow-card rounded-lg p-6 flex flex-col">
                <div id="question-content" class="flex-grow overflow-y-auto pr-2">
                    <!-- Question will be injected here -->
                </div>
                <div class="mt-6 flex flex-col sm:flex-row items-center gap-2">
                    <button id="prev-question-btn" class="w-full sm:flex-1 neon-glow-button neon-glow-secondary font-bold py-2 px-6 rounded-lg">Sebelumnya</button>
                    <button id="ragu-ragu-btn" class="w-full sm:flex-1 neon-glow-button neon-glow-warning font-bold py-2 px-6 rounded-lg">Ragu-ragu</button>
                    <button id="next-question-btn" class="w-full sm:flex-1 neon-glow-button font-bold py-2 px-6 rounded-lg">Selanjutnya</button>
                    <button id="finish-exam-btn" class="hidden w-full sm:flex-1 neon-glow-button font-bold py-2 px-6 rounded-lg bg-green-500/20 border-green-500 text-green-400 hover:border-green-400 hover:text-white">Selesaikan Ujian</button>
                </div>
            </div>
        </div>
        
        <!-- Siswa Result Page -->
        <div id="page-result" class="hidden w-full flex-grow flex items-center justify-center">
            <div class="max-w-md mx-auto neon-glow-card p-8 rounded-xl text-center">
                 <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-fuchsia-500 to-pink-600 text-transparent bg-clip-text">Ujian Selesai!</h2>
                 <p class="text-base text-gray-300 mb-6">Berikut adalah hasil ujian Anda:</p>
                 <div class="bg-fuchsia-500/20 p-6 rounded-lg mb-8">
                     <p class="text-sm text-gray-400">SKOR AKHIR</p>
                     <p id="final-score" class="text-6xl font-bold text-white">100</p>
                     <p id="score-message" class="text-sm text-yellow-300 mt-2 hidden"></p>
                 </div>
                 <button onclick="clearExamStateAndLogout()" class="w-full neon-glow-button font-bold py-3 px-6 rounded-lg">Kembali ke Halaman Awal</button>
            </div>
        </div>

        <!-- Guru Dashboard Page -->
        <div id="page-guru-dashboard" class="hidden w-full flex-grow flex flex-col">
            <!-- Guru dashboard content is rendered by JS -->
        </div>

        <!-- Guru Manage Subject Page -->
         <div id="page-manage-subject" class="hidden w-full flex-grow flex flex-col">
            <!-- Manage subject content is rendered by JS -->
        </div>

    </main>

    <!-- Footer -->
    <footer id="footer" class="text-center text-gray-500 text-sm p-4">
        Copyright &copy; 2025 Aris Bermansyah, S.Kom
    </footer>

    <!-- Universal Loader -->
    <div id="loader" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100]">
        <div class="spinner w-16 h-16 rounded-full"></div>
    </div>
    
    <!-- Universal Notification -->
    <div id="notification" class="hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-black bg-opacity-60 z-[90] p-4">
        <div class="modal-content neon-glow-modal max-w-sm w-full p-6 rounded-xl text-center">
            <h3 id="notification-title" class="text-2xl font-bold mb-4">Title</h3>
            <p id="notification-message" class="text-gray-300 mb-6">Message here.</p>
            <button id="notification-close-btn" class="neon-glow-button font-bold py-2 px-8 rounded-lg">OK</button>
        </div>
    </div>
    
    <!-- Universal Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div id="modal-content-wrapper" class="modal-content neon-glow-modal max-w-2xl w-full rounded-xl">
             <div class="flex justify-between items-center p-4 border-b border-fuchsia-500/30">
                 <h3 id="modal-title" class="text-xl font-bold">Modal Title</h3>
                 <button id="modal-close-btn-x" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <form id="modal-form">
                <div id="modal-body" class="p-6 max-h-[70vh] overflow-y-auto">
                    <!-- Modal content goes here -->
                </div>
                <div id="modal-footer" class="p-4 border-t border-fuchsia-500/30 flex justify-end items-center gap-4">
                    <button type="button" id="modal-close-btn-footer" class="neon-glow-button neon-glow-secondary font-bold py-2 px-6 rounded-lg">Batal</button>
                    <button type="submit" id="modal-action-btn" class="neon-glow-button font-bold py-2 px-6 rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Anti-Cheat Warning Overlay -->
    <div id="cheat-warning" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[110] text-center p-4">
        <div class="modal-content text-white max-w-lg">
            <i class="fas fa-exclamation-triangle text-5xl text-yellow-400 mb-4 animate-pulse"></i>
            <h2 class="text-3xl font-bold mb-2">PERINGATAN!</h2>
            <p class="text-lg">Aktivitas di luar halaman ujian terdeteksi.</p>
            <p class="mt-4 text-gray-300">Harap fokus pada ujian. Pelanggaran berulang akan dicatat dan dapat mengakibatkan ujian Anda dihentikan secara otomatis.</p>
            <p class="text-yellow-400 font-bold text-2xl mt-6" id="cheat-count-display"></p>
            <p class="text-white text-lg mt-4" id="cheat-timer-display"></p>
        </div>
    </div>


    <script>
// --- CONFIGURATION ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbweCl4BK62Zj9qfKJT9UH7pFvsTn4qGSjrrv8qWqgd9A-GlzPle46VhAgOg_pdSMxXx7Q/exec";

// --- (TAMBAHKAN SEMUA KODE INI) ---
const firebaseConfig = {
  apiKey: "AIzaSyCRauTuemvkOBQG0z5yQbxTvUlRs3Hsl4Y",
  authDomain: "aplikasi-ujian-cbt-version2.firebaseapp.com",
  databaseURL: "https://aplikasi-ujian-cbt-version2-default-rtdb.firebaseio.com",
  projectId: "aplikasi-ujian-cbt-version2",
  storageBucket: "aplikasi-ujian-cbt-version2.firebasestorage.app",
  messagingSenderId: "451235049556",
  appId: "1:451235049556:web:4e396ed9864923aaa1fdc1",
  measurementId: "G-8F472C3VW7"
};

// Inisialisasi Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database(); // Pintasan untuk Realtime Database
const auth = firebase.auth(); // Pintasan untuk Autentikasi
// --- (AKHIR BAGIAN TAMBAHAN) ---


/**
 * =================================================================
 * ===== HELPER "LINK AJAIB" (INI ADALAH PERBAIKAN FINAL) =====
 * =================================================================
 * Ini adalah format link Google yang berbeda, yang dirancang
 * untuk menampilkan gambar secara langsung dan tidak diblokir.
 */
function buildDriveUrl(fileId) {
    if (!fileId) return "";
    // Format "Pintu Samping" yang baru dan lebih baik
    return `https://lh3.googleusercontent.com/d/${fileId}`;
}
// =================================================================

// FUNGSI GLOBAL UNTUK MERENDER OPSI JAWABAN (VERSI DRIVE LANGSUNG)
function renderOption(opt) {
    if (typeof opt === 'object' && opt !== null) {
        // --- PERUBAHAN DI SINI ---
        // Kita sekarang menggunakan <img> SRC secara langsung.
        const mediaHtml = opt.img
            ? `<img src="${buildDriveUrl(opt.img.trim())}" class="option-media-embed" alt="Memuat media opsi..." loading="lazy">`
            : '';
        // --- AKHIR PERUBAHAN ---

        return `
            <div class="flex items-center gap-2">
                <span>${opt.text || ''}</span>
                ${mediaHtml}
            </div>
        `;
    }
    return `<span>${opt}</span>`;
}

// --- GLOBAL STATE --- (Tetap Sama)
let isDuringExam = false;
let state = {
    currentPage: 'page-landing',
    currentUser: null,
    students: [],
    subjects: [],
    questions: [],
    tokens: [],
    results: [],
    currentExam: null, 
    examTimer: null,
    currentSubject: null, 
    classFilter: 'all',
    resultClassFilter: 'all',
    liveMonitorListener: null,
    examFocusListener: null,
    examBlurListener: null,
    matchingState: {
        selectedLeftIndex: null,
        resizeObserver: null,
    }
};

// --- UTILS --- (Tetap Sama)
const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);
const showLoader = () => $('#loader').classList.remove('hidden');
const hideLoader = () => $('#loader').classList.add('hidden');
function showNotification(title, message, type = 'info') {
    const notif = document.getElementById('notification');
    const titleEl = document.getElementById('notification-title');
    const msgEl = document.getElementById('notification-message');

    // --- PERBAIKAN: Cek apakah elemen ada ---
    if (!notif || !titleEl || !msgEl) {
        console.warn("Elemen notifikasi tidak ditemukan di HTML.");
        // Fallback ke alert bawaan browser agar pesan tetap terbaca
        alert(`${title}: ${message}`);
        return;
    }
    // ----------------------------------------

    titleEl.textContent = title;
    msgEl.textContent = message;
    
    // Reset warna
    titleEl.className = 'text-2xl font-bold mb-4'; // Reset class dasar
    
    if (type === 'success') titleEl.classList.add('text-green-400');
    else if (type === 'error') titleEl.classList.add('text-red-400');
    else titleEl.classList.add('text-blue-400');
    
    notif.classList.remove('hidden');
}
const hideNotification = () => $('#notification').classList.add('hidden');
function showModal(title, bodyHtml, onSave, modalConfig = {}) {
    $('#modal-title').textContent = title;
    $('#modal-body').innerHTML = bodyHtml;
    $('#modal-action-btn').style.display = 'block';
    $('#modal-close-btn-footer').style.display = 'block';
    $('#modal').classList.remove('hidden');
    const form = $('#modal-form');
    form.onsubmit = async (e) => {
        e.preventDefault();
        await onSave(e);
    };
    const closeBtnX = $('#modal-close-btn-x');
    const closeBtnFooter = $('#modal-close-btn-footer');
    if (modalConfig.hideCancel) {
        closeBtnX.style.display = 'none';
        closeBtnFooter.style.display = 'none';
    } else {
        closeBtnX.style.display = 'block';
        closeBtnFooter.style.display = 'block';
    }
    if (modalConfig.onCancel) {
        closeBtnFooter.onclick = modalConfig.onCancel;
        closeBtnX.onclick = modalConfig.onCancel;
    } else {
        closeBtnFooter.onclick = hideModal;
            closeBtnX.onclick = hideModal;
    }
    $('#modal-action-btn').textContent = modalConfig.actionText || 'Simpan';
    if(modalConfig.hideAction) $('#modal-action-btn').style.display = 'none';
}
const hideModal = (resetHandlers = true) => {
    $('#modal').classList.add('hidden');
    $('#modal-form').reset();
    if (resetHandlers) {
        $('#modal-close-btn-footer').onclick = hideModal;
        $('#modal-close-btn-x').onclick = hideModal;
    }
}
function navigateTo(pageId, params = null, isHistoryNav = false) {
    // Hentikan observer 'Menjodohkan' jika ada
    if (state.matchingState && state.matchingState.resizeObserver) {
        state.matchingState.resizeObserver.disconnect();
        state.matchingState.resizeObserver = null;
    }

    // Sembunyikan semua halaman
    $$('[id^="page-"]').forEach(page => page.classList.add('hidden'));
    
    // Tampilkan halaman target
    const targetPage = $(`#${pageId}`);
    if (targetPage) {
        targetPage.classList.remove('hidden');
        state.currentPage = pageId;
    } else {
        // Fallback jika halaman tidak ditemukan
        $('#page-landing').classList.remove('hidden');
        state.currentPage = 'page-landing';
        pageId = 'page-landing';
    }

    // --- (INI ADALAH LOGIKA BARU) ---
    // Jika ini BUKAN navigasi dari tombol 'Back' (isHistoryNav == false),
    // maka buat "jejak remah roti" baru di riwayat browser.
    if (!isHistoryNav) {
        const historyState = { page: pageId };
        const title = `Ujian Online - ${pageId.replace('page-', '')}`;
        const url = `#${pageId}`; // Menggunakan hash agar halaman tidak me-reload
        
        try {
            window.history.pushState(historyState, title, url);
        } catch (e) {
            console.error("Gagal pushState: ", e);
        }
    }
    // --- (AKHIR LOGIKA BARU) ---
}

// TAMBAHKAN FUNGSI BARU INI DI MANA SAJA DALAM SCRIPT ANDA
/**
 * Menangani penekanan tombol 'Back' atau 'Forward' di browser/HP.
 */
function handleHistoryNavigation(event) {
    
    // 1. Cek "tanda" global. Apakah kita SEDANG dalam ujian?
    if (isDuringExam) {
        
        // 2. Panggil "mesin" pelanggaran (ini akan menambah jumlah cheatAttempts)
        handleViolation(); 

        // 3. Cek apakah ujian sudah dihentikan oleh handleViolation
        if (state.currentExam && !state.currentExam.isFinished) {
            try {
                // --- INI ADALAH SOLUSI BARU YANG PALING KUAT ---
                // Kita ubah URL-nya SETIAP SAAT dengan "dummy hash".
                
                const violationCount = state.currentExam.cheatAttempts || 1;
                
                // Buat data state unik (objek)
                const uniqueState = { page: 'page-exam', v: violationCount };
                
                // Buat URL unik (string)
                const uniqueUrlHash = `#page-exam?v=${violationCount}`; // <-- Kuncinya di sini

                // Dorong ke history dengan URL yang SELALU BARU
                window.history.pushState(uniqueState, '', uniqueUrlHash);

            } catch (e) { 
                console.error("Gagal pushState: ", e);
            }
        }

    } else {
        // Logika navigasi 'Back' biasa (saat tidak sedang ujian)
        const pageId = (event.state && event.state.page) ? event.state.page : 'page-landing';
        if (pageId === 'page-exam') {
            // Jika entah bagaimana kembali ke halaman ujian setelah selesai,
            // lempar ke landing.
            navigateTo('page-landing', null, true);
        } else {
            // Navigasi back normal
            navigateTo(pageId, null, true); 
        }
    }
}

// GANTI SELURUH FUNGSI 'apiCall' LAMA ANDA DENGAN INI
async function apiCall(action, payload = {}) {
    if (!SCRIPT_URL.startsWith('https')) {
        showNotification('Error Konfigurasi', 'URL Google Apps Script belum diatur.', 'error');
        return { success: false, message: 'URL Script tidak valid' };
    }
    showLoader();

    // --- LOGIKA TIMEOUT BARU (15 DETIK) ---
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
        controller.abort();
    }, 100000); // 

    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            cache: 'no-cache',
            credentials: 'omit',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action, payload }),
            redirect: 'follow',
            signal: controller.signal // <-- Terapkan timeout
        });

        clearTimeout(timeoutId); // Batalkan timeout jika berhasil

        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            const result = await response.json();
            if (!result.success) {
                showNotification('Error dari Server', result.message || 'Terjadi kesalahan.', 'error');
            }
            return result;
        } else {
            const textResponse = await response.text();
            console.error("Server tidak mengembalikan JSON. Respons:", textResponse);
            throw new Error('Server tidak memberikan balasan data yang valid (menerima HTML). Pastikan skrip sudah di-deploy dengan benar menggunakan "versi baru".');
        }
    } catch (error) {
        clearTimeout(timeoutId); // Batalkan timeout jika error

        console.error('API Call Error:', error);
        let errorMessage = error.message;

        if (error.name === 'AbortError') {
            // --- INI ADALAH PESAN TIMEOUT KITA ---
            errorMessage = 'Koneksi ke server terlalu lama (Timeout). Periksa koneksi internet Anda dan coba lagi.';
        } else if (error.message.includes('Failed to fetch')) {
            errorMessage = 'Gagal terhubung ke server. Periksa koneksi internet Anda atau server mungkin sedang sibuk.';
        }

        showNotification('Error Jaringan', errorMessage, 'error');
        return { success: false, message: errorMessage };
    } finally {
        hideLoader();
    }
}

// --- EVENT LISTENERS & PAGE LOGIC ---
document.addEventListener('DOMContentLoaded', () => {
    navigateTo('page-landing');
    $('#guru-login-form').addEventListener('submit', handleGuruLogin);
    $('#siswa-login-form').addEventListener('submit', handleSiswaLogin);
    $('#notification-close-btn').addEventListener('click', hideNotification);
    $('#about-btn').addEventListener('click', showAboutModal);
    $('#kelas-select').addEventListener('change', populateNamaSelect);
    $('#modal-close-btn-x').addEventListener('click', hideModal);
    $('#modal-close-btn-footer').addEventListener('click', hideModal);
    window.onpopstate = handleHistoryNavigation; // Mengaktifkan pendengar tombol 'Back'
});

// GANTI FUNGSI LAMA 'showResumeConfirmationModal' ANDA DENGAN YANG BARU INI
function showResumeConfirmationModal(storageKey, studentId, token) {
    const modalContainer = $('#notification');
    const modalContent = modalContainer.querySelector('.modal-content');
    modalContent.innerHTML = `
        <h3 id="notification-title" class="text-2xl font-bold mb-4 text-blue-400">Progres Ditemukan</h3>
        <p id="notification-message" class="text-gray-300 mb-6">Kami menemukan progres ujian yang belum selesai. Lanjutkan sesi sebelumnya atau mulai dari awal?</p>
        <div class="flex gap-4">
            <button id="resume-no-btn" class="w-full neon-glow-button neon-glow-secondary font-bold py-2 px-6 rounded-lg">Ujian Ulang</button>
            <button id="resume-yes-btn" class="w-full neon-glow-button font-bold py-2 px-6 rounded-lg">Ya, Lanjutkan</button>
        </div>
    `;
    
    const closeModal = () => {
        modalContainer.classList.add('hidden');
        modalContent.innerHTML = ''; 
    };
    
    // --- Tombol "YA" (Lanjutkan) - LOGIKA TETAP SAMA ---
    $('#resume-yes-btn').onclick = async () => {
        closeModal();
        if (state.students.length === 0) {
            showLoader();
            const res = await apiCall('getStudents');
            if (res.success && res.data) state.students = res.data;
            else { hideLoader(); return; }
            hideLoader();
        }
        const savedState = localStorage.getItem(storageKey);
        let examData = JSON.parse(savedState);

        // Fix backward compatibility v1 to v2
        if (examData.questions && !examData.questionIDs) {
            examData.questionIDs = examData.questions.map(q => q.id);
            examData.loadedQuestions = {};
            examData.questions.forEach(q => { delete q.answer; examData.loadedQuestions[q.id] = q; });
            delete examData.questions;
        }
        
        state.currentExam = examData;
        startExam(true).catch(e => console.error(e));
    };
    
    // --- Tombol "TIDAK" (Ujian Ulang) - SUDAH DIPERBAIKI (ANTI-CHEAT) ---
    $('#resume-no-btn').onclick = async () => {
        closeModal();
        localStorage.removeItem(storageKey); // Hapus data di HP (reset jawaban)
        
        showLoader();
        try {
            // 1. Ambil Info Token & Mapel
            const tokenSnapshot = await db.ref('/tokens/' + token).once('value');
            const tokenInfo = tokenSnapshot.val();
            if (!tokenInfo) throw new Error("Token tidak valid lagi.");
            const subjectId = tokenInfo.subjectId;

            const subjectSnapshot = await db.ref('/subjects/' + subjectId).once('value');
            const subject = subjectSnapshot.val();
            if (!subject) throw new Error("Data mata pelajaran tidak ditemukan.");

            // 2. Ambil Soal Lengkap (Wajib ambil full data agar tidak error)
            const questionsSnap = await db.ref('/questions_public')
                                          .orderByChild('subjectId')
                                          .equalTo(subjectId)
                                          .once('value');
            const questionsData = questionsSnap.val();
            if (!questionsData) throw new Error("Soal belum tersedia.");

            // --- [LOGIKA ANTI-CHEAT BARU] ---
            // Cek ke Server: Apakah siswa ini punya dosa (pelanggaran) sebelumnya?
            let existingCheats = 0;
            const sessionSnap = await db.ref(`/examSessions/${studentId}_${subjectId}`).once('value');
            if (sessionSnap.exists()) {
                // Jika ada sesi di server, AMBIL jumlah pelanggarannya
                existingCheats = sessionSnap.val().cheatAttempts || 0;
            }
            // -------------------------------

            // 3. Acak Soal (Sama seperti login awal)
            const typeOrder = ["Pilihan Ganda", "Pilihan Ganda Kompleks", "Menjodohkan", "Benar/Salah", "Isian Singkat", "Esai"];
            const groupedQuestions = {};
            typeOrder.forEach(type => groupedQuestions[type] = []);
            groupedQuestions["Lainnya"] = []; 

            Object.values(questionsData).forEach(q => {
                if (typeOrder.includes(q.type)) groupedQuestions[q.type].push(q);
                else groupedQuestions["Lainnya"].push(q);
            });

            let finalSortedQuestions = [];
            typeOrder.forEach(type => {
                const group = groupedQuestions[type];
                if (group.length > 0) finalSortedQuestions = finalSortedQuestions.concat(shuffleArray([...group]));
            });
            if (groupedQuestions["Lainnya"].length > 0) {
                finalSortedQuestions = finalSortedQuestions.concat(shuffleArray(groupedQuestions["Lainnya"]));
            }

            const questionIDs = finalSortedQuestions.map(q => q.id);
            const loadedQuestions = {};
            finalSortedQuestions.forEach(q => { loadedQuestions[q.id] = q; });

            // 4. Siapkan Data Ujian Baru
            const examData = { 
                subject: subject, 
                subjectId: subjectId,
                questionIDs: questionIDs,
                loadedQuestions: loadedQuestions,
                studentId: studentId,
                token: token,
                startTime: new Date().toISOString(),
                // JANGAN DI-RESET KE 0. Gunakan data dari server.
                cheatAttempts: existingCheats 
            };
            
            // 5. Mulai Ujian
            startNewExam(examData, studentId, token);

        } catch (error) {
            console.error("Gagal memulai ujian ulang:", error);
            showNotification('Gagal Memulai', error.message, 'error');
        } finally {
            hideLoader();
        }
    };
    
    modalContainer.classList.remove('hidden');
}

function showAboutModal() {
        const bodyHtml = `
            <div class="text-center">
                <img src="https://raw.githubusercontent.com/xiroro-ab/bab3-sk-kelas8v2-aris/refs/heads/main/1752495560972.jpg" alt="Author" class="w-32 h-32 rounded-full mx-auto mb-4 border-2 border-fuchsia-500 shadow-lg">
                <p class="text-gray-300 text-left mb-4">Aplikasi ini dibuat untuk memudahkan guru dan siswa dalam melihat dan mengerjakan soal pada ujian berbasis online. Aplikasi ini masih dalam tahap perkembangan.</p>
                <p class="text-gray-300 text-left mb-4">Aplikasi ini dibuat dengan bantuan AI dan atas dasar tersebut saya hanya menambahkan atau merubah hal yang menurut saya tidak sesuai, atau masih banyak error.</p>
                <p class="text-gray-300 text-left mb-6">Terima kasih telah menggunakan aplikasi ini.</p>
                <p class="font-semibold">Tertanda,</p>
                <p class="bg-gradient-to-r from-fuchsia-500 to-pink-600 text-transparent bg-clip-text font-bold text-base">Aris Bermansyah, S.Kom</p>
            </div>
        `;
    const form = $('#modal-form');
    form.onsubmit = e => { e.preventDefault(); hideModal(); };
    showModal('Tentang Aplikasi Ini', bodyHtml, () => hideModal(), { actionText: 'Tutup', hideCancel: true });
}
// HAPUS FUNGSI LAMA 'handleGuruLogin'
// DAN GANTI DENGAN YANG INI

async function handleGuruLogin(e) {
    e.preventDefault();
    const username = $('#username').value; // Ini sekarang harus berupa Email
    const password = $('#password').value;
    
    // Kita tidak lagi memanggil apiCall('login')
    // Kita memanggil 'auth' Firebase secara langsung
    showLoader();
    try {
        // 'username' HARUS berupa email yang Anda daftarkan di Langkah A
        // Contoh: 'guru@smp58.com'
        const userCredential = await auth.signInWithEmailAndPassword(username, password);
        
        // Jika berhasil...
        state.currentUser = { 
          email: userCredential.user.email, 
          uid: userCredential.user.uid 
        };
        
        renderGuruDashboard();
        navigateTo('page-guru-dashboard');

    } catch (error) {
        // Tangani error login
        console.error("Login Gagal:", error);
        let message = 'Username atau password salah.';
        if (error.code === 'auth/user-not-found') {
            message = 'Email guru tidak terdaftar.';
        } else if (error.code === 'auth/invalid-email') {
            message = 'Format email tidak valid. Harap masukkan email guru.';
        }
        showNotification('Login Gagal', message, 'error');
    } finally {
        hideLoader();
    }
}

// --- GANTI DENGAN KODE BARU INI ---
async function renderGuruDashboard() {
    const container = $('#page-guru-dashboard');
    container.innerHTML = `
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
            <h1 class="text-2xl font-bold">Dashboard Guru</h1>
            <button onclick="logout()" class="neon-glow-button neon-glow-secondary font-bold py-2 px-5 rounded-lg">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6" id="dashboard-stats">
            <div class="neon-glow-card p-4 rounded-lg flex items-center gap-4">
                <i class="fas fa-users text-3xl text-fuchsia-400"></i>
                <div>
                    <p class="text-sm text-gray-400">Total Siswa</p>
                    <p id="stat-total-siswa" class="text-2xl font-bold">0</p>
                </div>
            </div>
            <div class="neon-glow-card p-4 rounded-lg flex items-center gap-4">
                <i class="fas fa-school text-3xl text-fuchsia-400"></i>
                <div>
                    <p class="text-sm text-gray-400">Total Kelas</p>
                    <p id="stat-total-kelas" class="text-2xl font-bold">0</p>
                </div>
            </div>
            <div class="neon-glow-card p-4 rounded-lg flex items-center gap-4">
                <i class="fas fa-book text-3xl text-fuchsia-400"></i>
                <div>
                    <p class="text-sm text-gray-400">Total Mapel</p>
                    <p id="stat-total-mapel" class="text-2xl font-bold">0</p>
                </div>
            </div>
        </div>
        <div class="flex border-b border-fuchsia-500/30 mb-4 overflow-x-auto">
            <button id="tab-btn-students" class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent transition-colors duration-300 whitespace-nowrap">Manajemen Siswa</button>
            <button id="tab-btn-subjects" class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent transition-colors duration-300 whitespace-nowrap">Manajemen Mapel</button>
        </div>
        <div id="dashboard-content" class="neon-glow-card p-4 rounded-lg"></div>
    `;
    
    // -- INI ADALAH LOGIKA BARU --
    // Kita muat SEMUA data dashboard sekali saja di sini.
    showLoader();
    try {
        const studentSnapshot = await db.ref('/students').once('value');
        const subjectSnapshot = await db.ref('/subjects').once('value');

        const studentData = studentSnapshot.val();
        const subjectData = subjectSnapshot.val();

        // Ubah data dari Object (Firebase) menjadi Array (yang dibutuhkan tabel Anda)
        state.students = studentData ? Object.values(studentData) : [];
        state.subjects = subjectData ? Object.values(subjectData) : [];

    } catch (error) {
        console.error("Gagal memuat data dashboard:", error);
        showNotification('Error Data', 'Gagal memuat data siswa/mapel dari Firebase.', 'error');
        state.students = [];
        state.subjects = [];
    } finally {
        hideLoader();
    }
    // -- AKHIR LOGIKA BARU --

    $('#tab-btn-students').addEventListener('click', () => switchDashboardTab('students'));
    $('#tab-btn-subjects').addEventListener('click', () => switchDashboardTab('subjects'));
    
    // Data sekarang sudah ada di 'state', kita bisa render statistik & tab pertama
    renderDashboardStats(); // Ini sekarang akan menampilkan angka yang benar
    switchDashboardTab('students'); // Tampilkan tab siswa
}

function renderDashboardStats() {
    const totalSiswa = state.students.length;
    const totalKelas = [...new Set(state.students.map(s => s.class.toString().trim()))].length;
    const totalMapel = state.subjects.length;
    const statSiswaEl = $('#stat-total-siswa');
    const statKelasEl = $('#stat-total-kelas');
    const statMapelEl = $('#stat-total-mapel');
    if (statSiswaEl) statSiswaEl.textContent = totalSiswa;
    if (statKelasEl) statKelasEl.textContent = totalKelas;
    if (statMapelEl) statMapelEl.textContent = totalMapel;
}
function logout() {
    auth.signOut();
    state = { 
        currentPage: 'page-landing', 
        currentUser: null, students: [], subjects: [], questions: [], 
        tokens: [], results: [], currentExam: null, examTimer: null, 
        currentSubject: null, classFilter: 'all', resultClassFilter: 'all',
        matchingState: { selectedLeftIndex: null, resizeObserver: null }
    }; 
    navigateTo('page-landing');
    location.reload();
}

// --- GANTI DENGAN KODE BARU INI ---
function switchDashboardTab(tabName) {
    $$('#page-guru-dashboard .tab-button').forEach(btn => btn.classList.remove('active'));
    $(`#tab-btn-${tabName}`).classList.add('active');
    
    // Data sudah dimuat oleh renderGuruDashboard.
    // Kita hanya perlu menampilkannya.
    if (tabName === 'students') {
        renderStudentsTab();
    } else if (tabName === 'subjects') {
        renderSubjectsTab();
    }
    
    // renderDashboardStats() sudah dipanggil saat dashboard dimuat,
    // tidak perlu dipanggil setiap kali ganti tab.
}

function renderStudentsTab() {
    const classes = ['all', ...new Set(state.students.map(s => s.class.toString().trim()))].sort();
    const filteredStudents = state.classFilter === 'all'
        ? state.students
        : state.students.filter(s => s.class.toString().trim() === state.classFilter);
    $('#dashboard-content').innerHTML = `
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
            <div>
                <label for="student-class-filter" class="mr-2">Filter Kelas:</label>
                <select id="student-class-filter" class="neon-glow-input rounded-md px-2 py-1">
                    ${classes.map(c => `<option value="${c}" ${state.classFilter === c ? 'selected' : ''}>${c === 'all' ? 'Semua Kelas' : c}</option>`).join('')}
                </select>
            </div>
            <button onclick="handleAddStudent()" class="neon-glow-button font-bold py-2 px-4 rounded-lg self-end sm:self-center"><i class="fas fa-plus mr-2"></i>Tambah Siswa</button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead><tr class="border-b border-fuchsia-500/50"><th class="p-3">ID</th><th class="p-3">Nama</th><th class="p-3">Kelas</th><th class="p-3"></th></tr></thead>
                <tbody>
                ${filteredStudents.map(student => `
                    <tr class="border-b border-fuchsia-500/20 hover:bg-fuchsia-500/10">
                        <td class="p-3 text-xs">${student.id}</td>
                        <td class="p-3 whitespace-nowrap">${student.name}</td>
                        <td class="p-3">${student.class}</td>
                        <td class="p-3 text-right">
                            <button onclick="handleEditStudent('${student.id}')" class="text-blue-400 hover:text-blue-300 mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="handleDeleteStudent('${student.id}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('') || `<tr><td colspan="4" class="p-4 text-center">Belum ada data siswa.</td></tr>`}
                </tbody>
            </table>
        </div>
    `;
    $('#student-class-filter').addEventListener('change', (e) => {
        state.classFilter = e.target.value;
        renderStudentsTab();
    });
}
// GANTI 'handleAddStudent'
async function handleAddStudent() {
    const bodyHtml = `
        <div class="space-y-4">
            <div><label class="block mb-2 text-sm">Nama Lengkap Siswa</label><input type="text" id="studentName" class="w-full p-2 rounded-lg neon-glow-input" required></div>
            <div><label class="block mb-2 text-sm">Kelas</label><input type="text" id="studentClass" class="w-full p-2 rounded-lg neon-glow-input" placeholder="Contoh: 7A" required></div>
        </div>`;
    
    showModal('Tambah Siswa Baru', bodyHtml, async () => {
        const newStudentId = generateUniqueId(); // Kita panggil helper dari frontend
        const newStudent = { 
            id: newStudentId,
            name: $('#studentName').value, 
            class: $('#studentClass').value 
        };
        
        showLoader();
        try {
            // 1. Simpan langsung ke Firebase
            await db.ref(`/students/${newStudentId}`).set(newStudent);
            hideLoader();
            hideModal();
            
            // 2. Update 'state' lokal secara manual
            state.students.push(newStudent);
            
            // 3. Render ulang UI dari 'state' yang baru
            renderStudentsTab();
            renderDashboardStats(); // Update statistik
            showNotification('Sukses', 'Siswa berhasil ditambahkan.', 'success');
        } catch (error) {
            hideLoader();
            showNotification('Error', `Gagal menyimpan: ${error.message}`, 'error');
        }
    });
}

// GANTI 'handleEditStudent'
async function handleEditStudent(studentId) {
    const student = state.students.find(s => s.id === studentId);
    if (!student) return;
    const bodyHtml = `
        <div class="space-y-4">
            <input type="hidden" id="studentId" value="${student.id}">
            <div><label class="block mb-2 text-sm">Nama</label><input type="text" id="studentName" class="w-full p-2 rounded-lg neon-glow-input" value="${student.name}" required></div>
            <div><label class="block mb-2 text-sm">Kelas</label><input type="text" id="studentClass" class="w-full p-2 rounded-lg neon-glow-input" value="${student.class}" required></div>
        </div>`;
    
    showModal(`Edit: ${student.name}`, bodyHtml, async () => {
        const updatedStudent = { 
            id: $('#studentId').value, 
            name: $('#studentName').value, 
            class: $('#studentClass').value 
        };
        
        showLoader();
        try {
            // 1. Update langsung ke Firebase
            await db.ref(`/students/${studentId}`).set(updatedStudent);
            hideLoader();
            hideModal();

            // 2. Update 'state' lokal
            const index = state.students.findIndex(s => s.id === studentId);
            if (index !== -1) {
                state.students[index] = updatedStudent;
            }
            
            // 3. Render ulang UI
            renderStudentsTab();
            renderDashboardStats();
            showNotification('Sukses', 'Data siswa berhasil diperbarui.', 'success');
        } catch (error) {
            hideLoader();
            showNotification('Error', `Gagal update: ${error.message}`, 'error');
        }
    });
}

// GANTI 'handleDeleteStudent'
async function handleDeleteStudent(studentId) {
    const student = state.students.find(s => s.id === studentId);
    if (!student) return;
    
    showModal('Konfirmasi Hapus Siswa', `<p>Anda yakin ingin menghapus <strong>${student.name}</strong>?</p>`, async () => {
        showLoader();
        try {
            // 1. Hapus langsung dari Firebase
            await db.ref(`/students/${studentId}`).remove();
            hideLoader();
            hideModal();

            // 2. Update 'state' lokal
            state.students = state.students.filter(s => s.id !== studentId);
            
            // 3. Render ulang UI
            renderStudentsTab();
            renderDashboardStats();
            showNotification('Sukses', 'Siswa berhasil dihapus.', 'success');
        } catch (error) {
            hideLoader();
            showNotification('Error', `Gagal hapus: ${error.message}`, 'error');
        }
    }, { actionText: 'Hapus' });
}
function renderSubjectsTab() {
    $('#dashboard-content').innerHTML = `
        <div class="flex justify-end items-center mb-4">
            <button onclick="handleAddSubject()" class="neon-glow-button font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i>Tambah Mapel</button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                    <tr class="border-b border-fuchsia-500/50">
                        <th class="p-3">ID</th><th class="p-3">Nama Mapel</th><th class="p-3">Durasi</th><th class="p-3">Jadwal</th><th class="p-3"></th>
                    </tr>
                </thead>
                <tbody>
                ${state.subjects.map(subject => `
                    <tr class="border-b border-fuchsia-500/20 hover:bg-fuchsia-500/10">
                        <td class="p-3 font-mono text-xs">${subject.id}</td>
                        <td class="p-3">${subject.name}</td>
                        <td class="p-3">${subject.duration} menit</td>
                        <td class="p-3">${subject.schedule ? new Date(subject.schedule).toLocaleString('id-ID') : '-'}</td>
                        <td class="p-3 text-right whitespace-nowrap">
                            <button onclick="navigateToManageSubject('${subject.id}')" class="neon-glow-button text-sm py-1 px-3 rounded-md mr-2"><i class="fas fa-cog mr-1"></i>Kelola</button>
                            <button onclick="handleEditSubject('${subject.id}')" class="text-blue-400 hover:text-blue-300 mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="handleDeleteSubject('${subject.id}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('') || `<tr><td colspan="5" class="p-4 text-center">Belum ada mata pelajaran.</td></tr>`}
                </tbody>
            </table>
        </div>
    `;
}
// GANTI 'handleAddSubject'
async function handleAddSubject() {
    const bodyHtml = `
        <div class="space-y-4">
            <div><label class="block mb-2 text-sm">ID Mata Pelajaran</label><input type="text" id="subjectId" class="w-full p-2 rounded-lg neon-glow-input" placeholder="Contoh: MTK-7" required></div>
            <div><label class="block mb-2 text-sm">Nama Mata Pelajaran</label><input type="text" id="subjectName" class="w-full p-2 rounded-lg neon-glow-input" required></div>
            <div class="grid grid-cols-2 gap-4">
                    <div><label class="block mb-2 text-sm">Durasi (menit)</label><input type="number" id="subjectDuration" class="w-full p-2 rounded-lg neon-glow-input" required></div>
                    <div><label class="block mb-2 text-sm">Batas Pelanggaran</label><input type="number" id="violationLimit" class="w-full p-2 rounded-lg neon-glow-input" value="3" min="0"></div>
            </div>
            <div><label class="block mb-2 text-sm">Jadwal</label><input type="datetime-local" id="subjectSchedule" class="w-full p-2 rounded-lg neon-glow-input" required></div>
        </div>
        <h4 class="font-bold mt-6 mb-2 text-fuchsia-400">Pengaturan Poin Soal (Bobot Nilai)</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-black/20 rounded-lg">
            ${renderScoringInputs()}
        </div>
    `;
    
    showModal('Tambah Mata Pelajaran Baru', bodyHtml, async () => {
        const subjectId = $('#subjectId').value.trim();
        if (!subjectId) {
            showNotification('Error', 'ID Mata Pelajaran tidak boleh kosong.', 'error');
            return;
        }

        const scoringRules = getScoringRulesFromModal();
        const newSubject = { 
            id: subjectId, 
            name: $('#subjectName').value, 
            duration: $('#subjectDuration').value, 
            schedule: new Date($('#subjectSchedule').value).toISOString(), // Simpan sebagai ISO string
            scoringRules: JSON.stringify(scoringRules),
            violationLimit: $('#violationLimit').value,
        };

        showLoader();
        try {
            // Cek dulu apakah ID sudah ada
            const snapshot = await db.ref(`/subjects/${subjectId}`).once('value');
            if (snapshot.exists()) {
                hideLoader();
                showNotification('Error', `ID Mapel "${subjectId}" sudah digunakan.`, 'error');
                return;
            }

            // 1. Simpan ke Firebase
            await db.ref(`/subjects/${subjectId}`).set(newSubject);
            hideLoader();
            hideModal();
            
            // 2. Update 'state' lokal
            state.subjects.push(newSubject);
            
            // 3. Render ulang UI
            renderSubjectsTab();
            renderDashboardStats();
            showNotification('Sukses', 'Mata pelajaran berhasil ditambahkan.', 'success');
        } catch (error) {
            hideLoader();
            showNotification('Error', `Gagal menyimpan: ${error.message}`, 'error');
        }
    });
}

// GANTI 'handleEditSubject'
async function handleEditSubject(subjectId) {
    const subject = state.subjects.find(s => s.id === subjectId);
    if (!subject) return;
    
    // Format tanggal ISO ke format <input datetime-local>
    const scheduleForInput = subject.schedule ? new Date(subject.schedule).toISOString().slice(0, 16) : '';
    const currentRules = subject.scoringRules ? JSON.parse(subject.scoringRules) : {};

    const bodyHtml = `
        <div class="space-y-4">
            <input type="hidden" id="subjectId" value="${subject.id}">
            <div><label class="block text-sm mb-2">Nama</label><input type="text" id="subjectName" class="w-full p-2 rounded-lg neon-glow-input" value="${subject.name}" required></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm mb-2">Durasi (menit)</label><input type="number" id="subjectDuration" class="w-full p-2 rounded-lg neon-glow-input" value="${subject.duration}" required></div>
                <div><label class="block text-sm mb-2">Batas Pelanggaran</label><input type="number" id="violationLimit" class="w-full p-2 rounded-lg neon-glow-input" value="${subject.violationLimit || 3}" min="0"></div>
            </div>
            <div><label class="block text-sm mb-2">Jadwal</label><input type="datetime-local" id="subjectSchedule" class="w-full p-2 rounded-lg neon-glow-input" value="${scheduleForInput}" required></div>
        </div>
        <h4 class="font-bold mt-6 mb-2 text-fuchsia-400">Pengaturan Poin Soal (Bobot Nilai)</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-black/20 rounded-lg">
            ${renderScoringInputs(currentRules)}
        </div>
    `;

    showModal(`Edit: ${subject.name}`, bodyHtml, async () => {
        const scoringRules = getScoringRulesFromModal();
        const updatedSubject = { 
            id: $('#subjectId').value, 
            name: $('#subjectName').value, 
            duration: $('#subjectDuration').value, 
            schedule: new Date($('#subjectSchedule').value).toISOString(), 
            scoringRules: JSON.stringify(scoringRules),
            violationLimit: $('#violationLimit').value,
        };
        
        showLoader();
        try {
            // 1. Update ke Firebase
            await db.ref(`/subjects/${subjectId}`).set(updatedSubject);
            hideLoader();
            hideModal();

            // 2. Update 'state' lokal
            const index = state.subjects.findIndex(s => s.id === subjectId);
            if (index !== -1) {
                state.subjects[index] = updatedSubject;
            }
            
            // 3. Render ulang UI
            renderSubjectsTab();
            renderDashboardStats();
            showNotification('Sukses', 'Mata pelajaran berhasil diperbarui.', 'success');
        } catch (error) {
            hideLoader();
            showNotification('Error', `Gagal update: ${error.message}`, 'error');
        }
    });
}

// GANTI FUNGSI INI DI FILE HTML
async function handleDeleteSubject(subjectId) {
    const subject = state.subjects.find(s => s.id === subjectId);
    if (!subject) return;
    
    showModal('Konfirmasi Hapus', `<p>Yakin ingin menghapus mapel <strong>${subject.name}</strong>?<br><br><span class="text-red-400 text-xs">Peringatan: Tindakan ini akan menghapus Mapel, Kunci Jawaban, dan Daftar Soal secara permanen dari database.</span></p>`, async () => {
        showLoader();
        try {
            // KITA PANGGIL BACKEND (Code.gs) UNTUK MENGHAPUS DENGAN BERSIH
            const res = await apiCall('deleteSubject', { id: subjectId });
            
            if (res.success) {
                hideLoader();
                hideModal();

                // Update tampilan biar mapelnya hilang dari tabel
                state.subjects = state.subjects.filter(s => s.id !== subjectId);
                
                renderSubjectsTab();
                renderDashboardStats();
                showNotification('Sukses', res.message, 'success');
            } else {
                throw new Error(res.message);
            }
        } catch (error) {
            hideLoader();
            showNotification('Error', `Gagal menghapus: ${error.message}`, 'error');
        }
    }, { actionText: 'Hapus Permanen' });
}
function renderScoringInputs(rules = {}) {
    const questionTypes = ["Pilihan Ganda", "Pilihan Ganda Kompleks", "Benar/Salah", "Isian Singkat", "Menjodohkan", "Esai"];
    return questionTypes.map(type => `
        <div>
            <label class="block mb-1 text-sm text-gray-300">${type}</label>
            <input type="number" id="points-${type.replace(/[\s/]+/g, '-')}" class="w-full p-2 rounded neon-glow-input" value="${rules[type] || 1}" min="0" step="0.5">
        </div>
    `).join('');
}
function getScoringRulesFromModal() {
    const questionTypes = ["Pilihan Ganda", "Pilihan Ganda Kompleks", "Benar/Salah", "Isian Singkat", "Menjodohkan", "Esai"];
    const rules = {};
    questionTypes.forEach(type => {
        const inputId = `points-${type.replace(/[\s/]+/g, '-')}`;
        rules[type] = parseFloat($(`#${inputId}`).value) || 1;
    });
    return rules;
}
function navigateToManageSubject(subjectId) {
    state.currentSubject = state.subjects.find(s => s.id === subjectId);
    if(state.currentSubject) {
        renderManageSubjectPage();
        navigateTo('page-manage-subject');
    }
}
function renderManageSubjectPage() {
    const { name, id } = state.currentSubject;
    $('#page-manage-subject').innerHTML = `
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div>
                    <button onclick="navigateTo('page-guru-dashboard'); renderGuruDashboard();" class="neon-glow-button neon-glow-secondary font-bold py-2 px-5 rounded-lg mb-2">
                        <i class="fas fa-arrow-left mr-2"></i>Kembali
                    </button>
                    <h1 class="text-2xl font-bold">Kelola: ${name}</h1>
                    <p class="text-sm text-gray-400">ID Mapel: ${id}</p>
                </div>
        </div>
        <div class="flex border-b border-fuchsia-500/30 mb-4 overflow-x-auto">
            <button id="subject-tab-questions" class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent transition-colors duration-300 whitespace-nowrap">Manajemen Soal</button>
            <button id="subject-tab-tokens" class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent transition-colors duration-300 whitespace-nowrap">Manajemen Token</button>
            <button id="subject-tab-results" class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent transition-colors duration-300 whitespace-nowrap">Hasil Ujian</button>
            
            <button id="subject-tab-monitoring" class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent transition-colors duration-300 whitespace-nowrap text-yellow-300">
                <i class="fas fa-satellite-dish animate-pulse"></i> Live Monitoring
            </button>
            <button id="subject-tab-grading" class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent transition-colors duration-300 whitespace-nowrap">Koreksi Esai</button>
            <button id="subject-tab-print" class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent transition-colors duration-300 whitespace-nowrap">Cetak Nilai</button>
        </div>
        <div id="subject-content" class="neon-glow-card p-4 rounded-lg min-h-[300px]"></div>
    `;
    $$('#page-manage-subject .tab-button').forEach(btn => {
        btn.addEventListener('click', (e) => switchSubjectTab(e.target.id.split('-')[2]));
    });
    switchSubjectTab('questions');
}

// GANTI FUNGSI LAMA 'switchSubjectTab' ANDA DENGAN YANG BARU INI
// (PERBAIKAN: Menambahkan pengecekan 'Invalid Date' pada timestamp)
async function switchSubjectTab(tabName) {
    // --- LOGIKA BARU ---
    // Hentikan listener monitoring live APAPUN tab-nya
    if (state.liveMonitorListener) {
        state.liveMonitorListener.off(); // Matikan listener
        state.liveMonitorListener = null;
    }
    // --- AKHIR LOGIKA BARU ---
    $$('#page-manage-subject .tab-button').forEach(btn => btn.classList.remove('active'));
    $(`#subject-tab-${tabName}`).classList.add('active');
    $('#subject-content').innerHTML = '<p>Memuat data...</p>';
    
    const subjectId = state.currentSubject.id;

    try {
        switch(tabName) {
            case 'questions':
                const qSnapshot = await db.ref('/questions')
                                        .orderByChild('subjectId')
                                        .equalTo(subjectId)
                                        .once('value');
                const qData = qSnapshot.val();
                state.questions = qData ? Object.values(qData) : [];
                renderQuestionsTab();
                break;
                
            case 'tokens':
                const tSnapshot = await db.ref('/tokens')
                                        .orderByChild('subjectId')
                                        .equalTo(subjectId)
                                        .once('value');
                const tData = tSnapshot.val();
                state.tokens = tData ? Object.values(tData) : [];
                renderTokensTab();
                break;
                
            case 'results':
                const rSnapshot = await db.ref('/results')
                                        .orderByChild('subjectId')
                                        .equalTo(subjectId)
                                        .once('value');
                const rData = rSnapshot.val();
                
                state.results = rData ? Object.values(rData).map(r => {
                    // --- PERBAIKAN 'INVALID DATE' ADA DI SINI ---
                    r.timestamp = r.timestamp ? new Date(r.timestamp).toLocaleString('id-ID') : '-';
                    return r;
                }) : [];
                
                renderResultsTab();
                break;
            // --- TAMBAHKAN CASE BARU INI ---
            case 'monitoring':
                // Kita perlu 'questions' (untuk menghitung skor)
                const monQSnapshot = await db.ref('/questions')
                                            .orderByChild('subjectId')
                                            .equalTo(subjectId)
                                            .once('value');
                const monQData = monQSnapshot.val();
                state.questions = monQData ? Object.values(monQData) : [];
                // Panggil fungsi render tab baru
                renderMonitoringTab();
                break;
            // --- AKHIR CASE BARU ---    
            case 'grading':
                // 1. Ambil Hasil
                const gradeRSnapshot = await db.ref('/results')
                                                .orderByChild('subjectId')
                                                .equalTo(subjectId)
                                                .once('value');
                const gradeRData = gradeRSnapshot.val();
                
                state.results = gradeRData ? Object.values(gradeRData).map(r => {
                    // --- PERBAIKAN 'INVALID DATE' ADA DI SINI ---
                    r.timestamp = r.timestamp ? new Date(r.timestamp).toLocaleString('id-ID') : '-';
                    return r;
                }) : [];

                // 2. Ambil Soal
                const gradeQSnapshot = await db.ref('/questions')
                                                .orderByChild('subjectId')
                                                .equalTo(subjectId)
                                                .once('value');
                const gradeQData = gradeQSnapshot.val();
                state.questions = gradeQData ? Object.values(gradeQData) : [];

                renderEssayGradingTab();
                break;

            case 'print':
                // Hanya perlu Hasil
                const printSnapshot = await db.ref('/results')
                                                .orderByChild('subjectId')
                                                .equalTo(subjectId)
                                                .once('value');
                const printData = printSnapshot.val();
                
                state.results = printData ? Object.values(printData).map(r => {
                    // --- PERBAIKAN 'INVALID DATE' ADA DI SINI ---
                    r.timestamp = r.timestamp ? new Date(r.timestamp).toLocaleString('id-ID') : '-';
                    return r;
                }) : [];
                
                renderPrintTab();
                break;
        }
    } catch (error) {
        console.error(`Gagal memuat tab ${tabName}:`, error);
        showNotification('Error Jaringan', `Gagal memuat data: ${error.message}`, 'error');
        $('#subject-content').innerHTML = `<p>Gagal memuat data untuk tab ini.</p>`;
    }
}

function renderQuestionsTab() {
// --- PENGURUTAN BARU BERDASARKAN CAP WAKTU (BANK SOAL) ---
    const sortedQuestions = [...state.questions].sort((a, b) => {
        const timeA = a.createdAt || 0; // Gunakan 0 jika data lama tidak punya cap waktu
        const timeB = b.createdAt || 0;
        return timeA - timeB; // Urutkan dari yang terlama (awal) ke terbaru (akhir)
    });
    $('#subject-content').innerHTML = `
        <div class="flex justify-end mb-4 gap-2">
            <button onclick="handleImportQuestions()" class="neon-glow-button neon-glow-secondary font-bold py-2 px-4 rounded-lg"><i class="fas fa-file-upload mr-2"></i>Import Soal</button>
            <button onclick="handleAddQuestion()" class="neon-glow-button font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i>Tambah Soal</button>
        </div>
        <div id="questions-list" class="space-y-4">
            ${sortedQuestions.length > 0 ? sortedQuestions.map((q, i) => renderQuestionCard(q, i)).join('') : '<p class="text-center text-gray-400">Belum ada soal untuk mata pelajaran ini.</p>'}
        </div>
    `;
    
    // Panggil loadDynamicImages versi Google Drive
    setTimeout(loadDynamicImages, 0);
}

// GANTI TOTAL FUNGSI 'handleImportQuestions'
function handleImportQuestions() {
    
    const TEMPLATE_FILE_ID = "1-4NMksWTiPjM-ZWRkVsLGMPLo4RqFSL8"; 
    const downloadUrl = `https://drive.google.com/uc?export=download&id=${TEMPLATE_FILE_ID}`;

    const bodyHtml = `
        <p class="mb-4">Fitur impor ini menggunakan file Excel (.xlsx) yang familiar bagi Anda.</p>
        <ol class="list-decimal list-inside space-y-2 mb-6 text-sm">
            <li>Klik tombol <strong>"Download Template"</strong> di bawah.</li>
            <li>Buka file <strong>template_soal.xlsx</strong> di Microsoft Excel.</li>
            <li>Isi data soal Anda (mulai baris 8, di bawah contoh).</li>
            <li>Simpan file Anda.</li>
            <li>Klik <strong>"Upload File Excel"</strong> di bawah dan pilih file yang sudah Anda edit.</li>
            <li>Tekan <strong>"Proses Import"</strong>. (Proses ini mungkin butuh 10-30 detik).</li>
        </ol>
        <a href="${downloadUrl}" target="_blank" class="w-full neon-glow-button neon-glow-secondary font-bold py-2 px-4 rounded-lg flex items-center justify-center mb-4">
            <i class="fas fa-download mr-2"></i> Download Template Excel
        </a>
        <label class="block mb-2 text-sm">Upload File Excel (.xlsx) Anda:</label>
        <input type="file" id="xlsx-upload-input" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" class="w-full p-2 rounded-lg neon-glow-input" required>
    `;

    showModal('Import Soal dari File Excel', bodyHtml, async () => {
        const fileInput = $('#xlsx-upload-input');
        if (fileInput.files.length === 0) {
            showNotification('Error', 'Anda belum memilih file Excel untuk di-upload.', 'error');
            return;
        }
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.readAsDataURL(file);
        
        reader.onload = async () => {
            const fileBase64 = reader.result;
            
            // --- INI PERBAIKANNYA ---
            // 1. Kita panggil 'importQuestionsFromXLSX' (Ini lambat, tapi kita TUNGGU)
            const res = await apiCall('importQuestionsFromXLSX', { 
                subjectId: state.currentSubject.id,
                fileBase64: fileBase64,
                fileName: file.name
            });

            if (res.success) {
                hideModal();
                showNotification('Sukses', res.message, 'success'); // 'keterangan berhasil'
                
                // 2. Kita TIDAK LAGI memanggil apiCall('getQuestions')
                // Kita tambahkan data baru (res.data) ke 'state'
                const newQuestions = res.data; // Data array dari code.gs
                state.questions.push(...newQuestions); // Tambahkan semua soal baru ke state
                
                // 3. Render ulang UI. Ini INSTAN.
                renderQuestionsTab();
            }
            // Jika 'res.success' false, 'apiCall' akan otomatis menampilkan error.
        };
        
        reader.onerror = () => {
            showNotification('Error', 'Gagal membaca file di browser.', 'error');
        };

    }, { actionText: 'Proses Import' });
}

// FUNGSI RENDER KARTU SOAL (VERSI DRIVE LANGSUNG)
// GANTI FUNGSI renderQuestionCard LAMA ANDA DENGAN INI
function renderQuestionCard(question, index) {
    if (question.error) {
        return `<div class="p-4 rounded-lg bg-red-900/50 border border-red-500"><p class="font-bold">Soal #${index + 1} Error</p><p class="text-sm">${question.error}</p></div>`;
    }
    let optionsHtml = '';
    
    if (['Pilihan Ganda', 'Pilihan Ganda Kompleks'].includes(question.type) && Array.isArray(question.options)) {
        optionsHtml = `<ol class="list-[upper-alpha] list-inside space-y-1 mt-2">${(question.options || []).map(opt => `<li>${renderOption(opt || {})}</li>`).join('')}</ol>`;
    } else if (question.type === 'Menjodohkan' && Array.isArray(question.options)) {
        optionsHtml = `<div class="grid grid-cols-2 gap-2 mt-2 font-sans text-sm">`;
        (question.options || []).forEach(pair => {
            optionsHtml += `<div class="bg-black/20 p-2 rounded">${renderOption(pair.q || {})}</div><div class="bg-black/20 p-2 rounded">${renderOption(pair.a || {})}</div>`;
        });
        optionsHtml += `</div>`;
    }
      
    let answerText = 'N/A'; // Default
    try {
        if (question.answer) {
            if (question.type === 'Pilihan Ganda' && typeof question.answer === 'string') {
                const answerIndex = question.answer.charCodeAt(0) - 65; 
                const opt = (question.options || [])[answerIndex];
                answerText = `${question.answer}. ${opt ? opt.text : '(Teks tidak ditemukan)'}`;
            } else if (question.type === 'Pilihan Ganda Kompleks' && Array.isArray(question.answer)) {
                answerText = question.answer.map(letter => {
                    const answerIndex = letter.charCodeAt(0) - 65;
                    const opt = (question.options || [])[answerIndex];
                    return `${letter}. ${opt ? opt.text : '(Teks tidak ditemukan)'}`;
                }).join('<br>');
            } else if (question.type === 'Menjodohkan') {
                answerText = (question.options || []).map((pair, idx) => {
                    const questionLetter = String.fromCharCode(65 + idx);
                    return `${questionLetter}  ${pair.a.text || ''}`;
                }).join('<br>');
            } else {
                // --- (INI PERBAIKANNYA) ---
                if (question.type === 'Isian Singkat' && Array.isArray(question.answer)) {
                    // Tampilkan sebagai daftar yang dipisah titik koma
                    answerText = question.answer.join('; '); 
                } else {
                    // Fallback untuk Benar/Salah, Esai, atau data lama
                    answerText = Array.isArray(question.answer) ? question.answer.join(', ') : question.answer;
                }
                // --- (AKHIR PERBAIKAN) ---
            }
        }
    } catch (e) {
        console.error("Error parsing answer text in renderQuestionCard:", e, question);
        answerText = question.answer ? question.answer.toString() : 'Error';
    }

    let mediaHtml = '';
    if (question.mediaUrl && typeof question.mediaUrl === 'string' && question.mediaUrl.trim() !== '') {
        const imageUrl = buildDriveUrl(question.mediaUrl);
        mediaHtml = `<img src="${imageUrl}" class="my-2 question-media-embed" alt="Memuat media..." loading="lazy">`;
    }

    return `
        <div class="p-4 rounded-lg bg-black/30 border border-fuchsia-500/30">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-bold text-fuchsia-400">Soal #${index + 1} (${question.type})</p>
                    <div class="whitespace-pre-wrap mt-1">${question.text || ''}</div>
                    ${mediaHtml} 
                    ${optionsHtml}
                    <p class="text-xs mt-2 text-green-400"><strong>Jawaban:</strong> ${answerText}</p>
                </div>
                <div class="flex-shrink-0 ml-4 flex flex-col items-end gap-2">
                    <button onclick="handleEditQuestion('${question.id}')" class="text-blue-400 hover:text-blue-300" title="Edit Soal"><i class="fas fa-edit"></i></button>
                    <button onclick="handleDeleteQuestion('${question.id}')" class="text-red-400 hover:text-red-300" title="Hapus Soal"><i class="fas fa-trash"></i></button>
                    <button onclick="handleInsertQuestionBelow('${question.id}')" class="text-green-400 hover:text-green-300" title="Tambah Soal di Bawah Ini">
                        <i class="fas fa-plus-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

async function handleDeleteQuestion(questionId) {
    showModal('Konfirmasi Hapus Soal', `<p>Anda yakin ingin menghapus soal ini?</p>`, async () => {
        const res = await apiCall('deleteQuestion', { id: questionId });
        if (res.success) {
            hideModal();
            showNotification('Sukses', 'Soal berhasil dihapus.', 'success');
            state.questions = state.questions.filter(q => q.id !== questionId);
            renderQuestionsTab();
        }
    }, { actionText: 'Hapus' });
}
function handleAddQuestion() {
    renderQuestionModal(null, null);
}
function handleEditQuestion(questionId) {
    const question = state.questions.find(q => q.id === questionId);
    renderQuestionModal(question);
}

// FUNGSI HELPER BARU UNTUK MENDAPATKAN DAFTAR SOAL YANG TERURUT
function getSortedQuestions() {
    return [...state.questions].sort((a, b) => {
        const timeA = a.createdAt || 0;
        const timeB = b.createdAt || 0;
        return timeA - timeB;
    });
}

// FUNGSI BARU UNTUK TOMBOL "TAMBAH DI BAWAH"
function handleInsertQuestionBelow(questionId) {
    const sortedQuestions = getSortedQuestions();
    const currentIndex = sortedQuestions.findIndex(q => q.id === questionId);
    
    if (currentIndex === -1) return; // Tidak ditemukan

    const timeA = sortedQuestions[currentIndex].createdAt || 0;
    
    // Cek apakah ini soal terakhir
    const isLastQuestion = (currentIndex === sortedQuestions.length - 1);
    
    let timeB;
    if (isLastQuestion) {
        // Jika terakhir, sisipkan di antara soal terakhir dan "sekarang"
        timeB = Date.now();
    } else {
        // Jika di tengah, ambil cap waktu soal berikutnya
        timeB = sortedQuestions[currentIndex + 1].createdAt || 0;
    }
    
    // Hitung titik tengah. Ini akan menghasilkan angka seperti 123456789.5
    // Ini adalah "trik" agar soal baru berada di antara dua soal lama.
    const newTime = timeA + ((timeB - timeA) / 2);
    
    // Buka modal dengan cap waktu sisipan
    renderQuestionModal(null, newTime); 
}


function renderTokensTab() {
        const classes = [...new Set(state.students.map(s => s.class.toString().trim()))].sort();
        $('#subject-content').innerHTML = `
        <div class="p-4 rounded-lg bg-black/30 mb-4">
            <h3 class="font-bold mb-2">Buat Token Baru</h3>
            <div id="class-checkboxes" class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-4">
                ${classes.map(c => `<label class="flex items-center gap-2"><input type="checkbox" name="classGroup" value="${c}" class="form-checkbox h-4 w-4 bg-transparent border-primary-color text-primary-color focus:ring-primary-color">${c}</label>`).join('')}
            </div>
            <button onclick="handleGenerateToken()" class="neon-glow-button font-bold py-2 px-4 rounded-lg">Buat Token</button>
        </div>
        <div>
            <h3 class="font-bold mb-2">Token Aktif</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead><tr class="border-b border-fuchsia-500/50"><th class="p-2">Token</th><th class="p-2">Untuk Kelas</th><th class="p-2">Dibuat</th><th class="p-2"></th></tr></thead>
                    <tbody>
                        ${state.tokens.map(token => `
                        <tr class="border-b border-fuchsia-500/20">
                            <td class="p-2 font-mono text-lg">${token.id}</td>
                            <td class="p-2">${token.classGroup.join(', ')}</td>
                            <td class="p-2 text-sm">${token.createdAt}</td>
                            <td class="p-2 text-right">
                                <button onclick="handleDeleteToken('${token.id}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`).join('') || `<tr><td colspan="4" class="text-center p-4">Belum ada token aktif.</td></tr>`}
                    </tbody>
                </table>
            </div>
        </div>
            `;
}
async function handleGenerateToken() {
    const selectedClasses = Array.from($$('input[name="classGroup"]:checked')).map(cb => cb.value);
    if (selectedClasses.length === 0) {
        showNotification('Error', 'Pilih minimal satu kelas.', 'error');
        return;
    }
    const res = await apiCall('generateToken', { subjectId: state.currentSubject.id, classGroup: selectedClasses });
    if (res.success) {
        showNotification('Sukses', `Token baru berhasil dibuat: ${res.data.token}`, 'success');
        await switchSubjectTab('tokens');
    }
}
async function handleDeleteToken(tokenId) {
        showModal('Konfirmasi Hapus Token', `<p>Anda yakin ingin menghapus token <strong>${tokenId}</strong>?</p>`, async () => {
        const res = await apiCall('deleteToken', { id: tokenId });
        if (res.success) {
            hideModal();
            showNotification('Sukses', 'Token berhasil dihapus.', 'success');
            await switchSubjectTab('tokens');
        }
    }, { actionText: 'Hapus' });
}
function renderResultsTab() {
    const classes = ['all', ...new Set(state.results.map(r => r.class.toString().trim()))].sort();
    const filteredResults = state.resultClassFilter === 'all'
        ? state.results
        : state.results.filter(r => r.class.toString().trim() === state.resultClassFilter);
    $('#subject-content').innerHTML = `
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <div>
                <label for="result-class-filter" class="mr-2">Filter Kelas:</label>
                <select id="result-class-filter" class="neon-glow-input rounded-md px-2 py-1">
                    ${classes.map(c => `<option value="${c}" ${state.resultClassFilter === c ? 'selected' : ''}>${c === 'all' ? 'Semua Kelas' : c}</option>`).join('')}
                </select>
            </div>
            <button onclick="handleExportResults()" class="neon-glow-button font-bold py-2 px-4 rounded-lg"><i class="fas fa-file-export mr-2"></i>Export ke Google Sheets</button>
            <button onclick="handleBulkPrintDossier()" class="neon-glow-button neon-glow-secondary font-bold py-2 px-4 rounded-lg"><i class="fas fa-print mr-2"></i>Cetak Berkas Kelas Ini</button>
        </div>
            <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead><tr class="border-b border-fuchsia-500/50"><th class="p-2">Nama</th><th class="p-2">Kelas</th><th class="p-2">Skor</th><th class="p-2">Waktu Selesai</th><th class="p-2"></th></tr></thead>
                <tbody>
                        ${filteredResults.map(result => `
                        <tr class="border-b border-fuchsia-500/20">
                            <td class="p-2">${result.studentName}</td>
                            <td class="p-2">${result.class}</td>
                            <td class="p-2 font-bold">${parseFloat(result.score).toFixed(1)}</td>
                            <td class="p-2 text-sm">${result.timestamp}</td>
                            <td class="p-2 text-right">
                                <button onclick="handleViewStudentResult('${result.id}')" class="text-blue-400 hover:text-blue-300 mr-2" title="Lihat Jawaban Siswa"><i class="fas fa-eye"></i></button>
                                <button onclick="handleDeleteResult('${result.id}')" class="text-red-400 hover:text-red-300" title="Hapus agar siswa bisa mengulang"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`).join('') || `<tr><td colspan="5" class="text-center p-4">Belum ada hasil ujian.</td></tr>`}
                </tbody>
            </table>
        </div>
    `;
        $('#result-class-filter').addEventListener('change', (e) => {
        state.resultClassFilter = e.target.value;
        renderResultsTab();
    });
}
async function handleDeleteResult(resultId) {
        const result = state.results.find(r => r.id === resultId);
        showModal('Konfirmasi Hapus Hasil', `<p>Hapus hasil ujian <strong>${result.studentName}</strong>? Ini akan memungkinkan siswa untuk mengerjakan ujian kembali.</p>`, async () => {
        const res = await apiCall('deleteResult', { id: resultId });
        if (res.success) {
            hideModal();
            showNotification('Sukses', 'Hasil ujian berhasil dihapus.', 'success');
            await switchSubjectTab('results');
        }
    }, { actionText: 'Hapus' });
}
async function handleExportResults() {
    const res = await apiCall('exportResultsToNewSheet', { subjectId: state.currentSubject.id, classFilter: state.resultClassFilter });
    if (res.success) {
        showNotification('Sukses', res.message, 'success');
    }
}
function renderPrintTab() {
        const filteredResults = state.resultClassFilter === 'all'
        ? state.results
        : state.results.filter(r => r.class.toString().trim() === state.resultClassFilter);
    $('#subject-content').innerHTML = `
        <div class="text-center">
            <p class="mb-4">Halaman ini akan mencetak laporan nilai untuk <strong>${state.currentSubject.name}</strong> kelas <strong>${state.resultClassFilter === 'all' ? 'Semua' : state.resultClassFilter}</strong>.</p>
            <button onclick="handlePrint()" class="neon-glow-button font-bold py-2 px-6 rounded-lg"><i class="fas fa-print mr-2"></i>Cetak Laporan Nilai</button>
            <div id="print-area" class="hidden"></div>
        </div>`;
}

/**
 * FUNGSI (v2) UNTUK MENCETAK LAPORAN NILAI
 * (Sekarang dengan Kop Surat dan Tanda Tangan Resmi)
 */
function handlePrint() {
    // 1. Ambil data nilai yang difilter (Sama seperti sebelumnya)
    const filteredResults = (state.resultClassFilter === 'all'
        ? state.results
        : state.results.filter(r => r.class.toString().trim() === state.resultClassFilter))
        .sort((a,b) => a.studentName.localeCompare(b.studentName));

    if (filteredResults.length === 0) {
        showNotification('Info', 'Tidak ada data nilai di kelas ini untuk dicetak.', 'info');
        return;
    }

    // 2. Mulai membangun string HTML
    let content = `<html><head><title>Laporan Nilai Ujian</title>`;

    // 3. Tambahkan Blok CSS (Kop Surat + Tanda Tangan + TABEL)
    content += `
        <style>
            /* --- CSS Inti Dokumen & Kop Surat (dari contoh Anda) --- */
            body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
            h1, h2, h3 { text-align: center; }
            h1 { font-size: 16pt; margin: 20px 0; }
            h2 { font-size: 14pt; margin: 15px 0; }
            p { margin: 4px 0; }
            .kop-surat { display: flex; align-items: center; border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 20px; }
            .kop-surat .logo { width: 80px; height: 80px; object-fit: contain; }
            .kop-surat .teks-kop { text-align: center; flex-grow: 1; padding: 0 15px; }
            .kop-surat .teks-kop h3, .kop-surat .teks-kop p { margin: 0; line-height: 1.4; }
            
            /* --- CSS Tanda Tangan (dari contoh Anda) --- */
            .signature-container { margin-top: 50px; display: flex; justify-content: space-between; page-break-inside: avoid; }
            .signature-block { width: 40%; text-align: center; }
            .signature-block .name { font-weight: bold; text-decoration: underline; }

            /* --- CSS UNTUK TABEL NILAI (PENTING) --- */
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #000; padding: 8px; text-align: left; word-wrap: break-word; }
            th { background-color: #f2f2f2; text-align: center; }
        </style>
    `;
    
    content += `</head><body>`;

    // 4. Tambahkan Kop Surat (HTML dari contoh Anda)
    content += `
        <div class="kop-surat">
            <img src="https://raw.githubusercontent.com/xiroro-ab/smp58dataguru/refs/heads/main/Logo_Palembang.png" alt="Logo Kiri" class="logo">
            <div class="teks-kop">
                <h3>PEMERINTAH KOTA PALEMBANG</h3>
                <h3>DINAS PENDIDIKAN</h3>
                <h3 style="font-size: 1.2em; font-weight: bold;">SMP NEGERI 58 PALEMBANG</h3>
                <p style="font-size: 0.9em;">Jl. Komering II, Kel. Demang Lebar Daun, Kec. Ilir Barat I, Kota Palembang 30137</p>
                <p style="font-size: 0.9em;">Email: palembangsmpn58@gmail.com</p>
            </div>
            <img src="https://raw.githubusercontent.com/xiroro-ab/smp58dataguru/refs/heads/main/logo58.png" alt="Logo Kanan" class="logo">
        </div>
    `;

    // 5. Tambahkan Header Laporan
    const kelas = state.resultClassFilter === 'all' ? 'Semua Kelas' : state.resultClassFilter;
    content += `<h1>LAPORAN HASIL UJIAN</h1>`;
    content += `<h2>Mata Pelajaran: ${state.currentSubject.name}</h2>`;
    content += `<p style="text-align: center;"><strong>Kelas:</strong> ${kelas}</p>`;
    content += `<p style="text-align: center;"><strong>Tanggal Cetak:</strong> ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>`;

    // 6. Tambahkan Tabel Nilai (Inti dari fungsi ini)
    content += `
        <table>
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Nama Siswa</th>
                    <th>Kelas</th>
                    <th>Skor Akhir</th>
                    <th>Jumlah Pelanggaran</th>
                </tr>
            </thead>
            <tbody>
                ${filteredResults.map((r, i) => `
                    <tr>
                        <td style="text-align: center;">${i+1}</td>
                        <td>${r.studentName}</td>
                        <td style="text-align: center;">${r.class}</td>
                        <td style="text-align: center;">${parseFloat(r.score).toFixed(1)}</td>
                        <td style="text-align: center;">${r.cheatAttempts || 0}</td>
                    </tr>`).join('')}
            </tbody>
        </table>
    `;

    // 7. Tambahkan Tanda Tangan (HTML dari contoh Anda)
    const tanggalCetak = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    content += `
        <div class="signature-container">
            <div class="signature-block">
                <p>Mengetahui,</p>
                <p>Kepala SMPN 58 Palembang</p>
                <br><br><br><br><br>
                <p class="name">Maya Erniwaty Manalu, S.Pd.</p>
                <p>NIP. 196803151992032011</p>
            </div>
            <div class="signature-block">
                <p>Palembang, ${tanggalCetak}</p>
                <p>Guru Mata Pelajaran</p>
                <br><br><br><br><br>
                <p class="name">Aris Bermansyah, S.Kom</p>
                <p>NIPPPK. 199611142024211010</p>
            </div>
        </div>
    `;

    // 8. Tutup HTML dan Tampilkan Dialog Cetak
    content += `</body></html>`;
    
    const printWindow = window.open('', '', 'height=800,width=800');
    printWindow.document.write(content);
    printWindow.document.close();
    
    setTimeout(() => { 
        printWindow.focus();
        printWindow.print();
    }, 1000);
}

// GANTI FUNGSI renderQuestionModal LAMA ANDA DENGAN INI

function renderQuestionModal(question = null, insertTimestamp = null) { // <-- Perubahan di sini
    const isEdit = question !== null;
    const title = isEdit ? `Edit Soal #${getSortedQuestions().findIndex(q => q.id === question.id) + 1}` : 'Tambah Soal Baru';

    const mainMediaPreviewHtml = isEdit && question.mediaUrl
        ? `<div class="mt-2 text-xs text-gray-400">Media saat ini: 
             <a href="javascript:void(0)" onclick="previewMediaInNewTab('${question.mediaUrl}')" class="text-fuchsia-400 hover:underline">Lihat Media</a>
             <br><em class="text-gray-400">Upload file baru untuk menggantinya.</em>
           </div>`
        : '';
    
    const bodyHtml = `
        <input type="hidden" id="questionId" value="${isEdit ? question.id : ''}">
        <input type="hidden" id="newQuestionTimestamp" value="${insertTimestamp || ''}"> 
        
        <div class="space-y-4">
            <div>
                <label class="block mb-2 text-sm">Tipe Soal</label>
                <select id="questionType" class="w-full p-2 rounded-lg neon-glow-input">
                    <option value="Pilihan Ganda">Pilihan Ganda</option>
                    <option value="Pilihan Ganda Kompleks">Pilihan Ganda Kompleks</option>
                    <option value="Benar/Salah">Benar/Salah</option>
                    <option value="Isian Singkat">Isian Singkat</option>
                    <option value="Menjodohkan">Menjodohkan</option>
                    <option value="Esai">Esai</option>
                </select>
            </div>
            <div>
                <label class="block mb-2 text-sm">Teks Soal</label>
                <div class="rte-toolbar flex items-center gap-2 mb-2 p-1 rounded-lg border border-fuchsia-500/50">
                    <button type="button" class="px-2 py-1 rounded" onclick="formatDoc('bold');"><i class="fas fa-bold"></i></button>
                    <button type="button" class="px-2 py-1 rounded" onclick="formatDoc('italic');"><i class="fas fa-italic"></i></button>
                    <button type="button" class="px-2 py-1 rounded" onclick="formatDoc('underline');"><i class="fas fa-underline"></i></button>
                </div>
                <div id="questionText" class="w-full p-2 rounded-lg neon-glow-input rte-content" contenteditable="true"></div>
            </div>
            <div>
                <label class="block mb-2 text-sm">Upload Media (Gambar/Video) - Opsional</label>
                <input type="file" id="questionMediaFile" class="w-full p-2 rounded-lg neon-glow-input" accept="image/*,video/*">
                <input type="hidden" id="questionMediaUrl" value="${isEdit ? (question.mediaUrl || '') : ''}">
                ${mainMediaPreviewHtml} 
            </div>
            <div id="question-options-container"></div>
            <div id="question-answer-container"></div>
        </div>
    `;
    showModal(title, bodyHtml, handleSaveQuestion);

    const typeSelect = $('#questionType');
    if (isEdit) {
        typeSelect.value = question.type;
        $('#questionText').innerText = question.text.replace(/<br>/g, "\n"); 
        $('#questionText').innerHTML = question.text; 
    }
    
    typeSelect.onchange = () => renderQuestionFields(typeSelect.value, null);
    renderQuestionFields(typeSelect.value, question);
}

function formatDoc(command, value = null) {
    document.execCommand(command, false, value);
}

// GANTI FUNGSI renderQuestionFields LAMA ANDA DENGAN INI
function renderQuestionFields(type, question = null) {
    const isEdit = question !== null;
    const optionsContainer = $('#question-options-container');
    const answerContainer = $('#question-answer-container');
    optionsContainer.innerHTML = '';
    answerContainer.innerHTML = '';
    
    switch (type) {
        case 'Pilihan Ganda':
        case 'Pilihan Ganda Kompleks': {
            optionsContainer.innerHTML = `
                <label class="block mb-2 text-sm">Opsi Jawaban</label>
                <div id="mc-options-container"></div>
                <button type="button" onclick="addQuestionOption()" class="text-sm neon-glow-button py-1 px-2 rounded mt-2"><i class="fas fa-plus"></i> Tambah Opsi</button>
            `;
            const options = isEdit && Array.isArray(question.options) && question.options.length > 0 ? question.options : [{}, {}];
            options.forEach(opt => addQuestionOption(opt, isEdit ? question.answer : null));
            break;
        }
        case 'Benar/Salah':
            answerContainer.innerHTML = `<label class="block mb-2 text-sm">Jawaban Benar</label>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2"><input type="radio" name="q-answer-tf" value="Benar" class="form-radio" ${isEdit && question.answer === 'Benar' ? 'checked':''}> Benar</label>
                    <label class="flex items-center gap-2"><input type="radio" name="q-answer-tf" value="Salah" class="form-radio" ${isEdit && question.answer === 'Salah' ? 'checked':''}> Salah</label>
                </div>`;
            break;
        
        // --- (INI PERBAIKANNYA) ---
        case 'Isian Singkat': {
            let answerValue = '';
            if (isEdit && question.answer) {
                // Ubah array jawaban (jika ada) menjadi teks yang dipisah titik koma
                answerValue = Array.isArray(question.answer) ? question.answer.join(';') : question.answer;
            }
            answerContainer.innerHTML = `<label class="block mb-2 text-sm">Jawaban Benar</label>
                <input type="text" id="q-answer-text" class="w-full p-2 rounded-lg neon-glow-input" value="${answerValue}">
                <p class="text-xs text-gray-400 mt-1">Untuk beberapa jawaban benar, pisahkan dengan titik koma (;). Contoh: tema;isi konten</p>`;
            break;
        }
        case 'Esai': {
            // Esai sekarang terpisah dan tetap menggunakan textarea
            const label = 'Kunci Jawaban (Referensi)';
            answerContainer.innerHTML = `<label class="block mb-2 text-sm">${label}</label>
                <textarea id="q-answer-text" class="w-full p-2 rounded-lg neon-glow-input" rows="3">${isEdit ? (question.answer || '') : ''}</textarea>`;
            break;
        }
        // --- (AKHIR PERBAIKAN) ---
        
        case 'Menjodohkan': {
            let pairsHtml = `<label class="block mb-2 text-sm">Pasangan</label>
                <div id="matching-pairs-container">`;
            const pairs = isEdit && Array.isArray(question.options) ? question.options : [{q:{}, a:{}}, {q:{}, a:{}}];
            pairs.forEach((pair, i) => {
                pairsHtml += `
                    <div class="matching-pair grid grid-cols-2 gap-2 mb-2 p-2 border border-fuchsia-500/20 rounded-lg">
                        <div>
                            <input type="text" class="matching-q-text w-full p-1 rounded neon-glow-input" placeholder="Item ${i+1}" value="${(pair.q && pair.q.text) || ''}">
                        </div>
                        <div>
                            <input type="text" class="matching-a-text w-full p-1 rounded neon-glow-input" placeholder="Pasangan ${i+1}" value="${(pair.a && pair.a.text) || ''}">
                        </div>
                    </div>`;
            });
            pairsHtml += `</div>
                <button type="button" onclick="addMatchingPair()" class="text-sm neon-glow-button py-1 px-2 rounded mt-2"><i class="fas fa-plus"></i> Tambah Pasangan</button>`;
            optionsContainer.innerHTML = pairsHtml;
            answerContainer.innerHTML = `<p class="text-xs text-gray-400">Jawaban benar ditentukan oleh pasangan yang Anda buat.</p>`;
            break;
        }
    }
}
function addQuestionOption(value = { text: '', img: '' }, correctAnswer = null) {
    const container = $('#mc-options-container');
    if (!container) return;
    const newOption = document.createElement('div');
    const type = $('#questionType').value === 'Pilihan Ganda' ? 'radio' : 'checkbox';
    const index = container.children.length;
    const letter = String.fromCharCode(65 + index);
    const isChecked = correctAnswer ? (Array.isArray(correctAnswer) ? correctAnswer.includes(letter) : correctAnswer === letter) : false;

    // Link "Lihat Gambar" sekarang memanggil previewMediaInNewTab
    const previewLinkHtml = value.img 
        ? `<div class="text-xs text-gray-400">Gambar saat ini: <a href="javascript:void(0)" onclick="previewMediaInNewTab('${value.img}')" class="text-fuchsia-400 hover:underline">Lihat Media</a></div>` 
        : '';

    newOption.className = 'option-row flex items-center gap-2 mb-2 p-2 border border-fuchsia-500/20 rounded-lg';
    newOption.innerHTML = `
        <input type="${type}" name="q-answer" value="${letter}" class="form-${type} h-5 w-5 bg-transparent border-primary-color text-primary-color focus:ring-primary-color flex-shrink-0" ${isChecked ? 'checked' : ''}>
        <div class="w-full space-y-1">
            <input type="text" class="question-option-text w-full p-1 rounded neon-glow-input" placeholder="Teks Opsi ${letter}" value="${value.text || ''}">
            
            <input type="file" class="question-option-file w-full text-xs neon-glow-input" accept="image/*,video/*">
            <input type="hidden" class="question-option-img" value="${value.img || ''}">
            ${previewLinkHtml}
        </div>
        <button type="button" onclick="removeQuestionOption(this)" class="text-red-400 hover:text-red-300 ml-2 flex-shrink-0"><i class="fas fa-times-circle"></i></button>
    `;
    container.appendChild(newOption);
}
function removeQuestionOption(btn) {
    btn.closest('.option-row').remove();
    reindexOptions();
}
function reindexOptions() {
    const container = $('#mc-options-container');
    if (!container) return;
    const rows = $$('#mc-options-container .option-row');
    rows.forEach((row, index) => {
        const letter = String.fromCharCode(65 + index);
        row.querySelector('input[name="q-answer"]').value = letter;
        row.querySelector('.question-option-text').placeholder = `Teks Opsi ${letter}`;
    });
}
function addMatchingPair() {
    const container = $('#matching-pairs-container');
    const pairCount = container.children.length;
    const newPair = document.createElement('div');
    newPair.className = "matching-pair grid grid-cols-2 gap-2 mb-2 p-2 border border-fuchsia-500/20 rounded-lg";
    newPair.innerHTML = `
        <div>
            <input type="text" class="matching-q-text w-full p-1 rounded neon-glow-input" placeholder="Item ${pairCount + 1}">
        </div>
        <div>
            <input type="text" class="matching-a-text w-full p-1 rounded neon-glow-input" placeholder="Pasangan ${pairCount + 1}">
        </div>`;
    container.appendChild(newPair);
}

// GANTI TOTAL FUNGSI 'handleSaveQuestion'
async function handleSaveQuestion() {
    // (Logika 'readFileAsBase64' dan 'payload' Anda tetap sama)
    const type = $('#questionType').value;
    const readFileAsBase64 = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
        });
    };
    const filePromises = [];
    
    const payload = {
        id: $('#questionId').value,
        subjectId: state.currentSubject.id,
        type: type,
        text: $('#questionText').innerHTML,
        mediaUrl: $('#questionMediaUrl').value, 
        options: [],
        answer: null,
        fileData: null,
        insertTimestamp: $('#newQuestionTimestamp').value || null 
    };
    const mainFileInput = $('#questionMediaFile');
    if (mainFileInput.files.length > 0) {
        const file = mainFileInput.files[0];
        filePromises.push(readFileAsBase64(file).then(base64String => {
            payload.fileData = { base64: base64String, type: file.type, name: file.name };
        }));
    }
    if (['Pilihan Ganda', 'Pilihan Ganda Kompleks'].includes(type)) {
        const optionRows = $$('.option-row');
        optionRows.forEach(row => {
            const optionData = {
                text: row.querySelector('.question-option-text').value,
                img: row.querySelector('.question-option-img').value, 
                fileData: null
            };
            const fileInput = row.querySelector('.question-option-file');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                filePromises.push(readFileAsBase64(file).then(base64String => {
                    optionData.fileData = { base64: base64String, type: file.type, name: file.name };
                }));
            }
            payload.options.push(optionData);
        });
        const selected = Array.from($$('input[name="q-answer"]:checked')).map(cb => cb.value);
        payload.answer = type === 'Pilihan Ganda' ? (selected[0] || null) : selected;
    } 
    else if (type === 'Menjodohkan') {
        payload.options = Array.from($$('.matching-pair')).map(pair => ({
            q: { text: pair.querySelector('.matching-q-text').value, img: '' },
            a: { text: pair.querySelector('.matching-a-text').value, img: '' }
        }));
        payload.answer = "Otomatis";
    }
    else if (type === 'Benar/Salah') {
        const selected = $('input[name="q-answer-tf"]:checked');
        payload.answer = selected ? selected.value : null;
    }
    else if (type === 'Isian Singkat') {
        const rawAnswer = $('#q-answer-text').value || '';
        payload.answer = rawAnswer.split(';')
                                  .map(ans => ans.trim())
                                  .filter(ans => ans.length > 0);
    }
    else if (type === 'Esai') {
        payload.answer = $('#q-answer-text').value;
    }

    try {
        await Promise.all(filePromises);
    } catch (error) {
        showNotification('Error', 'Gagal membaca salah satu file untuk diupload.', 'error');
        return;
    }
    
    // --- INI PERBAIKANNYA ---
    // 1. Kita panggil 'saveQuestion' dan TUNGGU (karena ini masih perlu 'code.gs' untuk file)
    const res = await apiCall('saveQuestion', payload);
    
    if(res.success) {
        hideModal();
        showNotification('Sukses', 'Soal berhasil disimpan', 'success');
        
// --- PERBAIKAN LOGIKA UPDATE MANUAL (ANTI-SKELETON & ANTI-TIMEOUT) ---
        
        const serverData = res.data; 

        // LOGIKA BARU: Jika ini soal Menjodohkan, PRIORITASKAN opsi lokal (payload) 
        // untuk menghindari crash jika server belum selesai deploy fix-nya.
        let finalOptions = serverData.options;
        if (payload.type === 'Menjodohkan') {
            finalOptions = payload.options; // Pakai opsi yang baru saja diketik user
        }

        const safeQuestionData = {
            ...serverData,
            options: finalOptions, // Paksa pakai opsi yang aman
            createdAt: serverData.createdAt ? parseInt(serverData.createdAt) : Date.now()
        };

        // Langkah 2: Update State Lokal (Cepat, Tanpa Download Ulang)
        const index = state.questions.findIndex(q => q.id === safeQuestionData.id);
        
        if (index !== -1) {
            // MODE EDIT: Timpa data lama
            // Kita pertahankan properti lokal yang mungkin penting
            state.questions[index] = { ...state.questions[index], ...safeQuestionData };
        } else {
            // MODE TAMBAH: Masukkan ke array
            state.questions.push(safeQuestionData);
        }
        
        // Langkah 3: Urutkan ulang array secara manual agar posisi benar
        state.questions.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));

        // Langkah 4: Render ulang dari data lokal (Instan)
        renderQuestionsTab();
        
        // --- AKHIR PERBAIKAN ---
    }
    // Jika 'res.success' false, 'apiCall' akan otomatis menampilkan error.
}

// --- SISWA FLOW ---
async function populateKelasSelect() {
    showLoader();
    try {
        // BACA LANGSUNG DARI FIREBASE (Bukan apiCall)
        const snapshot = await db.ref('/students').once('value');
        const studentsData = snapshot.val();

        if (studentsData) {
            state.students = Object.values(studentsData); 
            const classes = [...new Set(state.students.map(s => s.class.toString().trim()))].sort();
            const select = $('#kelas-select');
            select.innerHTML = '<option value="">-- Pilih Kelas --</option>';
            classes.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`);
        } else {
            $('#kelas-select').innerHTML = '<option value="">Data siswa kosong</option>';
        }
    } catch (error) {
        console.error("Gagal memuat data kelas:", error);
        showNotification('Error', 'Gagal memuat data siswa.', 'error');
    } finally {
        hideLoader();
    }
}
function populateNamaSelect() {
    const selectedClass = $('#kelas-select').value;
    const namaSelect = $('#nama-select');
    namaSelect.innerHTML = '<option value="">-- Pilih Nama --</option>';
    if (selectedClass) {
        const studentsInClass = state.students
            .filter(s => s.class.toString().trim() === selectedClass)
            .sort((a,b) => a.name.localeCompare(b.name));
        studentsInClass.forEach(s => namaSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);
        namaSelect.disabled = false;
    } else {
        namaSelect.disabled = true;
    }
}

async function handleSiswaLogin(e) {
    e.preventDefault();
    
    const studentId = $('#nama-select').value;
    const token = $('#token').value.trim().toUpperCase();

    if (!studentId || !token) {
        showNotification('Error', 'Harap lengkapi semua field.', 'error');
        return;
    }

    const student = state.students.find(s => s.id === studentId);
    if (!student) {
        showNotification('Error', 'Data siswa tidak ditemukan.', 'error');
        return;
    }

    showLoader();

    try {
        // 1. Cek Token
        const tokenSnapshot = await db.ref('/tokens/' + token).once('value');
        const tokenInfo = tokenSnapshot.val();
        if (!tokenInfo) throw new Error("Token ujian tidak valid.");

        // Validasi Kelas
        const studentClass = student.class.toString().trim();
        const tokenClasses = Array.isArray(tokenInfo.classGroup) ? tokenInfo.classGroup.map(c => c.toString().trim()) : []; 
        if (!tokenClasses.includes(studentClass)) throw new Error(`Token ini bukan untuk kelas Anda (${studentClass}).`);

        const subjectId = tokenInfo.subjectId;
        const subjectSnap = await db.ref('/subjects/' + subjectId).once('value');
        const subject = subjectSnap.val();
        if (!subject) throw new Error("Data mata pelajaran tidak ditemukan.");

        // -----------------------------------------------------------
        // 4. CEK STATUS KELULUSAN (Logika yang Diperbaiki)
        // -----------------------------------------------------------
        
        // A. Cek Tabel Completion (Flag Sederhana)
        const completionSnap = await db.ref(`/examCompletions/${studentId}_${subjectId}`).once('value');
        if (completionSnap.exists() && completionSnap.val() === true) {
            throw new Error("Anda sudah menyelesaikan ujian ini.");
        }

        // B. Cek Tabel Results (Pengecekan Fisik Data Nilai) - INI YANG KEMARIN TERLEWAT
        // Kita cari di database nilai: Apakah siswa ini sudah punya nilai untuk mapel ini?
        const resultsRef = db.ref('/results');
        const resultQuery = await resultsRef.orderByChild('studentId').equalTo(studentId).once('value');
        const studentResults = resultQuery.val();

        if (studentResults) {
            // Karena firebase return object keys, kita convert ke array dan cari subjectId yang sama
            const hasFinishedExam = Object.values(studentResults).some(r => r.subjectId === subjectId);
            
            if (hasFinishedExam) {
                // Tampilkan Modal Info agar lebih jelas daripada sekadar Alert Error
                 showModal(
                    'Ujian Selesai',
                    `<div class="text-center text-green-400">
                        <i class="fas fa-check-circle text-5xl mb-4"></i>
                        <p class="text-white text-lg font-bold">Anda sudah mengerjakan ujian ini.</p>
                        <p class="text-sm text-gray-400 mt-2">Nilai Anda sudah terekam di sistem.</p>
                    </div>`,
                    () => hideModal(),
                    { actionText: 'Tutup', hideCancel: true }
                );
                hideLoader();
                return; // STOP DISINI
            }
        }
        // -----------------------------------------------------------

        // 2. Cek Status Server (Sesi Live)
        const sessionSnap = await db.ref(`/examSessions/${studentId}_${subjectId}`).once('value');
        let serverCheatCount = 0;
        let isSessionActiveOnServer = false;
        let serverStatus = 'ongoing';

        if (sessionSnap.exists()) {
            const val = sessionSnap.val();
            serverCheatCount = val.cheatAttempts || 0; // INI ADALAH NILAI KEBENARAN (Misal: 0 karena direset guru)
            serverStatus = val.status || 'ongoing';
            isSessionActiveOnServer = true;
        }

        // 3. Cek Apakah Masih Terblokir DI SERVER? (Double Check)
        // Kalau guru belum reset, serverCheatCount masih 3. Kalau sudah reset, jadi 0.
        const violationLimit = parseInt(subject.violationLimit || 3);
        if (isSessionActiveOnServer && violationLimit > 0 && serverCheatCount >= violationLimit) {
             showModal('Akses Ditolak',
                `<div class="text-center">
                    <i class="fas fa-lock text-5xl text-red-500 mb-4"></i>
                    <p>Anda tidak dapat masuk kembali ke ujian ini.</p>
                    <p class="text-sm text-gray-400 mt-2">Sistem mendeteksi <strong>${serverCheatCount}</strong> pelanggaran.</p>
                    <p class="text-sm text-yellow-500 mt-4 border border-yellow-500/30 p-2 rounded bg-yellow-500/10">
                        Silakan lapor ke Pengawas agar ujian Anda diselesaikan (Disimpan) secara manual lewat Monitoring.
                    </p>
                </div>`, ()=>hideModal(), {hideCancel:true});
             hideLoader();
             return;
        }

        // 4. --- [PERBAIKAN UTAMA: SINKRONISASI LOCALSTORAGE] ---
        const storageKey = `cbt-exam-state-${studentId}-${token}`;
        const savedState = localStorage.getItem(storageKey);

        if (savedState) {
            // Kita punya data lokal (yang mungkin BASI / masih 3 pelanggaran)
            let localData = JSON.parse(savedState);
            
            // LOGIKA: Jika Sesi Server Aktif DAN data pelanggaran lokal BERBEDA dengan Server
            if (isSessionActiveOnServer && localData.cheatAttempts !== serverCheatCount) {
                console.log(`Sinkronisasi: Lokal(${localData.cheatAttempts}) vs Server(${serverCheatCount}). Mengikuti Server.`);
                
                // TIMPA data pelanggaran lokal dengan data server (0)
                localData.cheatAttempts = serverCheatCount;
                
                // Jika server sudah mereset (0), pastikan status finished di lokal dimatikan
                if (serverCheatCount < violationLimit) {
                    localData.isFinished = false; 
                }

                // Simpan kembali data yang sudah DIPERBAIKI ke HP Siswa
                localStorage.setItem(storageKey, JSON.stringify(localData));
            }
            
            // Tambahan: Jika sesi server sudah dihapus guru (Force Finish), hapus lokal.
            if (!isSessionActiveOnServer) {
                localStorage.removeItem(storageKey);
            }
        }
        // -------------------------------------------------------

        // 5. Ambil Soal (Standar)
        const questionsSnap = await db.ref('/questions_public').orderByChild('subjectId').equalTo(subjectId).once('value');
        const questionsData = questionsSnap.val();
        if (!questionsData) throw new Error("Soal belum tersedia.");

        // Grouping & Shuffle (Standar)
        const typeOrder = ["Pilihan Ganda", "Pilihan Ganda Kompleks", "Menjodohkan", "Benar/Salah", "Isian Singkat", "Esai"];
        const groupedQuestions = {};
        typeOrder.forEach(type => groupedQuestions[type] = []);
        groupedQuestions["Lainnya"] = []; 
        Object.values(questionsData).forEach(q => {
            if (typeOrder.includes(q.type)) groupedQuestions[q.type].push(q);
            else groupedQuestions["Lainnya"].push(q);
        });
        let finalSortedQuestions = [];
        typeOrder.forEach(type => {
            const group = groupedQuestions[type];
            if (group.length > 0) finalSortedQuestions = finalSortedQuestions.concat(shuffleArray([...group]));
        });
        if (groupedQuestions["Lainnya"].length > 0) finalSortedQuestions = finalSortedQuestions.concat(shuffleArray(groupedQuestions["Lainnya"]));

        const questionIDs = finalSortedQuestions.map(q => q.id);
        const loadedQuestions = {};
        finalSortedQuestions.forEach(q => { loadedQuestions[q.id] = q; });

        const newExamData = {
            subject: subject,
            subjectId: subjectId,
            questionIDs: questionIDs,
            loadedQuestions: loadedQuestions,
            studentId: studentId,
            token: token,
            startTime: new Date().toISOString(),
            cheatAttempts: serverCheatCount // Pastikan pakai data server
        };

        // 6. Eksekusi Login
        // Karena di Poin 4 kita sudah memperbaiki localStorage,
        // showResumeConfirmationModal sekarang akan membaca data yang BENAR (0 Pelanggaran).
        if (localStorage.getItem(storageKey) && isSessionActiveOnServer) {
             showResumeConfirmationModal(storageKey, studentId, token);
        } else {
             startNewExam(newExamData, studentId, token);
        }

    } catch (error) {
        console.error("Login Error:", error);
        showNotification('Gagal Masuk', error.message, 'error');
    } finally {
        hideLoader();
    }
}

function startNewExam(examData, studentId, token) {
    // Debugging: Pastikan data sampai di sini
    console.log("Memulai Ujian dengan Data:", examData);

    // 1. Simpan ke State Global (MEMORI UTAMA)
    state.currentExam = {
        subject: examData.subject,
        subjectId: examData.subjectId,
        questionIDs: examData.questionIDs,
        loadedQuestions: examData.loadedQuestions,
        studentId: studentId,
        token: token,
        
        // Siapkan array jawaban kosong sesuai jumlah soal
        answers: examData.questionIDs.map(qId => ({
            questionId: qId,
            answer: null,
            isDoubtful: false
        })),
        
        currentQuestionIndex: 0,
        
        // --- PERBAIKAN 1: WAKTU ---
        // Gunakan waktu yang sudah disiapkan di handleSiswaLogin (konsisten)
        startTime: examData.startTime || new Date().toISOString(),
        
        // Konversi durasi menit ke detik
        remainingSeconds: (parseInt(examData.subject.duration) || 60) * 60,
        
        // --- PERBAIKAN 2: SINKRONISASI PELANGGARAN ---
        // Jangan di-reset ke 0! Ambil data dari server yang dikirim lewat examData
        cheatAttempts: examData.cheatAttempts || 0, 
        // ---------------------------------------------
        
        isFinished: false
    };

    // 2. Render Halaman Instruksi
    const detailsDiv = $('#exam-details');
    if (detailsDiv) {
        // Tampilkan info pelanggaran jika ada (agar siswa sadar)
        const cheatInfo = state.currentExam.cheatAttempts > 0 
            ? `<p class="text-red-400 mt-2 font-bold text-sm"><i class="fas fa-exclamation-triangle"></i> Catatan: Anda memiliki ${state.currentExam.cheatAttempts} pelanggaran sebelumnya.</p>` 
            : '';

        detailsDiv.innerHTML = `
            <p class="mb-2"><strong class="text-fuchsia-400">Mata Pelajaran:</strong> ${state.currentExam.subject.name}</p>
            <p class="mb-2"><strong class="text-fuchsia-400">Jumlah Soal:</strong> ${state.currentExam.questionIDs.length} butir</p>
            <p class="mb-2"><strong class="text-fuchsia-400">Durasi:</strong> ${state.currentExam.subject.duration} menit</p>
            <p class="text-sm text-gray-400 mt-4"><i class="fas fa-info-circle"></i> Pastikan koneksi internet stabil. Jangan keluar dari halaman ujian.</p>
            ${cheatInfo}
        `;
    }

    // 3. Siapkan Tombol Mulai
    const startBtn = $('#start-exam-btn');
    if (startBtn) {
        startBtn.onclick = () => {
            startExam(false).catch(e => console.error(e));
        };
    }

    // 4. Pindah ke Halaman Instruksi
    navigateTo('page-exam-instruction');
}

function renderExamInstructions() {
    const { subject, questionIDs } = state.currentExam;
    const violationLimit = parseInt(subject.violationLimit, 10);
    let violationText = '';
    if (violationLimit > 0) {
        violationText = `<p class="text-yellow-400"><i class="fas fa-exclamation-triangle mr-2"></i><strong>Penting:</strong> Batas maksimal pelanggaran (keluar halaman) adalah <strong>${violationLimit}</strong> kali.</p>`;
    } else {
        violationText = `<p class="text-gray-400"><i class="fas fa-info-circle mr-2"></i>Setiap aktivitas keluar dari halaman ujian akan dicatat.</p>`;
    }
    $('#exam-details').innerHTML = `
        <p><strong>Mata Pelajaran:</strong> ${subject.name}</p>
        <p><strong>Jumlah Soal:</strong> ${questionIDs.length}</p>
        <p><strong>Durasi:</strong> ${subject.duration} menit</p>
        ${violationText}
    `;
    $('#start-exam-btn').onclick = () => startExam(false).catch(e => console.error(e));
}

async function startExam(isResuming = false) {
    // --- [PERBAIKAN 1: CEK DATA KRITIS] ---
    if (!state.currentExam || !state.currentExam.subject) {
        console.error("Data ujian korup/hilang saat startExam");
        showNotification('Error Fatal', 'Data ujian tidak ditemukan. Silakan login ulang.', 'error');
        return;
    }

    // --- [PERBAIKAN LOGIKA REFRESH] ---
    const limit = parseInt(state.currentExam.subject.violationLimit || 3);
    const currentCheats = state.currentExam.cheatAttempts || 0;

    if (limit > 0 && currentCheats >= limit) {
        console.warn("Siswa melanggar batas (Refresh detect). Mengunci ujian...");
        
        // Panggil fungsi LOCK (Bekukan), bukan FINISH (Hapus)
        // Ini membuat siswa tetap ada di Monitoring Guru
        await lockExam(); 
        return; 
    }
    // ----------------------------------

    // 1. Set Status Sedang Ujian
    isDuringExam = true;
    navigateTo('page-exam');

    // 2. Paksa Layar Penuh (Anti-Cheat Awal)
    try {
        if (document.documentElement.requestFullscreen) {
            await document.documentElement.requestFullscreen();
        } else if (document.documentElement.webkitRequestFullscreen) {
            await document.documentElement.webkitRequestFullscreen();
        }
    } catch (err) {
        console.warn("Fullscreen ditolak/gagal:", err);
    }
    
    // 3. LOGIKA LIVE MONITORING
    const { studentId, subjectId, subject, questionIDs, cheatAttempts } = state.currentExam;
    const student = state.students.find(s => s.id === studentId);

    const sessionData = {
        studentId: studentId,
        studentName: student ? student.name : 'Siswa',
        class: student ? student.class : '-',
        subjectId: subjectId,
        subjectName: subject.name,
        status: "ongoing",
        startTime: state.currentExam.startTime,
        remainingSeconds: state.currentExam.remainingSeconds,
        cheatAttempts: cheatAttempts || 0,
        isFocus: true,
        progress: state.currentExam.answers.filter(a => a.answer !== null).length,
        totalQuestions: questionIDs.length,
        answers: state.currentExam.answers,
        lastUpdate: firebase.database.ServerValue.TIMESTAMP
    };

    // Kirim data awal ke Firebase
    await db.ref(`/examSessions/${studentId}_${subjectId}`).update(sessionData);

    // 4. "Detak Jantung" (Heartbeat)
    if (state.examHeartbeat) clearInterval(state.examHeartbeat);
    state.examHeartbeat = setInterval(() => {
        if (!isDuringExam || !state.currentExam) {
            clearInterval(state.examHeartbeat);
            return;
        }
        db.ref(`/examSessions/${studentId}_${subjectId}`).update({
            remainingSeconds: state.currentExam.remainingSeconds,
            cheatAttempts: state.currentExam.cheatAttempts || 0,
            progress: state.currentExam.answers.filter(a => a.answer !== null).length,
            isFocus: !document.hidden,
            lastUpdate: firebase.database.ServerValue.TIMESTAMP
        });
    }, 10000);

    // 5. Render Halaman & Timer
    await renderExamPage();
    
    let duration = state.currentExam.subject.duration;
    if (isResuming && state.currentExam.remainingSeconds) {
        duration = state.currentExam.remainingSeconds / 60;
    }
    startTimer(duration);

    // 6. Aktifkan Sensor Anti-Cheat (INI PENTING AGAR POPUP MUNCUL)
    // Hapus dulu yang lama biar bersih, baru pasang yang baru
    // --- [PERBAIKAN: GRACE PERIOD / JEDA TOLERANSI] ---
    // Jangan langsung pasang sensor. Tunggu 2 detik agar fullscreen stabil dulu.
    
    removeAntiCheatListeners(); // Hapus sisa listener lama (jika ada)

    setTimeout(() => {
        // Cek lagi: Apakah masih dalam mode ujian? (Siapa tahu siswa menutup tab saat loading)
        if (isDuringExam) {
            addAntiCheatListeners(); // Pasang sensor
            monitorSessionStatus();  // Pasang monitor status
            console.log("Sensor Anti-Cheat Aktif."); // Debugging
        }
    }, 2000); // Jeda 2000ms (2 detik)
    // --------------------------------------------------
}


async function renderExamPage() {
    renderQuestionNav();
    await renderCurrentQuestion();
    $('#prev-question-btn').onclick = () => navigateQuestion('prev').catch(e => console.error(e));
    $('#ragu-ragu-btn').onclick = () => handleRaguRaguAndNext().catch(e => console.error(e));
    $('#next-question-btn').onclick = () => navigateQuestion('next').catch(e => console.error(e));
    $('#finish-exam-btn').onclick = () => finishExam(false);
}
function renderQuestionNav() {
    const navGrid = $('#question-nav-grid');
    navGrid.innerHTML = state.currentExam.answers.map((answerData, index) => {
        let colorClass = 'bg-gray-700 hover:bg-gray-600';
        if (answerData.answer !== null) colorClass = 'bg-green-600/70 hover:bg-green-600';
        if (answerData.isDoubtful) colorClass = 'bg-yellow-500/70 hover:bg-yellow-500';
        if (index === state.currentExam.currentQuestionIndex) colorClass = 'bg-blue-600 text-white ring-2 ring-white';
        return `<button onclick="jumpToQuestion(${index}).catch(e => console.error(e))" class="question-nav-button rounded-md transition-all duration-200 ${colorClass}">${index + 1}</button>`;
    }).join('');
}
async function jumpToQuestion(index) {
    saveCurrentAnswer();
    state.currentExam.currentQuestionIndex = index;
    await renderCurrentQuestion();
    renderQuestionNav();
    saveExamStateToLocalStorage();
}

async function renderCurrentQuestion() {
    // Ambil data dari state lokal (Memori HP)
    const { answers, currentQuestionIndex, questionIDs, loadedQuestions } = state.currentExam;
    
    // Dapatkan ID soal yang sedang aktif
    const questionId = questionIDs[currentQuestionIndex];
    
    // AMBIL SOAL LANGSUNG DARI MEMORI (Instan, Tanpa Loading Server)
    const question = loadedQuestions[questionId]; 

    const contentDiv = $('#question-content');

    // Safety Check: Jika soal entah kenapa tidak ada di memori
    if (!question) {
        contentDiv.innerHTML = `<div class="text-center p-8 bg-red-900/50 rounded-lg">
            <h3 class="text-2xl text-red-400 font-bold mb-2">Error Data</h3>
            <p>Data soal tidak ditemukan di perangkat Anda.</p>
            <button onclick="location.reload()" class="mt-4 neon-glow-button py-2 px-4 rounded">Refresh Halaman</button>
        </div>`;
        return;
    }

    // Ambil data jawaban siswa saat ini (jika sudah pernah jawab)
    const answerData = answers[currentQuestionIndex];

    // 1. Render Media Soal (Gambar/Video Utama)
    let mediaHtml = '';
    if (question.mediaUrl && typeof question.mediaUrl === 'string' && question.mediaUrl.trim() !== '') {
        const imageUrl = buildDriveUrl(question.mediaUrl);
        mediaHtml = `<img src="${imageUrl}" class="my-4 question-media-embed" alt="Media Soal" loading="lazy">`;
    }

    // 2. Teks Instruksi per Tipe Soal
    const instructions = {
        "Pilihan Ganda": "Pilihlah salah satu jawaban yang paling tepat.",
        "Pilihan Ganda Kompleks": "Pilihlah satu atau lebih jawaban yang benar.",
        "Benar/Salah": "Tentukan pernyataan berikut Benar atau Salah.",
        "Isian Singkat": "Jawablah dengan singkat dan tepat.",
        "Menjodohkan": "Tarik garis untuk memasangkan pernyataan kiri dengan jawaban kanan.",
        "Esai": "Jawablah pertanyaan berikut dengan uraian yang jelas."
    };
    const instructionText = instructions[question.type] || "";
    
    // 3. Render Header Soal & Teks Soal
    let questionHtml = `<div class="mb-4">
        <div class="flex justify-between items-center">
            <span class="text-sm font-bold text-fuchsia-400">Soal No. ${currentQuestionIndex + 1}</span>
            <span class="text-xs font-semibold px-2 py-1 bg-fuchsia-500/20 text-fuchsia-300 rounded-full">${question.type}</span>
        </div>
        <p class="text-sm text-fuchsia-300/70 italic mt-2">${instructionText}</p> 
        <div class="text-base mt-2 whitespace-pre-wrap">${question.text || ''}</div>
        ${mediaHtml}
    </div>`;

    const { type, options } = question;

    // 4. Render Opsi Jawaban Berdasarkan Tipe
    if (type === 'Pilihan Ganda' || type === 'Pilihan Ganda Kompleks') {
        const safeOptions = options || []; 
        questionHtml += `<div class="space-y-3">${safeOptions.map((opt, idx) => {
            const optionLetter = String.fromCharCode(65 + idx); // A, B, C...
            
            // Cek apakah opsi ini sedang dipilih siswa
            const isChecked = type === 'Pilihan Ganda' 
                ? answerData.answer === optionLetter
                : Array.isArray(answerData.answer) && answerData.answer.includes(optionLetter);
            
            const inputType = type === 'Pilihan Ganda' ? 'radio' : 'checkbox';
            // Render konten opsi (bisa teks + gambar)
            const optionContent = renderOption(opt || { text: '' }); 
            
            return `
            <label class="flex items-start p-3 rounded-lg border border-gray-600 hover:border-fuchsia-500 cursor-pointer transition-colors ${isChecked ? 'bg-fuchsia-500/20 border-fuchsia-400' : ''}">
                <input type="${inputType}" name="option" value="${optionLetter}" class="mr-3 mt-1 form-${inputType} h-5 w-5 bg-transparent border-primary-color text-primary-color focus:ring-primary-color" ${isChecked ? 'checked' : ''}>
                <div class="w-full">
                    <span class="font-bold text-fuchsia-400 mr-2">${optionLetter}.</span>
                    ${optionContent}
                </div>
            </label>`;
        }).join('')}</div>`;
    } 
    
    else if (type === 'Menjodohkan') { 
        if (!answerData.pairs) answerData.pairs = [];

        // Filter opsi yang valid
        const safeOptions = (Array.isArray(options) ? options : []).filter(pair => pair && pair.q && pair.a);
        
        // Sisi Kiri (Pertanyaan) - Tetap urut
        const questionItems = safeOptions.map(pair => pair.q);
        
        // Sisi Kanan (Jawaban) - HARUS DIACAK LOKAL DI SINI
        if (!answerData.shuffledAnswers) {
            // Copy array agar tidak merusak data asli
            const answerItems = safeOptions.map(pair => pair.a);
            // Acak array jawaban
            answerData.shuffledAnswers = shuffleArray(answerItems);
        }
        const shuffledAnswerItems = answerData.shuffledAnswers;
        
        questionHtml += `
    <div id="matching-container" class="relative select-none mt-4">
        <canvas id="matching-canvas"></canvas>
        <div class="grid grid-cols-2 gap-8">
            <div id="matching-left" class="space-y-4">
                <h4 class="font-bold text-fuchsia-400 text-center mb-2 text-sm">Pernyataan</h4>
                ${questionItems.map((item, idx) => `
                    <div class="matching-item p-3 rounded-lg flex items-center min-h-[60px]" data-side="left" data-index="${idx}">
                        <span class="font-bold text-fuchsia-400 mr-3">${String.fromCharCode(65 + idx)}.</span>
                        <div class="text-sm w-full">${renderOption(item)}</div>
                    </div>
                `).join('')}
            </div>

            <div id="matching-right" class="space-y-4">
                <h4 class="font-bold text-fuchsia-400 text-center mb-2 text-sm">Pasangan</h4>
                ${shuffledAnswerItems.map((item, idx) => `
                    <div class="matching-item p-3 rounded-lg flex items-center min-h-[60px]" data-side="right" data-index="${idx}">
                        <div class="text-sm w-full text-center">${renderOption(item)}</div>
                    </div>
                `).join('')}
            </div>
        </div>
        <div class="mt-4 text-center text-xs text-gray-400">
            Klik item kiri, lalu klik item kanan untuk menghubungkan. Klik lagi untuk membatalkan.
        </div>
    </div>`;
        
        // Inisialisasi Canvas Garis (delay sedikit agar DOM siap)
        setTimeout(() => setupMatchingQuestion(answerData.pairs), 100);
    } 
    
    else if (type === 'Benar/Salah') {
        questionHtml += `<div class="space-y-3">
            <label class="flex items-center p-3 rounded-lg border border-gray-600 hover:border-fuchsia-500 cursor-pointer transition-colors ${answerData.answer === 'Benar' ? 'bg-fuchsia-500/20 border-fuchsia-400' : ''}">
                <input type="radio" name="bs_option" value="Benar" class="mr-3 form-radio h-5 w-5 bg-transparent border-primary-color text-primary-color focus:ring-primary-color" ${answerData.answer === 'Benar' ? 'checked' : ''}> 
                <span class="font-bold text-green-400">Benar</span>
            </label>
            <label class="flex items-center p-3 rounded-lg border border-gray-600 hover:border-fuchsia-500 cursor-pointer transition-colors ${answerData.answer === 'Salah' ? 'bg-fuchsia-500/20 border-fuchsia-400' : ''}">
                <input type="radio" name="bs_option" value="Salah" class="mr-3 form-radio h-5 w-5 bg-transparent border-primary-color text-primary-color focus:ring-primary-color" ${answerData.answer === 'Salah' ? 'checked' : ''}> 
                <span class="font-bold text-red-400">Salah</span>
            </label>
        </div>`;
    } 
    
    else { 
        // Isian Singkat & Esai
        questionHtml += `<textarea class="w-full p-3 rounded-lg neon-glow-input mt-4 focus:ring-2 focus:ring-fuchsia-500" rows="5" placeholder="Ketik jawaban Anda di sini...">${answerData.answer || ''}</textarea>`;
    }

    // 5. Tampilkan ke Layar
    contentDiv.innerHTML = questionHtml;
    
    // Helper image loader (jika masih diperlukan)
    setTimeout(loadDynamicImages, 0);

    // 6. Update Tombol Navigasi (Prev/Next/Finish)
    $('#prev-question-btn').classList.toggle('invisible', currentQuestionIndex === 0);
    
    const isLastQuestion = currentQuestionIndex === questionIDs.length - 1;
    
    $('#next-question-btn').classList.toggle('hidden', isLastQuestion);
    $('#ragu-ragu-btn').classList.toggle('hidden', isLastQuestion);
    
    // Tombol Finish hanya muncul di soal terakhir
    $('#finish-exam-btn').classList.toggle('hidden', !isLastQuestion);
    
    // Update Grid Nomor Soal di panel kiri
    renderQuestionNav();
}

function saveCurrentAnswer() {
    // --- [PERBAIKAN UTAMA DI SINI] ---
    // Cek dulu: Apakah elemen soal benar-benar ada di layar?
    const contentDiv = $('#question-content');
    
    // Jika div soal tidak ada, atau kosong (karena diblokir di awal),
    // BERHENTI DI SINI. Jangan update/timpa data apapun.
    // Biarkan data jawaban yang dari LocalStorage/Server tetap aman.
    if (!contentDiv || contentDiv.innerHTML.trim() === '') {
        return; 
    }
    // ---------------------------------

    // 1. Ambil Data dari State
    const { currentQuestionIndex, answers, questionIDs, loadedQuestions } = state.currentExam;
    
    if (!questionIDs || !questionIDs[currentQuestionIndex]) return;

    const questionId = questionIDs[currentQuestionIndex];
    const question = loadedQuestions[questionId]; 

    if (!question) return; 

    const answerData = answers[currentQuestionIndex];
    let currentAnswer = null;
    
    // 2. Ambil Input dari UI berdasarkan Tipe Soal
    try {
        switch(question.type) {
            case 'Pilihan Ganda': {
                const selectedOption = $('input[name="option"]:checked');
                if (selectedOption) currentAnswer = selectedOption.value;
                break;
            }
            case 'Pilihan Ganda Kompleks': {
                const selectedOptions = Array.from($$('input[name="option"]:checked')).map(cb => cb.value);
                currentAnswer = selectedOptions.length > 0 ? selectedOptions : null;
                break;
            }
            case 'Benar/Salah': {
                const selectedOption = $('input[name="bs_option"]:checked');
                if (selectedOption) currentAnswer = selectedOption.value;
                break;
            }
            case 'Menjodohkan': {
                if (answerData.pairs && answerData.shuffledAnswers) {
                    const formattedPairs = answerData.pairs.map(pair => ({
                        questionItem: String.fromCharCode(65 + pair.leftIndex), 
                        answerItem: answerData.shuffledAnswers[pair.rightIndex].text 
                    }));
                    currentAnswer = formattedPairs.length > 0 ? formattedPairs : null;
                }
                break;
            }
            default: { // Esai & Isian Singkat
                const textarea = $('#question-content textarea');
                if(textarea && textarea.value.trim() !== '') {
                    currentAnswer = textarea.value.trim();
                }
                break;
            }
        }
    } catch (e) {
        console.warn("Gagal membaca input:", e);
    }
    
    // 3. Simpan ke State Lokal
    const isChanged = JSON.stringify(answerData.answer) !== JSON.stringify(currentAnswer);
    
    if (isChanged || currentAnswer === null) {
        // update hanya jika ada perubahan valid atau input memang sengaja dikosongkan user (bukan sistem)
        answerData.answer = currentAnswer;
        
        const storageKey = `cbt-exam-state-${state.currentExam.studentId}-${state.currentExam.token}`;
        localStorage.setItem(storageKey, JSON.stringify(state.currentExam));

        renderQuestionNav();

        // Update Live Monitoring
        if (isDuringExam && state.currentExam) {
            const answeredCount = state.currentExam.answers.filter(a => a.answer !== null).length;
            const sessionRef = db.ref(`/examSessions/${state.currentExam.studentId}_${state.currentExam.subjectId}`);
            sessionRef.update({
                progress: answeredCount,
                answers: state.currentExam.answers,
                lastUpdate: firebase.database.ServerValue.TIMESTAMP
            }).catch(err => console.error("Gagal lapor progress:", err));
        }
    }
}            


async function handleRaguRaguAndNext() {
    const { currentQuestionIndex, answers } = state.currentExam;
    answers[currentQuestionIndex].isDoubtful = true;
    await navigateQuestion('next');
}
async function navigateQuestion(direction) {
        saveCurrentAnswer();
        // --- INI YANG DIUBAH ---
        const { questionIDs, currentQuestionIndex } = state.currentExam;
        let newIndex = currentQuestionIndex;
        
        // --- DAN INI YANG DIUBAH ---
        if (direction === 'next' && currentQuestionIndex < questionIDs.length - 1) newIndex++;
        else if (direction === 'prev' && currentQuestionIndex > 0) newIndex--;
        
        await jumpToQuestion(newIndex);
    }
function startTimer(minutes) {
    if (state.examTimer) clearInterval(state.examTimer);
    let seconds = Math.floor(minutes * 60);
    const timerEl = $('#timer');
    const updateTimerDisplay = () => {
        const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        timerEl.textContent = `${h}:${m}:${s}`;
    };
    updateTimerDisplay();
    state.examTimer = setInterval(() => {
        if (seconds <= 0) {
            clearInterval(state.examTimer);
            timerEl.classList.add('animate-pulse');
            finishExam(true, 'timeup');
            return;
        }
        seconds--;
        state.currentExam.remainingSeconds = seconds;
        updateTimerDisplay();
    }, 1000);
}

async function finishExam(isAutoSubmit = false, reason = "Selesai") {
    // HANYA simpan jawaban terakhir. JANGAN matikan timer atau listener dulu.
    saveCurrentAnswer(); 

    let notificationMessage = ""; 
    if(reason === "cheat") {
        notificationMessage = `UJIAN DIHENTIKAN: Anda telah melampaui batas pelanggaran (${state.currentExam.cheatAttempts} kali). Skor Anda telah disimpan.`;
    } else if (reason === "timeup") {
        notificationMessage = `WAKTU HABIS: Waktu ujian telah habis. Skor Anda telah disimpan.`;
    } else if (reason === 'cheat_resume') {
        notificationMessage = `UJIAN DIHENTIKAN: Ujian ini dihentikan karena pelanggaran sebelumnya. Skor Anda telah disimpan.`;
    }

    // "submitLogic" adalah apa yang terjadi SETELAH "OK" diklik.
    // Di sinilah kita mematikan semuanya.
    const submitLogic = async () => {
        hideModal(false); 
        showLoader();

        // --- INILAH LOGIKA PEMBERSIHAN YANG BENAR ---
        isDuringExam = false; // Hentikan semua proses 'anti-cheat'
        clearInterval(state.examTimer); // Hentikan timer
        if (state.examHeartbeat) clearInterval(state.examHeartbeat); // Hentikan laporan heartbeat
        removeAntiCheatListeners(); // Hapus listener (blur, focus, dll)
        
        // Hapus sesi live HANYA SETELAH "OK" DIKLIK
        if (state.currentExam) {
            const sessionRef = db.ref(`/examSessions/${state.currentExam.studentId}_${state.currentExam.subjectId}`);
            // Kita tidak perlu 'await' ini, biarkan berjalan di background
            sessionRef.remove().catch(e => console.error("Gagal hapus sesi:", e)); 
        }
        // --- AKHIR LOGIKA PEMBERSIHAN ---

        const { studentId, subjectId, token, answers, cheatAttempts, startTime } = state.currentExam;
        
        // Kirim hasil ujian ke backend (code.gs)
        const res = await apiCall('saveResult', { studentId, subjectId, token, answers, cheatAttempts, startTime });
        
        if (res.success) {
            clearExamStateFromLocalStorage();
            
            // Tampilkan halaman skor (kode lama Anda)
            $('#final-score').textContent = parseFloat(res.data.score).toFixed(1);
            const scoreMessageEl = $('#score-message'); 
            
            if (notificationMessage) {
                scoreMessageEl.textContent = notificationMessage;
                scoreMessageEl.classList.add('text-yellow-300');
                scoreMessageEl.classList.remove('hidden');
            } else if (res.data.hasEssays) {
                scoreMessageEl.textContent = "*Ini adalah skor sementara. Nilai esai akan dikoreksi manual.";
                scoreMessageEl.classList.remove('hidden');
            } else {
                scoreMessageEl.textContent = "";
                scoreMessageEl.classList.add('hidden');
            }

            navigateTo('page-result'); 
            state.currentExam = null;
        }
        // Jika 'res.success' false, 'apiCall' akan menampilkan error
        // Siswa akan tetap di halaman (dengan loader hilang) dan bisa mencoba 'submit' lagi
        // Ini lebih baik daripada terjebak.
    };

    if (isAutoSubmit) {
        // Auto-submit (waktu habis / curang) langsung menjalankan submitLogic
        await submitLogic();
        if (state.currentPage !== 'page-result') {
            // Fallback jika 'saveResult' gagal saat auto-submit
            clearExamStateAndLogout();
        }
    } else {
        // Submit manual (siswa klik tombol)
        // Tampilkan modal konfirmasi
        const unanswered = state.currentExam.answers.filter(a => a.answer === null).length;
        const message = `Anda yakin ingin menyelesaikan ujian? ${unanswered > 0 ? `Masih ada ${unanswered} soal yang belum dijawab.` : ''}`;
        
        // Tampilkan modal. 'submitLogic' hanya berjalan jika "OK" diklik.
        // Jika "Batal" diklik, 'hideModal' standar akan berjalan,
        // timer dan listener tidak pernah berhenti, dan siswa kembali ke ujian.
        showModal('Konfirmasi Selesai Ujian', `<p>${message}</p>`, submitLogic, { actionText: 'Ya, Selesaikan' });
    }
}

function saveExamStateToLocalStorage() {
    if (state.currentExam) {
        const storageKey = `cbt-exam-state-${state.currentExam.studentId}-${state.currentExam.token}`;
        localStorage.setItem(storageKey, JSON.stringify(state.currentExam));
    }
}
function clearExamStateFromLocalStorage() {
    if (state.currentExam) {
        const storageKey = `cbt-exam-state-${state.currentExam.studentId}-${state.currentExam.token}`;
        localStorage.removeItem(storageKey);
    }
}
function clearExamStateAndLogout() {
    isDuringExam = false;
    clearExamStateFromLocalStorage();
    navigateTo('page-landing');
    location.reload();
}


// GANTI SELURUH FUNGSI 'handleViewStudentResult' LAMA ANDA DENGAN INI:
function handleViewStudentResult(resultId) {
    const result = state.results.find(r => r.id === resultId);
    if (!result) return;
    
    // Siapkan data yang dibutuhkan oleh 'pabrik'
    const scoringRules = JSON.parse(state.currentSubject.scoringRules || '{}');
    const questionsMap = new Map(state.questions.map(q => [q.id, q]));

    // 1. Panggil "Pabrik" untuk membuat HTML inti
    let contentHtml = generateStudentDossierHtml(result, questionsMap, scoringRules);

    // 2. Tambahkan Tombol Cetak (hanya untuk modal ini)
    const printButtonHtml = `
        <button 
            type="button" 
            onclick="printStudentDossier('${result.studentName}', '${state.currentSubject.name}')"
            class="print-dossier-btn neon-glow-button font-bold py-2 px-4 rounded-lg w-full mb-4">
            <i class="fas fa-print mr-2"></i> Cetak Berkas Siswa Ini
        </button>
    `;

    // 3. Gabungkan tombol cetak dan HTML inti
    contentHtml = printButtonHtml + contentHtml;

    // 4. Tampilkan Modal (logika ini sama seperti sebelumnya)
    const onSaveCallback = () => {
        hideModal();
        switchSubjectTab('results'); 
    };
    const onCancelCallback = () => {
        hideModal();
        switchSubjectTab('results');
    };

    showModal(`Hasil Jawaban: ${result.studentName}`, contentHtml, onSaveCallback, { 
        actionText: 'Tutup', 
        hideCancel: true, 
        onCancel: onCancelCallback 
    });
}

function setupMatchingQuestion(savedPairs) {
    const container = $('#matching-container');
    if (!container) return;
    const { answers, currentQuestionIndex } = state.currentExam;
    const answerData = answers[currentQuestionIndex];
    answerData.pairs = savedPairs || [];
    container.addEventListener('click', handleMatchingClick);
    setTimeout(() => drawMatchingLines(answerData.pairs), 100);
    if(state.matchingState.resizeObserver) state.matchingState.resizeObserver.disconnect();
    state.matchingState.resizeObserver = new ResizeObserver(() => drawMatchingLines(answerData.pairs || []));
    state.matchingState.resizeObserver.observe(container);
}
function handleMatchingClick(event) {
    const item = event.target.closest('.matching-item');
    if (!item) return;
    const { answers, currentQuestionIndex } = state.currentExam;
    const answerData = answers[currentQuestionIndex];
    const side = item.dataset.side;
    const index = parseInt(item.dataset.index);
    if (side === 'left') {
        state.matchingState.selectedLeftIndex = index;
    } else if (side === 'right' && state.matchingState.selectedLeftIndex !== null) {
        answerData.pairs = answerData.pairs.filter(p => 
            p.leftIndex !== state.matchingState.selectedLeftIndex && p.rightIndex !== index
        );
        answerData.pairs.push({ leftIndex: state.matchingState.selectedLeftIndex, rightIndex: index });
        state.matchingState.selectedLeftIndex = null;
        saveCurrentAnswer();
    }
    updateMatchingSelection();
    drawMatchingLines(answerData.pairs);
}
function updateMatchingSelection() {
    $$('.matching-item').forEach(el => el.classList.remove('selected'));
    if (state.matchingState.selectedLeftIndex !== null) {
        $(`#matching-left .matching-item[data-index="${state.matchingState.selectedLeftIndex}"]`)?.classList.add('selected');
    }
}
// GANTI FUNGSI 'drawMatchingLines' YANG LAMA DENGAN INI
function drawMatchingLines(pairs = []) {
    const canvas = $('#matching-canvas');
    const container = $('#matching-container');
    if (!canvas || !container) return;

    const ctx = canvas.getContext('2d');
    const rect = container.getBoundingClientRect();

    // Sesuaikan ukuran canvas dengan container
    canvas.width = rect.width;
    canvas.height = rect.height;

    // Bersihkan canvas sebelum menggambar ulang
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    pairs.forEach(pair => {
        const leftEl = $(`#matching-left .matching-item[data-index="${pair.leftIndex}"]`);
        const rightEl = $(`#matching-right .matching-item[data-index="${pair.rightIndex}"]`);

        if (leftEl && rightEl) {
            const leftRect = leftEl.getBoundingClientRect();
            const rightRect = rightEl.getBoundingClientRect();

            // Hitung titik koordinat relatif terhadap container
            const startX = leftRect.right - rect.left;
            const startY = leftRect.top - rect.top + leftRect.height / 2;
            const endX = rightRect.left - rect.left;
            const endY = rightRect.top - rect.top + rightRect.height / 2;

            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);

            // --- [BAGIAN PERUBAHAN WARNA] ---
            
            // 1. Warna Garis Utama (Kuning Terang)
            ctx.strokeStyle = '#facc15'; // (Hex untuk Yellow-400)
            
            // Jika ingin warna PUTIH, ganti kode di atas menjadi: 
            // ctx.strokeStyle = '#ffffff';

            // 2. Ketebalan Garis
            ctx.lineWidth = 3; // Sedikit lebih tebal agar jelas
            ctx.lineCap = 'round'; // Ujung garis membulat agar rapi

            // 3. Efek Glow / Bersinar
            ctx.shadowColor = '#eab308'; // Warna pendaran (Yellow-500)
            // Jika warna putih, ganti shadowColor jadi '#ffffff' juga
            
            ctx.shadowBlur = 15; // Kekuatan cahaya (makin besar makin menyebar)
            // --------------------------------

            ctx.stroke();
        }
    });
}
// TAMBAHKAN FUNGSI BARU INI DI ATAS triggerCheatWarning

/**
 * INI ADALAH "OTAK" PELANGGARAN YANG BARU
 * Fungsi ini dipanggil oleh tombol 'Back' DAN ganti tab.
 */
function handleViolation(reason = "Melakukan aktivitas mencurigakan") {
    // Cek ganda: Kalau ujian belum mulai atau sudah selesai, jangan hukum
    if (!state.currentExam || state.currentExam.isFinished) return;

    // 1. Tambah Counter Pelanggaran
    state.currentExam.cheatAttempts = (state.currentExam.cheatAttempts || 0) + 1;
    
    // 2. Lapor ke Server (Firebase Live Monitoring)
    // Agar guru melihat status merah detik itu juga
    const sessionPath = `/examSessions/${state.currentExam.studentId}_${state.currentExam.subjectId}`;
    db.ref(sessionPath).update({
        cheatAttempts: state.currentExam.cheatAttempts,
        isFocus: false, 
        lastUpdate: firebase.database.ServerValue.TIMESTAMP
    });

    // 3. SIMPAN KE MEMORI HP (WAJIB ADA!)
    // Ini kuncinya agar saat reload, jumlah pelanggaran TIDAK RESET ke 0
    const storageKey = `cbt-exam-state-${state.currentExam.studentId}-${state.currentExam.token}`;
    localStorage.setItem(storageKey, JSON.stringify(state.currentExam));

    // 4. Tampilkan Peringatan di Layar (Pop-up Merah)
    // Kita gunakan fungsi triggerCheatWarning yang Anda punya
    if (typeof triggerCheatWarning === 'function') {
        triggerCheatWarning();
    } else {
        // Fallback jika fungsi trigger tidak ada
        showNotification('PERINGATAN!', reason, 'error');
    }

    // 5. Cek Batas Hukuman
    const limit = parseInt(state.currentExam.subject.violationLimit) || 3;
    
    if (limit > 0 && state.currentExam.cheatAttempts >= limit) {
        // --- [PERBAIKAN DISINI] ---
        // Jika limit tercapai, BEKUKAN. Jangan dihapus.
        lockExam(); 
    }
}

let cheatWarningTimeout;
let cheatWarningInterval;
// HAPUS FUNGSI triggerCheatWarning LAMA ANDA DAN GANTI DENGAN INI

const triggerCheatWarning = () => {
    // Fungsi ini sekarang HANYA mengurus tampilan pop-up timer.
    
    // --- INI ADALAH PERBAIKANNYA ---
    // 1. SELALU HAPUS timer lama, apa pun yang terjadi, di awal.
    clearTimeout(cheatWarningTimeout);
    clearInterval(cheatWarningInterval);
    // --- AKHIR PERBAIKAN ---

    // 2. Tampilkan/Perbarui teks (Kita tidak perlu 'if (active)' lagi)
    $('#cheat-warning').classList.add('active');
    if (state.currentExam) { // Tambahkan cek keamanan jika state.currentExam ada
        $('#cheat-count-display').textContent = `Jumlah Pelanggaran: ${state.currentExam.cheatAttempts}`;
    }
    
    let countdown = 5; 
    const timerDisplay = $('#cheat-timer-display');
    timerDisplay.textContent = `Peringatan akan ditutup dalam ${countdown} detik...`;
    
    $('#cheat-warning').classList.remove('hidden');

    // 3. Buat Interval BARU untuk update timer
    cheatWarningInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
            timerDisplay.textContent = `Peringatan akan ditutup dalam ${countdown} detik...`;
        }
    }, 1000);

    // 4. Buat Timeout BARU untuk menyembunyikan pop-up
    cheatWarningTimeout = setTimeout(() => {
        clearInterval(cheatWarningInterval); 
        $('#cheat-warning').classList.add('hidden');
        $('#cheat-warning').classList.remove('active');
        timerDisplay.textContent = ''; 
    }, 5000); // Selalu 5 detik penuh
};
const handleVisibilityChange = () => {
    if (document.hidden) {
        handleViolation();
    }
};
const handleFullscreenChange = () => {
        if (!document.fullscreenElement) {
            handleViolation();
    }
};
const preventCopyPaste = (e) => {
        if (e.ctrlKey && ['c', 'v', 'x', 'u', 'p'].includes(e.key.toLowerCase())) {
            e.preventDefault();
            showNotification('Aksi Diblokir', 'Menyalin dan menempel tidak diizinkan selama ujian.', 'error');
    }
};
const preventContextMenu = (e) => e.preventDefault();
function addAntiCheatListeners() {
    if (!state.currentExam) return;
    state.currentExam.cheatAttempts = state.currentExam.cheatAttempts || 0;
    
    document.addEventListener('visibilitychange', handleVisibilityChange);
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('contextmenu', preventContextMenu);
    document.addEventListener('keydown', preventCopyPaste);

    // --- LOGIKA BARU YANG LEBIH RAPI ---
    
    // 1. Definisikan fungsi listener-nya
    state.examBlurListener = () => {
        if (!state.currentExam || !isDuringExam) return;
        const sessionRef = db.ref(`/examSessions/${state.currentExam.studentId}_${state.currentExam.subjectId}`);
        sessionRef.update({ isFocus: false });
    };
    state.examFocusListener = () => {
        if (!state.currentExam || !isDuringExam) return;
        const sessionRef = db.ref(`/examSessions/${state.currentExam.studentId}_${state.currentExam.subjectId}`);
        sessionRef.update({ isFocus: true });
    };
    
    // 2. Tambahkan listener menggunakan referensi yang disimpan
    window.addEventListener('blur', state.examBlurListener);
    window.addEventListener('focus', state.examFocusListener);
}
function removeAntiCheatListeners() {
    document.removeEventListener('visibilitychange', handleVisibilityChange);
    document.removeEventListener('fullscreenchange', handleFullscreenChange);
    document.removeEventListener('contextmenu', preventContextMenu);
    document.removeEventListener('keydown', preventCopyPaste);
    
    // --- LOGIKA BARU (YANG SEBENARNYA) ---
    // Hapus listener 'blur' dan 'focus' menggunakan referensi yang disimpan
    if (state.examBlurListener) {
        window.removeEventListener('blur', state.examBlurListener);
        state.examBlurListener = null; // Bersihkan state
    }
    if (state.examFocusListener) {
        window.removeEventListener('focus', state.examFocusListener);
        state.examFocusListener = null; // Bersihkan state
    }
    // --- AKHIR LOGIKA BARU ---
    
    if(document.fullscreenElement) document.exitFullscreen();
}

// FUNGSI LOAD GAMBAR (KOSONG - KARENA KITA SUDAH PAKAI <IMG SRC>)
function loadDynamicImages() {
 // Fungsi ini sengaja dibiarkan kosong.
 // Kita tidak lagi menggunakan <div> data-src,
 // kita langsung menggunakan <img> src di renderQuestionCard/renderCurrentQuestion.
}

// FUNGSI PREVIEW MEDIA (KEMBALI KE VERSI DRIVE LANGSUNG)
function previewMediaInNewTab(fileId) {
    const url = buildDriveUrl(fileId);
    window.open(url, '_blank');
}

// --- HOOKS ---
const originalNavigateTo = navigateTo;
navigateTo = (pageId, params = null) => {
    originalNavigateTo(pageId, params);
    if (pageId === 'page-siswa-login') {
        populateKelasSelect();
    }
};

// TAMBAHKAN FUNGSI JAVASCRIPT BARU INI
async function saveEssayGrade(resultId, questionId, subjectId) {
    const inputEl = $(`#essay-score-${questionId}`);
    const points = parseFloat(inputEl.value);

    if (isNaN(points)) {
        showNotification('Error', 'Harap masukkan angka yang valid untuk poin.', 'error');
        return;
    }

    const res = await apiCall('saveEssayGrade', { resultId, questionId, points });

    if (res.success) {
        // Tampilkan notifikasi sukses
        showNotification('Sukses', `Skor berhasil disimpan. Skor akhir baru: ${res.data.newScore.toFixed(1)}`, 'success');
        
        // Tutup modal
        hideModal(false); // false agar event handler tidak di-reset
        
        // Muat ulang tab hasil ujian untuk menampilkan skor baru
        switchSubjectTab('results');
    }
    // Pesan error akan ditangani otomatis oleh apiCall
}

/**
 * FUNGSI CETAK SATUAN (DENGAN WARNA LENGKAP)
 */
function printStudentDossier(studentName, subjectName) {
    const modalBody = $('#modal-body').cloneNode(true);
    
    // Bersihkan elemen yang tidak perlu dicetak
    modalBody.querySelectorAll('.essay-grading-form').forEach(el => el.remove());
    modalBody.querySelectorAll('.print-dossier-btn').forEach(el => el.remove());
    
    const printContent = modalBody.innerHTML;
    const printWindow = window.open('', '', 'height=800,width=800');
    
    printWindow.document.write('<html><head><title>Berkas Ujian Siswa</title>');
    
    // --- CSS KHUSUS CETAK (UPDATE WARNA DI SINI) ---
    printWindow.document.write(`
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; color: #000; }
            p { margin: 4px 0; }
            
            /* Kop Surat & Header */
            .kop-surat { display: flex; align-items: center; border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 20px; }
            .kop-surat .logo { width: 80px; height: 80px; object-fit: contain; }
            .kop-surat .teks-kop { text-align: center; flex-grow: 1; padding: 0 15px; }
            .kop-surat .teks-kop h3, .kop-surat .teks-kop p { margin: 0; line-height: 1.4; }
            h1, h2 { text-align: center; margin: 10px 0; }
            h1 { font-size: 16pt; } h2 { font-size: 14pt; }
            .student-header { font-size: 13pt; margin-top: 30px; border-bottom: 2px solid #000; padding-bottom: 5px; font-weight: bold; }

            /* Layout Kartu Soal */
            .p-3.rounded-lg.border { border: 1px solid #ccc !important; padding: 10px; margin-bottom: 15px; page-break-inside: avoid; border-radius: 8px; }
            .flex { display: flex; justify-content: space-between; align-items: flex-start; }
            .text-right { text-align: right; }
            .font-bold { font-weight: bold; }
            .text-xs { font-size: 10pt; } .text-sm { font-size: 11pt; }
            .mb-1 { margin-bottom: 4px; } .mb-2 { margin-bottom: 8px; } .mb-3 { margin-bottom: 12px; }
            .whitespace-pre-wrap { white-space: pre-wrap; }
            
            /* Grid Jawaban (Siswa vs Kunci) */
            .grid { display: table; width: 100%; margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px; }
            .grid > div { display: table-cell; width: 50%; vertical-align: top; padding: 5px; }
            .text-gray-400 { color: #555 !important; font-style: italic; font-size: 9pt; }
            
            /* --- DEFINISI WARNA (PENTING) --- */
            /* Agar background berwarna saat diprint */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

            /* 1. HIJAU (BENAR) */
            .bg-green-500\\/20 { background-color: #d1e7dd !important; border-color: #badbcc !important; }
            .text-green-400 { color: #0f5132 !important; } /* Teks Hijau Gelap */
            .border-green-500 { border-color: #0f5132 !important; }

            /* 2. MERAH (SALAH) */
            .bg-red-500\\/20 { background-color: #f8d7da !important; border-color: #f5c6cb !important; }
            .text-red-400 { color: #842029 !important; } /* Teks Merah Gelap */
            .border-red-500 { border-color: #842029 !important; }

            /* 3. KUNING (SEBAGIAN / RAGU) - BARU */
            .bg-yellow-500\\/20 { background-color: #fff3cd !important; border-color: #ffecb5 !important; }
            .text-yellow-400 { color: #664d03 !important; } /* Teks Kuning Gelap (Kecoklatan) */
            .border-yellow-500 { border-color: #664d03 !important; }
            .text-yellow-300 { color: #000 !important; background: #fff3cd; padding: 2px 5px; border-radius: 4px; border: 1px solid #ffe69c; } /* Label Ragu */

            /* 4. BIRU (ESAI) - BARU */
            .bg-blue-500\\/20 { background-color: #cff4fc !important; border-color: #b6effb !important; }
            .text-blue-300 { color: #055160 !important; } /* Teks Biru Gelap */
            .border-blue-500 { border-color: #055160 !important; }

            /* Elemen Lain */
            .text-white { color: #000 !important; } /* Jawaban siswa jadi hitam */
            .bg-black\\/40, .bg-black\\/20 { background: none !important; } /* Hapus background gelap badge */
            .border-white\\/20, .border-white\\/10 { border: none !important; }
            
            /* Sembunyikan ikon fontawesome jika tidak terload (opsional) */
            .fas { display: inline-block; margin-right: 5px; }

            /* Tanda Tangan */
            .signature-container { margin-top: 50px; display: flex; justify-content: space-between; page-break-inside: avoid; }
            .signature-block { width: 40%; text-align: center; }
            .signature-block .name { font-weight: bold; text-decoration: underline; }
        </style>
    `);
    
    printWindow.document.write('</head><body>');
    
    // Kop Surat
    printWindow.document.write(`
        <div class="kop-surat">
            <img src="https://raw.githubusercontent.com/xiroro-ab/smp58dataguru/refs/heads/main/Logo_Palembang.png" alt="Logo Kiri" class="logo">
            <div class="teks-kop">
                <h3>PEMERINTAH KOTA PALEMBANG</h3>
                <h3>DINAS PENDIDIKAN</h3>
                <h3 style="font-size: 1.2em; font-weight: bold;">SMP NEGERI 58 PALEMBANG</h3>
                <p style="font-size: 0.9em;">Jl. Komering II, Kel. Demang Lebar Daun, Kec. Ilir Barat I, Kota Palembang 30137</p>
                <p style="font-size: 0.9em;">Email: palembangsmpn58@gmail.com</p>
            </div>
            <img src="https://raw.githubusercontent.com/xiroro-ab/smp58dataguru/refs/heads/main/logo58.png" alt="Logo Kanan" class="logo">
        </div>
    `);

    printWindow.document.write(`<h1>BERKAS HASIL UJIAN SISWA</h1>`);
    printWindow.document.write(`<h2>Mata Pelajaran: ${subjectName}</h2>`);
    printWindow.document.write(`<h3 class="student-header">Nama Siswa: ${studentName}</h3>`);
    
    printWindow.document.write(printContent);
    
    // Tanda Tangan
    const tanggalCetak = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    printWindow.document.write(`
        <div class="signature-container">
            <div class="signature-block">
                <p>Mengetahui,</p>
                <p>Kepala SMPN 58 Palembang</p>
                <br><br><br><br><br>
                <p class="name">Maya Erniwaty Manalu, S.Pd.</p>
                <p>NIP. 196803151992032011</p>
            </div>
            <div class="signature-block">
                <p>Palembang, ${tanggalCetak}</p>
                <p>Guru Mata Pelajaran</p>
                <br><br><br><br><br>
                <p class="name">Aris Bermansyah, S.Kom</p>
                <p>NIPPPK. 199611142024211010</p>
            </div>
        </div>
    `);
    
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => { printWindow.print(); }, 1000);
}

/**
 * FUNGSI HELPER (PABRIK HTML) v3 - DENGAN POIN DETAIL & WARNA KUNING
 */
function generateStudentDossierHtml(result, questionsMap, scoringRules) {
    const getScoreForType = (type) => parseFloat(scoringRules[type] || 1);
    let contentHtml = '<div class="space-y-4">'; 

    if (result.cheatAttempts > 0) {
        contentHtml += `<div class="p-3 rounded-lg border border-yellow-500/50 bg-yellow-500/20 text-center"><i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i>Siswa ini meninggalkan halaman ujian sebanyak <strong>${result.cheatAttempts}</strong> kali.</div>`;
    }

    const safeAnswers = Array.isArray(result.answers) ? result.answers : [];
    
    // Urutkan jawaban berdasarkan urutan soal dibuat
    const sortedAnswers = [...safeAnswers].sort((a, b) => {
        const questionA = questionsMap.get(a.questionId);
        const questionB = questionsMap.get(b.questionId);
        const timeA = (questionA && questionA.createdAt) ? questionA.createdAt : 0;
        const timeB = (questionB && questionB.createdAt) ? questionB.createdAt : 0;
        return timeA - timeB; 
    });

    sortedAnswers.forEach((studentAnswerObj, index) => {
        const q = questionsMap.get(studentAnswerObj.questionId);
        if (!q) return;

        const studentAnswerRaw = studentAnswerObj.answer;
        const correctAnswer = q.answer;
        const maxPoints = getScoreForType(q.type);
        
        // --- 1. HITUNG POIN YANG DIDAPAT (LOGIKA FRONTEND) ---
        let earnedPoints = 0;
        let statusColor = 'red'; // red, yellow, green, blue (esai)

        if (q.type === 'Esai') {
             // Untuk Esai, ambil dari nilai yang sudah disimpan guru
             earnedPoints = (result.essayScores && result.essayScores[q.id]) ? parseFloat(result.essayScores[q.id]) : 0;
             statusColor = 'blue';
        } else {
            // Hitung otomatis untuk tipe lain
            try {
                // A. PILIHAN GANDA & BENAR/SALAH (Mutlak)
                if (['Pilihan Ganda', 'Benar/Salah'].includes(q.type)) {
                    if (studentAnswerRaw && correctAnswer && studentAnswerRaw.toString().trim() === correctAnswer.toString().trim()) {
                        earnedPoints = maxPoints;
                    }
                }
                // B. ISIAN SINGKAT (Mutlak dengan variasi)
                else if (q.type === 'Isian Singkat') {
                    if (studentAnswerRaw) {
                        const userAns = studentAnswerRaw.toString().toLowerCase().trim();
                        // Cek apakah array jawaban mengandung jawaban siswa
                        if (Array.isArray(correctAnswer)) {
                             if (correctAnswer.map(a => a.toLowerCase().trim()).includes(userAns)) earnedPoints = maxPoints;
                        } else if (correctAnswer.toString().toLowerCase().trim() === userAns) {
                            earnedPoints = maxPoints;
                        }
                    }
                }
                // C. PILIHAN GANDA KOMPLEKS (Sistem Denda)
                else if (q.type === 'Pilihan Ganda Kompleks') {
                    if (Array.isArray(studentAnswerRaw) && Array.isArray(correctAnswer) && correctAnswer.length > 0) {
                        const correctSet = new Set(correctAnswer);
                        const pointsPerItem = maxPoints / correctSet.size;
                        let tempScore = 0;
                        studentAnswerRaw.forEach(ans => {
                            if (correctSet.has(ans)) tempScore += pointsPerItem; // Benar (+ poin)
                            else tempScore -= pointsPerItem; // Salah (- denda)
                        });
                        earnedPoints = Math.max(0, tempScore); // Tidak boleh minus
                    }
                }
                // D. MENJODOHKAN (Proporsional)
                else if (q.type === 'Menjodohkan') {
                    if (Array.isArray(studentAnswerRaw) && Array.isArray(q.options) && q.options.length > 0) {
                        let correctCount = 0;
                        studentAnswerRaw.forEach(ans => {
                            const qIndex = ans.questionItem.charCodeAt(0) - 65;
                            // Cek pasangan
                            if (q.options[qIndex] && q.options[qIndex].a && q.options[qIndex].a.text === ans.answerItem) {
                                correctCount++;
                            }
                        });
                        // Rumus: (Benar / Total Soal) * Max Poin
                        earnedPoints = (correctCount / q.options.length) * maxPoints;
                    }
                }
            } catch (e) { console.error("Error calculating score for view", e); }

            // Tentukan Warna Kartu berdasarkan Poin
            if (earnedPoints === maxPoints) statusColor = 'green'; // Sempurna
            else if (earnedPoints > 0) statusColor = 'yellow'; // Sebagian
            else statusColor = 'red'; // Salah Total
        }

        // --- 2. FORMAT TAMPILAN JAWABAN TEKS ---
        let studentAnswerDisplay = '(Tidak Dijawab)';
        let correctAnswerDisplay = '(Lihat Kunci)';

        try {
            // Format Jawaban Siswa
            if (studentAnswerRaw !== null && studentAnswerRaw !== undefined && studentAnswerRaw.length !== 0) {
                if (q.type === 'Pilihan Ganda' && typeof studentAnswerRaw === 'string') {
                    const answerIndex = studentAnswerRaw.charCodeAt(0) - 65;
                    const opt = (q.options || [])[answerIndex];
                    studentAnswerDisplay = `${studentAnswerRaw}. ${opt ? opt.text : ''}`;
                } else if (q.type === 'Pilihan Ganda Kompleks' && Array.isArray(studentAnswerRaw)) {
                    studentAnswerDisplay = studentAnswerRaw.map(letter => {
                        const answerIndex = letter.charCodeAt(0) - 65;
                        const opt = (q.options || [])[answerIndex];
                        return `${letter}. ${opt ? opt.text : ''}`;
                    }).join('<br>');
                } else if (q.type === 'Menjodohkan' && Array.isArray(studentAnswerRaw)) {
                    studentAnswerDisplay = studentAnswerRaw.map(ans => `${ans.questionItem}  ${ans.answerItem}`).join('<br>');
                } else {
                    studentAnswerDisplay = Array.isArray(studentAnswerRaw) ? studentAnswerRaw.join('; ') : studentAnswerRaw.toString();
                }
            }

            // Format Kunci Jawaban (Untuk Referensi Guru)
            if (q.type === 'Menjodohkan') {
                 correctAnswerDisplay = (q.options || []).map((pair, idx) => {
                    return `${String.fromCharCode(65 + idx)}  ${pair.a.text || ''}`;
                }).join('<br>');
            } else if (['Pilihan Ganda', 'Pilihan Ganda Kompleks'].includes(q.type)) {
                 // Logika mirip siswa
                 if (typeof correctAnswer === 'string') {
                    const idx = correctAnswer.charCodeAt(0) - 65;
                    correctAnswerDisplay = `${correctAnswer}. ${(q.options[idx]||{}).text || ''}`;
                 } else if (Array.isArray(correctAnswer)) {
                    correctAnswerDisplay = correctAnswer.map(l => {
                        const idx = l.charCodeAt(0) - 65;
                        return `${l}. ${(q.options[idx]||{}).text || ''}`;
                    }).join('<br>');
                 }
            } else {
                correctAnswerDisplay = Array.isArray(correctAnswer) ? correctAnswer.join('; ') : (correctAnswer || '-');
            }

        } catch (e) { studentAnswerDisplay = 'Error displaying answer'; }

        // --- 3. RENDER KARTU HTML ---
        
        // Kelas CSS berdasarkan statusColor
        let cardClass = '', iconHtml = '';
        if (statusColor === 'green') {
            cardClass = 'bg-green-500/20 border-green-500';
            iconHtml = '<span class="text-green-400 font-bold"><i class="fas fa-check-circle"></i> Benar</span>';
        } else if (statusColor === 'yellow') {
            cardClass = 'bg-yellow-500/20 border-yellow-500';
            iconHtml = '<span class="text-yellow-400 font-bold"><i class="fas fa-exclamation-circle"></i> Sebagian</span>';
        } else if (statusColor === 'blue') { // Esai
            cardClass = 'bg-blue-500/20 border-blue-500';
            iconHtml = '<span class="text-blue-300 font-bold"><i class="fas fa-pen"></i> Esai</span>';
        } else {
            cardClass = 'bg-red-500/20 border-red-500';
            iconHtml = '<span class="text-red-400 font-bold"><i class="fas fa-times-circle"></i> Salah</span>';
        }

        const isDoubtfulHtml = studentAnswerObj.isDoubtful ? '<span class="text-xs font-semibold px-2 py-0.5 bg-yellow-500/20 text-yellow-300 rounded-full ml-2">Ragu</span>' : '';

        contentHtml += `
            <div class="p-3 rounded-lg border ${cardClass} relative">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center">
                        <span class="font-bold mr-2">Soal #${index + 1}</span>
                        ${iconHtml}
                        ${isDoubtfulHtml}
                    </div>
                    <div class="text-right">
                        <span class="text-xs font-bold px-2 py-1 rounded bg-black/40 border border-white/20">
                            Poin: ${parseFloat(earnedPoints).toFixed(1)} / ${maxPoints}
                        </span>
                    </div>
                </div>
                
                <div class="text-sm mb-3 whitespace-pre-wrap">${q.text || ''}</div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs bg-black/20 p-2 rounded">
                    <div>
                        <p class="text-gray-400 mb-1">Jawaban Siswa:</p>
                        <div class="font-bold text-white">${studentAnswerDisplay}</div>
                    </div>
                    <div class="border-l border-white/10 pl-0 md:pl-4 pt-2 md:pt-0 border-t md:border-t-0">
                        <p class="text-gray-400 mb-1">Kunci / Referensi:</p>
                        <div class="font-bold text-green-400">${correctAnswerDisplay}</div>
                    </div>
                </div>
            </div>
        `;
    });

    contentHtml += `</div>`;
    return contentHtml;
}

/**
 * FUNGSI CETAK MASSAL (UPDATE WARNA KUNING & BIRU)
 */
async function handleBulkPrintDossier() {
    const filteredResults = state.resultClassFilter === 'all'
        ? state.results
        : state.results.filter(r => r.class.toString().trim() === state.resultClassFilter);

    if (filteredResults.length === 0) {
        showNotification('Info', 'Tidak ada data siswa di kelas ini untuk dicetak.', 'info');
        return;
    }

    const scoringRules = JSON.parse(state.currentSubject.scoringRules || '{}');
    const questionsMap = new Map(state.questions.map(q => [q.id, q]));
    
    showLoader(); 
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write('<html><head><title>Berkas Ujian Massal</title>');
    
    // --- COPY CSS YANG SAMA DENGAN FUNGSI DI ATAS ---
    printWindow.document.write(`
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; color: #000; }
            p { margin: 4px 0; }
            
            .kop-surat { display: flex; align-items: center; border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 20px; }
            .kop-surat .logo { width: 80px; height: 80px; object-fit: contain; }
            .kop-surat .teks-kop { text-align: center; flex-grow: 1; padding: 0 15px; }
            .kop-surat .teks-kop h3, .kop-surat .teks-kop p { margin: 0; line-height: 1.4; }
            
            h1, h2 { text-align: center; margin: 10px 0; }
            h1 { font-size: 16pt; } h2 { font-size: 14pt; }
            .student-header { font-size: 13pt; margin-top: 30px; border-bottom: 2px solid #000; padding-bottom: 5px; font-weight: bold; page-break-inside: avoid; }
            .page-break { page-break-after: always; }

            /* Layout Kartu */
            .p-3.rounded-lg.border { border: 1px solid #ccc !important; padding: 10px; margin-bottom: 15px; page-break-inside: avoid; border-radius: 8px; }
            .flex { display: flex; justify-content: space-between; align-items: flex-start; }
            .text-right { text-align: right; }
            .font-bold { font-weight: bold; }
            .text-xs { font-size: 10pt; } .text-sm { font-size: 11pt; }
            .mb-1 { margin-bottom: 4px; } .mb-2 { margin-bottom: 8px; } .mb-3 { margin-bottom: 12px; }
            .whitespace-pre-wrap { white-space: pre-wrap; }
            
            .grid { display: table; width: 100%; margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px; }
            .grid > div { display: table-cell; width: 50%; vertical-align: top; padding: 5px; }
            .text-gray-400 { color: #555 !important; font-style: italic; font-size: 9pt; }

            /* --- WARNA CETAK --- */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

            /* Hijau */
            .bg-green-500\\/20 { background-color: #d1e7dd !important; border-color: #badbcc !important; }
            .text-green-400 { color: #0f5132 !important; }
            .border-green-500 { border-color: #0f5132 !important; }

            /* Merah */
            .bg-red-500\\/20 { background-color: #f8d7da !important; border-color: #f5c6cb !important; }
            .text-red-400 { color: #842029 !important; }
            .border-red-500 { border-color: #842029 !important; }

            /* Kuning (NEW) */
            .bg-yellow-500\\/20 { background-color: #fff3cd !important; border-color: #ffecb5 !important; }
            .text-yellow-400 { color: #664d03 !important; }
            .border-yellow-500 { border-color: #664d03 !important; }
            .text-yellow-300 { color: #000 !important; background: #fff3cd; padding: 2px 5px; border-radius: 4px; border: 1px solid #ffe69c; }

            /* Biru (NEW) */
            .bg-blue-500\\/20 { background-color: #cff4fc !important; border-color: #b6effb !important; }
            .text-blue-300 { color: #055160 !important; }
            .border-blue-500 { border-color: #055160 !important; }

            /* Reset elemen neon */
            .text-white { color: #000 !important; }
            .bg-black\\/40, .bg-black\\/20 { background: none !important; }
            .border-white\\/20, .border-white\\/10 { border: none !important; }
            
            .signature-container { margin-top: 50px; display: flex; justify-content: space-between; page-break-inside: avoid; }
            .signature-block { width: 40%; text-align: center; }
            .signature-block .name { font-weight: bold; text-decoration: underline; }
        </style>
    `);
    
    printWindow.document.write('</head><body>');
    
    // Kop Surat
    printWindow.document.write(`
        <div class="kop-surat">
            <img src="https://raw.githubusercontent.com/xiroro-ab/smp58dataguru/refs/heads/main/Logo_Palembang.png" alt="Logo Kiri" class="logo">
            <div class="teks-kop">
                <h3>PEMERINTAH KOTA PALEMBANG</h3>
                <h3>DINAS PENDIDIKAN</h3>
                <h3 style="font-size: 1.2em; font-weight: bold;">SMP NEGERI 58 PALEMBANG</h3>
                <p style="font-size: 0.9em;">Jl. Komering II, Kel. Demang Lebar Daun, Kec. Ilir Barat I, Kota Palembang 30137</p>
                <p style="font-size: 0.9em;">Email: palembangsmpn58@gmail.com</p>
            </div>
            <img src="https://raw.githubusercontent.com/xiroro-ab/smp58dataguru/refs/heads/main/logo58.png" alt="Logo Kanan" class="logo">
        </div>
    `);

    const kelas = state.resultClassFilter === 'all' ? 'Semua Kelas' : state.resultClassFilter;
    printWindow.document.write(`<h1>BERKAS HASIL UJIAN SISWA</h1>`);
    printWindow.document.write(`<h2>Mata Pelajaran: ${state.currentSubject.name}</h2>`);
    printWindow.document.write(`<p style="text-align: center;"><strong>Kelas:</strong> ${kelas}</p>`);
    printWindow.document.write(`<p style="text-align: center;"><strong>Tanggal Cetak:</strong> ${new Date().toLocaleDateString('id-ID')}</p>`);
    
    for (let i = 0; i < filteredResults.length; i++) {
        const result = filteredResults[i];
        if (i > 0) printWindow.document.write('<div class="page-break"></div>');

        const studentHtml = generateStudentDossierHtml(result, questionsMap, scoringRules);
        printWindow.document.write(`<h3 class="student-header">Nama Siswa: ${result.studentName} (Skor: ${parseFloat(result.score).toFixed(1)})</h3>`);
        printWindow.document.write(studentHtml);
    }

    const tanggalCetak = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    printWindow.document.write(`
        <div class="signature-container">
            <div class="signature-block">
                <p>Mengetahui,</p>
                <p>Kepala SMPN 58 Palembang</p>
                <br><br><br><br><br>
                <p class="name">Maya Erniwaty Manalu, S.Pd.</p>
                <p>NIP. 196803151992032011</p>
            </div>
            <div class="signature-block">
                <p>Palembang, ${tanggalCetak}</p>
                <p>Guru Mata Pelajaran</p>
                <br><br><br><br><br>
                <p class="name">Aris Bermansyah, S.Kom</p>
                <p>NIPPPK. 199611142024211010</p>
            </div>
        </div>
    `);

    printWindow.document.write('</body></html>');
    printWindow.document.close();
    hideLoader();
    
    setTimeout(function () { 
        printWindow.focus();
        printWindow.print();
    }, 1000);
}

// TEMPELKAN DUA FUNGSI BARU INI DI SCRIPT ANDA

/**
 * FUNGSI 1: Membuat "Spreadsheet" Koreksi Esai
 */
/**
 * FUNGSI 1: Membuat "Spreadsheet" Koreksi Esai
 * (VERSI BARU DENGAN FILTER KELAS & PERBAIKAN DATA 'ANSWERS' YANG HILANG)
 */
function renderEssayGradingTab() {
    const subjectContent = $('#subject-content');
    
    // 1. Dapatkan hanya soal esai (Sama seperti sebelumnya)
    const essayQuestions = state.questions
        .filter(q => q.type === 'Esai')
        .sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));

    if (essayQuestions.length === 0) {
        subjectContent.innerHTML = '<p class="text-center text-gray-400">Tidak ada soal Esai untuk mata pelajaran ini.</p>';
        return;
    }

    // Dapatkan data mapel untuk aturan skor (Sama seperti sebelumnya)
    const scoringRules = JSON.parse(state.currentSubject.scoringRules || '{}');
    const getPointValueForType = (type) => parseFloat(scoringRules[type] || 1);

    // --- (INI LOGIKA BARU) ---
    // 1. Ambil semua kelas dan siapkan data filter
    const classes = ['all', ...new Set(state.results.map(r => r.class.toString().trim()))].sort();
    const filteredResults = state.resultClassFilter === 'all'
        ? state.results
        : state.results.filter(r => r.class.toString().trim() === state.resultClassFilter);
    // --- (AKHIR LOGIKA BARU) ---

    // 2. Buat Header Tabel
    let tableHtml = `
        
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
            <div>
                <label for="grading-class-filter" class="mr-2">Filter Kelas:</label>
                <select id="grading-class-filter" class="neon-glow-input rounded-md px-2 py-1">
                    ${classes.map(c => `<option value="${c}" ${state.resultClassFilter === c ? 'selected' : ''}>${c === 'all' ? 'Semua Kelas' : c}</option>`).join('')}
                </select>
            </div>
        </div>
        <p class="text-sm text-gray-400 mb-4">Halaman ini memungkinkan Anda menilai semua esai siswa dalam satu tempat. Klik "Simpan" di setiap baris untuk menyimpan nilai siswa tersebut.</p>
        <div class="overflow-x-auto">
        <table class="w-full text-left min-w-[800px]">
            <thead>
                <tr class="border-b border-fuchsia-500/50">
                    <th class="p-2">Nama Siswa</th>
                    <th class="p-2 w-24">Skor Saat Ini</th>
    `;
    // Tambahkan kolom untuk setiap soal esai (Sama seperti sebelumnya)
    essayQuestions.forEach((q, index) => {
        tableHtml += `<th class="p-2 min-w-[300px]">Esai #${index + 1} (Maks. ${getPointValueForType(q.type)} Poin)</th>`;
    });
    tableHtml += `<th class="p-2 w-24">Aksi</th></tr></thead><tbody>`;

    // 3. Buat Baris Tabel untuk setiap siswa
    // --- (INI PERUBAHAN LOGIKA) ---
    // Kita ganti 'state.results' menjadi 'filteredResults'
    filteredResults.forEach(result => {
    // --- (AKHIR PERUBAHAN LOGIKA) ---

        tableHtml += `<tr class="border-b border-fuchsia-500/20 hover:bg-fuchsia-500/10">`;
        
        // Kolom Nama & Skor
        tableHtml += `<td class="p-2 align-top">${result.studentName}</td>`;
        tableHtml += `<td class="p-2 align-top font-bold text-center" id="score-cell-${result.id}">${parseFloat(result.score).toFixed(1)}</td>`;

        // Loop lagi untuk setiap soal esai untuk siswa ini
        essayQuestions.forEach(q => {
            
            // Perbaikan data 'answers' yang hilang (Sudah ada)
            const safeAnswers = Array.isArray(result.answers) ? result.answers : [];
            const studentAnswerObj = safeAnswers.find(ans => ans.questionId === q.id);

            const studentAnswerText = (studentAnswerObj && studentAnswerObj.answer) ? studentAnswerObj.answer : '<i class="text-gray-500">(Tidak Dijawab)</i>';
            const currentScore = (result.essayScores && result.essayScores[q.id]) ? result.essayScores[q.id] : '';

            tableHtml += `
                <td class="p-2 align-top">
                    <p class="text-xs text-gray-400 whitespace-pre-wrap">${q.text.replace(/<br>/g, "\n").substring(0, 100)}...</p>
                    <p class="font-bold text-fuchsia-300 my-2 whitespace-pre-wrap">${studentAnswerText}</p>
                    <input 
                        type="number"
                        class="neon-glow-input w-full p-2 rounded-lg text-sm essay-grade-input"
                        placeholder="Poin"
                        value="${currentScore}"
                        min="0"
                        max="${getPointValueForType(q.type)}"
                        data-result-id="${result.id}"
                        data-question-id="${q.id}"
                    >
                </td>
            `;
        });

        // Kolom Tombol Simpan
        tableHtml += `
            <td class="p-2 align-top text-center">
                <button 
                    onclick="handleSaveStudentGrades('${result.id}')"
                    class="neon-glow-button font-bold py-2 px-4 rounded-lg text-sm"
                    id="save-btn-${result.id}"
                >
                    Simpan
                </button>
            </td>
        </tr>`;
    });

    tableHtml += `</tbody></table></div>`;
    subjectContent.innerHTML = tableHtml;

    // --- (INI LISTENER BARU) ---
    // 4. Tambahkan event listener untuk dropdown filter yang baru
    $('#grading-class-filter').addEventListener('change', (e) => {
        state.resultClassFilter = e.target.value;
        renderEssayGradingTab(); // Panggil fungsi ini lagi untuk me-render ulang
    });
    // --- (AKHIR LISTENER BARU) ---
}


/**
 * FUNGSI 2: Menyimpan nilai untuk SATU BARIS SISWA
 * (VERSI BARU - PERBAIKAN BUG SKOR HILANG)
 */
/**
 * FUNGSI 2: Menyimpan nilai untuk SATU BARIS SISWA
 * (VERSI FINAL - MEMPERBAIKI BUG SKOR BESAR, SKOR HILANG, & INVALID DATE)
 */
async function handleSaveStudentGrades(resultId) {
    const saveButton = $(`#save-btn-${resultId}`);
    saveButton.textContent = '...';
    saveButton.disabled = true;

    try {
        // --- BAGIAN 1: KUMPULKAN SKOR (Perbaikan Bug "Skor Hilang") ---
        
        const allInputs = $$(`.essay-grade-input[data-result-id="${resultId}"]`);
        // 'scoresToUpdate' HANYA akan berisi nilai yang Anda KETIK.
        // Input yang kosong akan diabaikan, tidak akan menimpa data lama dengan '0'.
        const scoresToUpdate = {}; 
        let hasInvalidInput = false;
        let errorMessage = '';

        const scoringRules = JSON.parse(state.currentSubject.scoringRules || '{}');
        const getPointValueForType = (type) => parseFloat(scoringRules[type] || 1);

        allInputs.forEach(input => {
            const qId = input.dataset.questionId;
            const maxPoints = parseFloat(input.max);
            const valueStr = input.value.trim();

            // HANYA proses input jika TIDAK KOSONG
            if (valueStr !== '') {
                const points = parseFloat(valueStr);
                
                if (isNaN(points)) {
                    hasInvalidInput = true;
                    errorMessage = 'Satu atau lebih nilai esai bukan angka yang valid.';
                } else if (points > maxPoints) {
                    hasInvalidInput = true;
                    errorMessage = `Nilai tidak boleh lebih besar dari Poin Maks (Maks. ${maxPoints}).`;
                } else if (points < 0) {
                    hasInvalidInput = true;
                    errorMessage = 'Nilai tidak boleh negatif.';
                } else {
                    // Hanya tambahkan skor yang valid ke daftar update
                    scoresToUpdate[qId] = points;
                }
            }
        });

        if (hasInvalidInput) {
            throw new Error(errorMessage);
        }
        
        if (Object.keys(scoresToUpdate).length === 0) {
             showNotification('Info', `Tidak ada nilai baru yang disimpan.`, 'info');
             saveButton.textContent = 'Simpan';
             saveButton.disabled = false;
             return; // Keluar jika tidak ada yang perlu di-update
        }

        // --- BAGIAN 2: HITUNG SKOR (Perbaikan Bug "Skor Besar") ---
        
        const result = state.results.find(r => r.id === resultId);
        if (!result) throw new Error("Data hasil tidak ditemukan di 'state'.");

        // Buat objek skor esai baru dengan MENGGABUNGKAN skor lama + skor baru
        const newEssayScores = { ...(result.essayScores || {}), ...scoresToUpdate };

        const allQuestions = state.questions; // Ambil SEMUA soal dari 'state'
        
        let totalPossiblePoints = 0; // Poin maksimal total
        let studentTotalPoints = 0; // Poin total siswa

        // --- INI PERBAIKANNYA ---
        // Kita loop SEMUA SOAL (allQuestions), bukan hanya jawaban siswa,
        // untuk mendapatkan 'totalPossiblePoints' yang benar.
        allQuestions.forEach(q => {
            const questionType = q.type;
            totalPossiblePoints += getPointValueForType(questionType);

            if (questionType === 'Esai') {
                // Ambil skor esai dari data gabungan baru
                const manualPoints = newEssayScores[q.id] || 0;
                studentTotalPoints += Math.min(manualPoints, getPointValueForType(questionType));
            } else {
                // Ini soal non-esai, cari jawaban siswa
                const userAnswerObj = (result.answers || []).find(a => a.questionId === q.id);
                if (userAnswerObj && userAnswerObj.answer !== null) {
                    // Siswa menjawab, hitung skornya
                    const pointValue = calculateAutoScoreForQuestion(q, userAnswerObj.answer, getPointValueForType);
                    studentTotalPoints += pointValue;
                }
                // Jika siswa tidak menjawab (dapat 0), kita tidak menambah apa-apa,
                // tapi 'totalPossiblePoints' tetap bertambah (ini sudah benar).
            }
        });
        // --- AKHIR PERBAIKAN ---

        const finalScore = (totalPossiblePoints > 0) ? (studentTotalPoints / totalPossiblePoints) * 100 : 0;

        // --- BAGIAN 3: SIMPAN (Perbaikan Bug "Invalid Date") ---
        
        // Kita HANYA meng-update 2 field ini.
        // Kita tidak menyentuh 'timestamp' yang sudah ada di database.
        const dataToUpdate = {
            score: finalScore,
            essayScores: newEssayScores
        };

        // .update() lebih aman daripada .set() karena tidak menimpa data lain
        await db.ref(`/results/${resultId}`).update(dataToUpdate);

        // --- BAGIAN 4: UPDATE UI (Lokal) ---
        $(`#score-cell-${resultId}`).textContent = finalScore.toFixed(1);
        
        // Update 'state' lokal agar UI konsisten
        result.score = finalScore;
        result.essayScores = newEssayScores;
        // 'result.timestamp' (yang formatnya '13/11/2025...') tidak diubah
        // sehingga saat di-render ulang, tidak akan 'Invalid Date'.
        
        showNotification('Sukses', `Nilai siswa berhasil disimpan.`, 'success');

    } catch (error) {
        console.error("Gagal simpan nilai esai:", error);
        showNotification('Error', `Gagal menyimpan: ${error.message}`, 'error');
    } finally {
        saveButton.textContent = 'Simpan';
        saveButton.disabled = false;
    }
}

/**
 * FUNGSI 3: "Mesin Hitung Skor"
 * (VERSI BARU DENGAN POIN PENGURANGAN YANG ADIL)
 */
function calculateAutoScoreForQuestion(question, userAnswer, getPointValueForType) {
    const correctAnswer = question.answer;
    let points = 0;
    try {
        switch (question.type) {
            case 'Pilihan Ganda':
            case 'Benar/Salah':
                if (userAnswer != null && correctAnswer != null) {
                    if (userAnswer.toString().toLowerCase().trim() === correctAnswer.toString().toLowerCase().trim()) {
                        points = getPointValueForType(question.type);
                    }
                }
                break;
            case 'Isian Singkat':
                if (userAnswer != null && Array.isArray(correctAnswer) && correctAnswer.length > 0) {
                    const userAnsLower = userAnswer.toString().toLowerCase().trim();
                    const correctAnswersLower = correctAnswer.map(ans => ans.toString().toLowerCase().trim());
                    if (correctAnswersLower.includes(userAnsLower)) {
                        points = getPointValueForType(question.type);
                    }
                } else if (userAnswer != null && typeof correctAnswer === 'string') {
                    if (userAnswer.toString().toLowerCase().trim() === correctAnswer.toString().toLowerCase().trim()) {
                         points = getPointValueForType(question.type);
                    }
                }
                break;

            // --- INI PERBAIKANNYA ---
            case 'Pilihan Ganda Kompleks':
                if (Array.isArray(userAnswer) && Array.isArray(correctAnswer) && correctAnswer.length > 0) {
                    const correctSet = new Set(correctAnswer); // Jawaban benar (misal: {A, B, C})
                    const totalCorrectAnswers = correctSet.size; // Total yg seharusnya (misal: 3)
                    const fullPoints = getPointValueForType(question.type); // Bobot (misal: 3)
                    
                    // Tentukan nilai per item
                    const pointsPerCorrect = fullPoints / totalCorrectAnswers; // (misal: 3 / 3 = 1 poin)
                    const pointsPerIncorrect = pointsPerCorrect; // Penalti (misal: -1 poin)

                    let currentScore = 0;

                    // Loop jawaban siswa
                    for (const ans of userAnswer) {
                        if (correctSet.has(ans)) {
                            // Jawaban benar
                            currentScore += pointsPerCorrect; // (misal: +1)
                        } else {
                            // Jawaban salah
                            currentScore -= pointsPerIncorrect; // (misal: -1)
                        }
                    }
                    
                    // Pastikan skor tidak negatif
                    if (currentScore < 0) {
                        currentScore = 0;
                    }
                    points = currentScore;
                }
                break;
            // --- AKHIR PERBAIKAN ---

            case 'Menjodohkan':
                if (Array.isArray(userAnswer) && Array.isArray(question.options) && question.options.length > 0) {
                    let correctPairs = 0;
                    userAnswer.forEach(ans => {
                        const qIndex = ans.questionItem.charCodeAt(0) - 65;
                        if (question.options[qIndex] && question.options[qIndex].a.text === ans.answerItem) {
                            correctPairs++;
                        }
                    });
                    points = (correctPairs / question.options.length) * getPointValueForType(question.type);
                }
                break;
        }
    } catch (e) {
        console.error(`Error calculating auto-score for Q_ID ${question.id}: ${e.message}`);
    }
    return points;
}

/**
 * FUNGSI HELPER UNTUK MENGACAK ARRAY (Fisher-Yates Shuffle)
 * Ini diperlukan oleh 'handleSiswaLogin'
 */
function shuffleArray(array) {
  let currentIndex = array.length,  randomIndex;

  // Selama masih ada elemen untuk diacak
  while (currentIndex != 0) {

    // Ambil elemen yang tersisa
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;

    // Dan tukar dengan elemen saat ini
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }

  return array;
}

/**
 * =================================================================
 * FUNGSI HELPER BARU (DIPINDAH DARI CODE.GS)
 * =================================================================
 */

/**
 * FUNGSI 1: Membuat ID unik di sisi Frontend
 */
function generateUniqueId() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

/**
 * FUNGSI 2: Mengacak Array (Fisher-Yates Shuffle)
 */
function shuffleArray(array) {
  let currentIndex = array.length,  randomIndex;
  while (currentIndex != 0) {
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }
  return array;
}

/**
 * FUNGSI 3: "Mesin Hitung Skor" (dari code.gs)
 */
function calculateAutoScoreForQuestion(question, userAnswer, getPointValueForType) {
    const correctAnswer = question.answer;
    let points = 0;
    try {
        switch (question.type) {
            case 'Pilihan Ganda':
            case 'Benar/Salah':
                if (userAnswer != null && correctAnswer != null) {
                    if (userAnswer.toString().toLowerCase().trim() === correctAnswer.toString().toLowerCase().trim()) {
                        points = getPointValueForType(question.type);
                    }
                }
                break;
            case 'Isian Singkat':
                if (userAnswer != null && Array.isArray(correctAnswer) && correctAnswer.length > 0) {
                    const userAnsLower = userAnswer.toString().toLowerCase().trim();
                    const correctAnswersLower = correctAnswer.map(ans => ans.toString().toLowerCase().trim());
                    if (correctAnswersLower.includes(userAnsLower)) {
                        points = getPointValueForType(question.type);
                    }
                } else if (userAnswer != null && typeof correctAnswer === 'string') {
                    if (userAnswer.toString().toLowerCase().trim() === correctAnswer.toString().toLowerCase().trim()) {
                         points = getPointValueForType(question.type);
                    }
                }
                break;
            case 'Pilihan Ganda Kompleks':
                if (Array.isArray(userAnswer) && Array.isArray(correctAnswer) && correctAnswer.length > 0) {
                    const correctSet = new Set(correctAnswer);
                    const userSet = new Set(userAnswer);
                    const isCorrect = correctSet.size === userSet.size && [...correctSet].every(item => userSet.has(item));
                    if (isCorrect) {
                         points = getPointValueForType(question.type);
                    }
                }
                break;
            case 'Menjodohkan':
                if (Array.isArray(userAnswer) && Array.isArray(question.options) && question.options.length > 0) {
                    let correctPairs = 0;
                    userAnswer.forEach(ans => {
                        const qIndex = ans.questionItem.charCodeAt(0) - 65;
                        if (question.options[qIndex] && question.options[qIndex].a.text === ans.answerItem) {
                            correctPairs++;
                        }
                    });
                    points = (correctPairs / question.options.length) * getPointValueForType(question.type);
                }
                break;
        }
    } catch (e) {
        console.error(`Error calculating auto-score for Q_ID ${question.id}: ${e.message}`);
    }
    return points;
}

// ----------------------------------------------------------------
// --- FUNGSI BARU: LIVE MONITORING (TEMPEL INI DI KODE ANDA) ---
// ----------------------------------------------------------------

/**
 * FUNGSI 1: Merender kerangka tabel dan memulai listener Firebase
 */
function renderMonitoringTab() {
    $('#subject-content').innerHTML = `
        <div class="mb-4">
            <h3 class="text-xl font-bold mb-2 text-yellow-300">Monitoring Ujian Live</h3>
            <p class="text-sm text-gray-400">Menampilkan siswa yang sedang aktif ujian untuk mata pelajaran ini. Data diperbarui secara realtime.</p>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                    <tr class="border-b border-fuchsia-500/50">
                        <th class="p-2">Nama Siswa</th>
                        <th class="p-2">Kelas</th>
                        <th class="p-2">Status</th>
                        <th class="p-2">Progres</th>
                        <th class="p-2">Sisa Waktu</th>
                        <th class="p-2">Pelanggaran</th>
                        <th class="p-2">Skor (Auto)</th>
                        <th class="p-2">Aksi</th>
                    </tr>
                </thead>
                <tbody id="monitoring-table-body">
                    <tr id="monitoring-empty-row"><td colspan="7" class="p-4 text-center text-gray-500">Menunggu data sesi live...</td></tr>
                </tbody>
            </table>
        </div>
    `;

    const subjectId = state.currentSubject.id;
    const sessionsRef = db.ref('/examSessions').orderByChild('subjectId').equalTo(subjectId);

    // Simpan referensi untuk 'switchSubjectTab'
    state.liveMonitorListener = sessionsRef;

    // 1. Saat siswa BARU MASUK
    sessionsRef.on('child_added', (snapshot) => {
        const session = snapshot.val();
        // Hitung skornya dulu
        const liveScore = calculateGuruLiveScore(session.answers);
        // Baru render barisnya
        renderMonitoringRow(session, liveScore); 
    });

    // 2. Saat data siswa BERUBAH
    sessionsRef.on('child_changed', (snapshot) => {
        const session = snapshot.val();
        // Hitung ulang skornya dengan data terbaru
        const liveScore = calculateGuruLiveScore(session.answers);
        // Render ulang barisnya
        renderMonitoringRow(session, liveScore);
    });

    // 3. Saat siswa SELESAI UJIAN
    sessionsRef.on('child_removed', (snapshot) => {
        const session = snapshot.val();
        const rowId = `session-row-${session.studentId}`;
        const row = $(`#${rowId}`);
        if (row) {
            row.remove(); // Hapus baris siswa dari tabel
        }
        
        const tableBody = $('#monitoring-table-body');
        if (tableBody && tableBody.children.length === 0) {
            tableBody.innerHTML = `<tr id="monitoring-empty-row"><td colspan="7" class="p-4 text-center text-gray-500">Tidak ada siswa yang sedang ujian.</td></tr>`;
        }
    });
}

/**
 * FUNGSI 2: Mengisi body tabel dengan data live
 */
/**
 * Helper baru yang efisien: Membuat atau Memperbarui 1 baris siswa
 */
function renderMonitoringRow(session, liveScore) {
    const tableBody = $('#monitoring-table-body');
    if (!tableBody) return; 

    const emptyRow = $('#monitoring-empty-row');
    if (emptyRow) emptyRow.remove();

    // 1. Hitung Waktu
    const s = session.remainingSeconds || 0;
    const m = Math.floor((s % 3600) / 60).toString().padStart(2, '0');
    const sec = (s % 60).toString().padStart(2, '0');
    const sisaWaktu = `${m}:${sec}`;

    // 2. Logika Status & Icon
    let statusIcon = '';
    let rowClass = 'border-b border-fuchsia-500/10 hover:bg-fuchsia-500/5 transition-colors';
    
    // Cek apakah statusnya Diskualifikasi
    const isDisqualified = session.status === 'DISQUALIFIED';

    if (isDisqualified) {
        statusIcon = `<div class="tooltip" title="DISKUALIFIKASI"><i class="fas fa-times-circle text-2xl text-red-500 filter drop-shadow-[0_0_5px_rgba(239,68,68,0.8)] animate-pulse"></i></div>`;
        rowClass += ' bg-red-900/20'; 
    } else if (!session.isFocus) {
        statusIcon = `<div class="tooltip" title="DI LUAR FOKUS"><i class="fas fa-exclamation-triangle text-xl text-yellow-500"></i></div>`;
        rowClass += ' bg-yellow-900/10';
    } else {
        statusIcon = `<div class="tooltip" title="MENGERJAKAN"><i class="fas fa-check-circle text-xl text-green-500"></i></div>`;
    }

    // 3. Circular Progress Bar
    const total = session.totalQuestions || 1;
    const current = session.progress || 0;
    const percentage = Math.min(100, Math.max(0, (current / total) * 100));
    const radius = 16;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (percentage / 100) * circumference;
    const strokeColor = percentage === 100 ? '#22c55e' : '#c026d3'; 

    const circularProgressHtml = `
        <div class="relative w-10 h-10 flex items-center justify-center">
            <svg class="w-full h-full transform -rotate-90" viewBox="0 0 40 40">
                <circle cx="20" cy="20" r="${radius}" fill="transparent" stroke="#374151" stroke-width="4"></circle>
                <circle cx="20" cy="20" r="${radius}" fill="transparent" stroke="${strokeColor}" stroke-width="4"
                        stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" stroke-linecap="round"
                        class="transition-all duration-500 ease-out"></circle>
            </svg>
            <span class="absolute text-[10px] font-bold text-gray-300">${Math.round(percentage)}%</span>
        </div>
    `;

    // --- [LOGIKA TOMBOL RESET DINAMIS] ---
    let resetBtnHtml = '';
    
    if (isDisqualified) {
        // JIKA DISKUALIFIKASI: Tombol Biru Aktif
        resetBtnHtml = `
            <button onclick="handleResetViolation('${session.studentId}', '${session.subjectId}')" 
                    class="w-8 h-8 rounded-full bg-blue-600/20 text-blue-400 border border-blue-500/50 hover:bg-blue-600 hover:text-white hover:shadow-[0_0_10px_rgba(37,99,235,0.6)] transition-all flex items-center justify-center" 
                    title="Reset Pelanggaran (Buka Kunci)">
                <i class="fas fa-undo text-xs"></i>
            </button>`;
    } else {
        // JIKA MASIH MENGERJAKAN: Tombol Abu-abu Mati (Disabled)
        resetBtnHtml = `
            <button disabled 
                    class="w-8 h-8 rounded-full bg-gray-800 text-gray-600 border border-gray-700 cursor-not-allowed opacity-50 flex items-center justify-center" 
                    title="Reset hanya aktif jika siswa diskualifikasi">
                <i class="fas fa-undo text-xs"></i>
            </button>`;
    }
    // -------------------------------------

    const actionBtns = `
        <div class="flex gap-3 justify-center items-center">
            ${resetBtnHtml} <button onclick="handleForceFinish('${session.studentId}', '${session.subjectId}')" 
                    class="w-8 h-8 rounded-full bg-red-600/20 text-red-400 border border-red-500/50 hover:bg-red-600 hover:text-white hover:shadow-[0_0_10px_rgba(220,38,38,0.6)] transition-all flex items-center justify-center" 
                    title="Simpan & Selesaikan">
                <i class="fas fa-save text-xs"></i>
            </button>
        </div>
    `;

    const rowId = `session-row-${session.studentId}`;
    const rowHtml = `
        <td class="p-3 font-semibold text-sm">${session.studentName}</td>
        <td class="p-3 text-sm">${session.class}</td>
        <td class="p-3 text-center">${statusIcon}</td>
        <td class="p-3 flex justify-center">${circularProgressHtml}</td> 
        <td class="p-3 font-mono text-sm text-center">${sisaWaktu}</td>
        <td class="p-3 text-center">
            <span class="font-bold ${session.cheatAttempts > 0 ? 'text-red-400' : 'text-gray-500'} text-lg">
                ${session.cheatAttempts}
            </span>
        </td>
        <td class="p-3 text-center text-sm font-bold">${liveScore.toFixed(0)}</td>
        <td class="p-3 text-center">${actionBtns}</td>
    `;

    let row = $(`#${rowId}`);
    if (row) {
        row.innerHTML = rowHtml;
        row.className = rowClass;
    } else {
        row = document.createElement('tr');
        row.id = rowId;
        row.className = rowClass;
        row.innerHTML = rowHtml;
        tableBody.appendChild(row);
    }
}


/**
 * FUNGSI 3: "Otak" Guru untuk menghitung skor live dari data jawaban siswa
 */
function calculateGuruLiveScore(studentAnswers) {
    if (!studentAnswers || studentAnswers.length === 0) return 0;
    
    // Gunakan 'state' guru yang sudah terisi
    const allQuestions = state.questions; // Ini punya kunci jawaban
    const scoringRules = JSON.parse(state.currentSubject.scoringRules || '{}');
    const getPointValueForType = (type) => parseFloat(scoringRules[type] || 1);

    let totalPossibleAutoPoints = 0;
    let studentTotalPoints = 0;
    let hasAutoScoredQuestions = false;

    // Kita harus mem-build total poin HANYA dari soal non-esai
    allQuestions.forEach(q => {
        if (q.type !== 'Esai') {
            totalPossibleAutoPoints += getPointValueForType(q.type);
            hasAutoScoredQuestions = true;
        }
    });

    if (!hasAutoScoredQuestions) return 0; // Tidak ada soal non-esai

    // Loop jawaban siswa
    studentAnswers.forEach(ans => {
        if (ans.answer === null) return; // Belum dijawab

        const q = allQuestions.find(q => q.id === ans.questionId);
        
        // Hitung poin HANYA jika itu soal non-esai
        if (q && q.type !== 'Esai') {
            // Gunakan fungsi kalkulator skor yang SAMA dengan yang dipakai di tab Koreksi
            const pointValue = calculateAutoScoreForQuestion(q, ans.answer, getPointValueForType);
            studentTotalPoints += pointValue;
        }
    });
    
    // Hitung skor akhir
    const finalScore = (totalPossibleAutoPoints > 0) ? (studentTotalPoints / totalPossibleAutoPoints) * 100 : 0;
    return finalScore;
}

async function handleForceFinish(studentId, subjectId) {
    // 1. Definisikan logika yang akan dijalankan JIKA guru klik "YA"
    const executeForceFinish = async () => {
        // Tutup modal konfirmasi dulu
        hideModal(); 
        
        showLoader();
        try {
            // A. Ambil data sesi LIVE dari Firebase
            const sessionRef = db.ref(`/examSessions/${studentId}_${subjectId}`);
            const snapshot = await sessionRef.once('value');
            const session = snapshot.val();

            // Cek: Apakah sesi masih ada?
            // Jika siswa sudah selesai duluan, session akan null.
            if (!session) {
                throw new Error("Sesi siswa tidak ditemukan. Kemungkinan siswa baru saja menyelesaikan ujian secara mandiri.");
            }

            // B. Siapkan Payload
            // Kita gunakan token "FORCE_SUBMIT" sebagai tanda ini aksi guru
            const payload = {
                studentId: session.studentId,
                subjectId: session.subjectId,
                token: "FORCE_SUBMIT", 
                answers: session.answers || [],
                cheatAttempts: session.cheatAttempts || 0,
                startTime: session.startTime
            };

            // C. Kirim ke Backend (Simpan ke Results)
            const res = await apiCall('saveResult', payload);

            if (res.success) {
                // D. HAPUS sesi live (Pemicu siswa tertendang)
                await sessionRef.remove();
                
                showNotification('Sukses', `Ujian siswa ${session.studentName} berhasil diselesaikan paksa.`, 'success');
            } else {
                throw new Error(res.message);
            }

        } catch (error) {
            console.error("Gagal Force Finish:", error);
            // Tampilkan error dengan notifikasi cantik, bukan alert
            showNotification('Gagal Menyimpan', error.message, 'error');
        } finally {
            hideLoader();
        }
    };

    // 2. Siapkan Tampilan Modal Konfirmasi
    // Kita gunakan HTML string untuk membuat tampilan peringatan yang jelas
    const confirmationHtml = `
        <div class="text-center">
            <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4 animate-pulse"></i>
            <h3 class="text-xl font-bold mb-2 text-white">Konfirmasi Paksa Selesai</h3>
            <p class="text-gray-300 mb-4">
                Apakah Anda yakin ingin menghentikan ujian siswa ini secara paksa?
            </p>
            <div class="bg-red-900/30 border border-red-500/50 p-3 rounded-lg text-sm text-left mx-auto max-w-sm">
                <ul class="list-disc list-inside text-red-200 space-y-1">
                    <li>Jawaban terakhir yang terekam akan disimpan sebagai Nilai Akhir.</li>
                    <li>Siswa akan <strong>dikeluarkan otomatis</strong> dari halaman ujian.</li>
                    <li>Aksi ini tidak dapat dibatalkan.</li>
                </ul>
            </div>
        </div>
    `;

    // 3. Tampilkan Modal
    // Parameter: (Judul, Isi HTML, Fungsi Callback saat tombol Simpan diklik, Config Tombol)
    showModal(
        'Peringatan Keras', 
        confirmationHtml, 
        executeForceFinish, 
        { 
            actionText: 'Ya, Paksa Selesai', // Ganti teks tombol default "Simpan"
            // Opsional: Tambahkan styling khusus jika fungsi showModal Anda mendukungnya
        }
    );
    
    // Sedikit hack CSS (opsional) untuk membuat tombol aksi menjadi merah
    // agar guru sadar ini tombol berbahaya.
    setTimeout(() => {
        const actionBtn = document.getElementById('modal-action-btn');
        if (actionBtn) {
            actionBtn.classList.remove('neon-glow-button'); // Hapus style ungu
            actionBtn.classList.add('bg-red-600', 'hover:bg-red-500', 'text-white', 'font-bold', 'py-2', 'px-6', 'rounded-lg', 'shadow-[0_0_10px_rgba(220,38,38,0.5)]');
        }
    }, 50);
}

// Fungsi untuk memantau status sesi secara realtime
function monitorSessionStatus() {
    if (!state.currentExam) return;

    const { studentId, subjectId } = state.currentExam;
    const sessionRef = db.ref(`/examSessions/${studentId}_${subjectId}`);

    // Dengarkan perubahan data pada sesi ini
    sessionRef.on('value', (snapshot) => {
        const data = snapshot.val();

        // LOGIKA UTAMA:
        // Jika data menjadi null (dihapus) TAPI status lokal masih 'isDuringExam' (sedang ujian),
        // Berarti sesi dihapus paksa oleh orang lain (Guru/Server).
        if (data === null && isDuringExam) {
            handleForcedStop(); // Panggil fungsi penghentian paksa
            sessionRef.off(); // Matikan pendengar agar tidak loop
        }
    });
}

// Fungsi aksi ketika diberhentikan paksa
function handleForcedStop() {
    isDuringExam = false; // Matikan status ujian
    clearInterval(state.examTimer); // Matikan timer
    if (state.examHeartbeat) clearInterval(state.examHeartbeat);
    removeAntiCheatListeners(); // Matikan sensor anti-cheat
    clearExamStateFromLocalStorage(); // Hapus data di HP

    // Tampilkan Modal Peringatan yang Memblokir
    showModal(
        'Ujian Selesai',
        `<div class="text-center">
            <i class="fas fa-user-clock text-5xl text-yellow-400 mb-4"></i>
            <p class="text-lg">Ujian Anda telah diselesaikan dan disimpan oleh Pengawas.</p>
            <p class="text-sm text-gray-400 mt-2">Klik OK untuk kembali ke halaman utama.</p>
        </div>`,
        () => {
            // Aksi saat tombol OK/Simpan diklik
            navigateTo('page-landing');
            window.location.reload(); // Refresh agar bersih total
        },
        { 
            actionText: 'OK', 
            hideCancel: true // Sembunyikan tombol Batal agar siswa WAJIB klik OK
        }
    );
}

// Fungsi untuk membekukan layar siswa yang curang
// Agar data tetap ada di Monitoring Guru, dan Guru yang memutuskan nasibnya.
async function lockExam() {
    isDuringExam = false; 
    clearInterval(state.examTimer);
    if (state.examHeartbeat) clearInterval(state.examHeartbeat);
    removeAntiCheatListeners();
    
    // 1. Update status di Firebase agar Guru tahu siswa ini TERKUNCI (Disqualified)
    if (state.currentExam) {
        const { studentId, subjectId, cheatAttempts } = state.currentExam;
        const sessionRef = db.ref(`/examSessions/${studentId}_${subjectId}`);
        
        // Kita update statusnya jadi 'DISQUALIFIED'
        // Kita juga pastikan cheatAttempts terupdate
        await sessionRef.update({
            status: 'DISQUALIFIED',
            cheatAttempts: cheatAttempts,
            isFocus: false,
            lastUpdate: firebase.database.ServerValue.TIMESTAMP
        });
    }

    // 2. Tampilkan Layar Merah Mati (Tidak bisa ditutup)
    const bodyHtml = `
        <div class="text-center">
            <i class="fas fa-ban text-6xl text-red-500 mb-4 animate-pulse"></i>
            <h2 class="text-2xl font-bold text-red-400 mb-2">AKSES DIBLOKIR</h2>
            <p class="text-gray-300 mb-6">
                Anda telah melampaui batas pelanggaran. <br>
                Akses ujian Anda dikunci oleh sistem.
            </p>
            <div class="bg-red-900/30 p-4 rounded-lg text-sm text-left border border-red-500/30">
                <p class="font-bold text-red-200 mb-1">Status Anda:</p>
                <ul class="list-disc list-inside text-gray-400">
                    <li>Jawaban Anda tersimpan di server sementara.</li>
                    <li>Nama Anda ditandai <span class="text-red-400 font-bold">MERAH</span> di layar pengawas.</li>
                    <li>Tunggu pengawas melakukan <strong>"Simpan Paksa"</strong> untuk merekam nilai Anda.</li>
                </ul>
            </div>
            <p class="mt-8 text-xs text-gray-500">Jangan tutup halaman ini sampai Pengawas menginstruksikan.</p>
        </div>
    `;

    // Gunakan modal yang tidak bisa ditutup (hideCancel: true, tanpa callback)
    showModal('DISKUALIFIKASI', bodyHtml, () => {}, { 
        actionText: '', // Hilangkan tombol aksi
        hideAction: true,
        hideCancel: true 
    });
    
    // Hapus tombol X di modal agar benar-benar terkunci
    $('#modal-close-btn-x').style.display = 'none';
}

async function handleResetViolation(studentId, subjectId) {
    // 1. Definisikan Aksi Eksekusi
    const executeReset = async () => {
        hideModal(); 
        showLoader();
        try {
            const sessionRef = db.ref(`/examSessions/${studentId}_${subjectId}`);
            const snapshot = await sessionRef.once('value');
            
            if (!snapshot.exists()) {
                throw new Error("Sesi siswa tidak ditemukan (Mungkin sudah selesai).");
            }

            // Reset Data di Firebase
            await sessionRef.update({
                cheatAttempts: 0,       
                status: 'ongoing',      
                isFocus: true,          
                lastUpdate: firebase.database.ServerValue.TIMESTAMP
            });

            showNotification('Sukses', 'Pelanggaran siswa di-reset menjadi 0.', 'success');

        } catch (error) {
            console.error("Gagal Reset:", error);
            showNotification('Error', error.message, 'error');
        } finally {
            hideLoader();
        }
    };

    // 2. HTML Modal Kustom
    const confirmHtml = `
        <div class="text-center">
            <div class="w-16 h-16 rounded-full bg-blue-600/20 flex items-center justify-center mx-auto mb-4 border border-blue-500/50 shadow-[0_0_15px_rgba(37,99,235,0.3)]">
                <i class="fas fa-undo text-3xl text-blue-400"></i>
            </div>
            <h3 class="text-xl font-bold mb-2 text-white">Reset Pelanggaran?</h3>
            <p class="text-gray-300 text-sm mb-6">
                Status siswa akan dikembalikan menjadi <strong>Aman (0 Pelanggaran)</strong>.
                <br><br>
                <span class="text-yellow-400 text-xs border border-yellow-500/30 bg-yellow-900/20 px-2 py-1 rounded">
                    <i class="fas fa-info-circle mr-1"></i> Siswa perlu me-Refresh browser mereka setelah ini.
                </span>
            </p>
        </div>
    `;

    // 3. Tampilkan Modal
    showModal(
        'Konfirmasi Reset', 
        confirmHtml, 
        executeReset, // Callback fungsi di atas
        { actionText: 'Ya, Reset Sekarang' }
    );
    
    // Sedikit styling tombol aksi agar jadi Biru (Manual DOM manipulation)
    setTimeout(() => {
        const actionBtn = document.getElementById('modal-action-btn');
        if (actionBtn) {
            actionBtn.classList.remove('neon-glow-button');
            actionBtn.classList.add('bg-blue-600', 'hover:bg-blue-500', 'text-white', 'font-bold', 'py-2', 'px-6', 'rounded-lg', 'shadow-lg');
        }
    }, 50);
}

    </script>
</body>
</html>
